+ SRU_VARS=./sru-scripts/sru-vars.template
+ '[' '!' -f ./sru-scripts/sru-vars.template ']'
+ . ./sru-scripts/sru-vars.template
++ PRESERVE_INSTANCE=false
++ UBUNTU_RELEASE=
++ LP_USER=oddbloke
++ PROPOSED_SCRIPT=setup_proposed.sh
++ USE_DEV_PPA=0
++ ENI_NETCFG_FILE=/etc/network/interfaces.d/50-cloud-init.cfg
++ NETPLAN_NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
++ SAMPLE_CLOUDCONFIG=sethostname.yaml
++ SSH_KEY=/home/daniel/.ssh/id_rsa.pub
++ SSHOPTS=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR)
++ AZURE_REGION=UNSET
++ AZURE_VNET_NAME=UNSET
++ AZURE_NETWORK_SECURITY_GROUP=UNSET
++ AZURE_NIC_NAME=UNSET
++ AZURE_RESOURCE_GROUP=UNSET
++ AZURE_BOOT_DIAG=UNSET
++ AZURE_ADVANCED_NIC_TESTS=true
++ GCE_ZONE=UNSET
++ OPENSTACK_ADMIN_NET_ID=UNSET
++ OPENSTACK_SSH_KEY_NAME=UNSET
++ OCI_COMPARTMENT_ID=UNSET
++ SRU_VARS_RC=.sru-vars.rc
++ '[' -f .sru-vars.rc ']'
++ . ./.sru-vars.rc
+++ PRESERVE_INSTANCE=false
+++ UBUNTU_RELEASE=
+++ LP_USER=oddbloke
+++ PROPOSED_SCRIPT=setup_proposed.sh
+++ USE_DEV_PPA=0
+++ ENI_NETCFG_FILE=/etc/network/interfaces.d/50-cloud-init.cfg
+++ NETPLAN_NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
+++ SAMPLE_CLOUDCONFIG=sethostname.yaml
+++ SSH_KEY=/home/daniel/.ssh/id_rsa.canonical.pub
+++ SSHOPTS=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR)
+++ AZURE_REGION=northeurope
+++ AZURE_VNET_NAME=sruscripts
+++ AZURE_NETWORK_SECURITY_GROUP=sruscripts
+++ AZURE_NIC_NAME=sruscripts
+++ AZURE_RESOURCE_GROUP=xx16resourcegroup
+++ AZURE_BOOT_DIAG=sruscripts
+++ AZURE_ADVANCED_NIC_TESTS=true
+++ GCE_ZONE=UNSET
+++ OPENSTACK_ADMIN_NET_ID=UNSET
+++ OPENSTACK_SSH_KEY_NAME=UNSET
+ parse_args ./sru-scripts/manual/azure-sru groovy
+ script=./sru-scripts/manual/azure-sru
+ shift
+ '[' 1 = 0 ']'
+ '[' 1 -ne 0 ']'
+ case "$1" in
+ UBUNTU_RELEASE=groovy
+ NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
+ shift
+ '[' 0 -ne 0 ']'
+ '[' -z groovy ']'
+ assert_expected_vars PROPOSED_SCRIPT AZURE_REGION AZURE_VNET_NAME AZURE_NETWORK_SECURITY_GROUP AZURE_NIC_NAME AZURE_RESOURCE_GROUP AZURE_BOOT_DIAG SSH_KEY SAMPLE_CLOUDCONFIG AZURE_ADVANCED_NIC_TESTS
+ local value=
+ for var in $@
+ eval 'value=$PROPOSED_SCRIPT > /dev/null'
++ value=setup_proposed.sh
+ '[' -z setup_proposed.sh -o setup_proposed.sh = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_REGION > /dev/null'
++ value=northeurope
+ '[' -z northeurope -o northeurope = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_VNET_NAME > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_NETWORK_SECURITY_GROUP > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_NIC_NAME > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_RESOURCE_GROUP > /dev/null'
++ value=xx16resourcegroup
+ '[' -z xx16resourcegroup -o xx16resourcegroup = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_BOOT_DIAG > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$SSH_KEY > /dev/null'
++ value=/home/daniel/.ssh/id_rsa.canonical.pub
+ '[' -z /home/daniel/.ssh/id_rsa.canonical.pub -o /home/daniel/.ssh/id_rsa.canonical.pub = UNSET ']'
+ for var in $@
+ eval 'value=$SAMPLE_CLOUDCONFIG > /dev/null'
++ value=sethostname.yaml
+ '[' -z sethostname.yaml -o sethostname.yaml = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_ADVANCED_NIC_TESTS > /dev/null'
++ value=true
+ '[' -z true -o true = UNSET ']'
+ create_samplecloudconfig SAMPLE_CLOUDCONFIG
+ filename=SAMPLE_CLOUDCONFIG
+ cat
+ create_setup_proposed_script
+ '[' 0 -eq 0 ']'
+ cat
+ AZURE_VNET_NAME=sruscripts-groovy
++ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
++ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
++ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
++ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ '[' Registered '!=' Registered -o Registered '!=' Registered ']'
++ az provider show -n Microsoft.Network
++ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo 'Waiting for Microsoft.Network IPv6 feature registration'
Waiting for Microsoft.Network IPv6 feature registration
+ '[' Registered '!=' Registered ']'
+ echo '### BEGIN groovy'
### BEGIN groovy
+ az group show -g xx16resourcegroup
+ '[' -n sruscripts ']'
+ az storage account show --name sruscripts
+ AZURE_BOOT_DIAG_ARG='--boot-diagnostics-storage sruscripts'
+ az network nsg show --name sruscripts -g xx16resourcegroup
+ az network nsg rule show --name allowSSHIn --nsg-name sruscripts -g xx16resourcegroup
+ az network nsg rule show --name allowAllOut --nsg-name sruscripts -g xx16resourcegroup
+ az network vnet show --name sruscripts-groovy -g xx16resourcegroup
+ az network vnet subnet show --name sruSubnet --vnet-name sruscripts-groovy -g xx16resourcegroup
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ case $UBUNTU_RELEASE in
+ image_version=Canonical:0001-com-ubuntu-server-groovy-daily:20_10-daily
+ for nics in ""
+ '[' '' = '' ']'
+ echo 'Creating standard network vm'
Creating standard network vm
+ name=test-sru-groovy
+ az vm show --name test-sru-groovy -g xx16resourcegroup
+ az vm create --name=test-sru-groovy --image=Canonical:0001-com-ubuntu-server-groovy-daily:20_10-daily:latest --admin-username=root --admin-username=ubuntu -g xx16resourcegroup --ssh-key-value /home/daniel/.ssh/id_rsa.canonical.pub --boot-diagnostics-storage sruscripts --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Compute/virtualMachines/test-sru-groovy",
  "location": "northeurope",
  "macAddress": "00-22-48-9C-12-11",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.55",
  "publicIpAddress": "65.52.73.71",
  "resourceGroup": "xx16resourcegroup",
  "zones": ""
}
++ az vm list-ip-addresses --name test-sru-groovy
++ jq -r '.[] | .virtualMachine.network.publicIpAddresses[].ipAddress'
++ awk '{printf "ubuntu@%s", $1}'
+ IP=ubuntu@65.52.73.71
+ echo 'Created test-sru-groovy: ubuntu@ubuntu@65.52.73.71'
Created test-sru-groovy: ubuntu@ubuntu@65.52.73.71
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init status --wait --long

status: done
time: Mon, 05 Apr 2021 20:21:00 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- dpkg-query --show cloud-init
cloud-init	20.4.1-0ubuntu1~20.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- '!' grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- systemd-analyze
Startup finished in 2.682s (kernel) + 33.454s (userspace) = 36.137s 
graphical.target reached after 32.648s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- systemd-analyze blame
11.873s cloud-init.service                                   
 5.345s snapd.seeded.service                                 
 3.596s snapd.service                                        
 2.945s snapd.apparmor.service                               
 2.562s cloud-config.service                                 
 2.203s cloud-init-local.service                             
 2.003s lvm2-monitor.service                                 
 1.976s systemd-networkd-wait-online.service                 
 1.637s dev-sda1.device                                      
 1.624s pollinate.service                                    
 1.507s systemd-udev-settle.service                          
 1.264s accounts-daemon.service                              
 1.066s apparmor.service                                     
 1.043s snap.lxd.activate.service                            
  923ms networkd-dispatcher.service                          
  787ms cloud-final.service                                  
  702ms apport.service                                       
  631ms grub-common.service                                  
  521ms systemd-logind.service                               
  404ms chrony.service                                       
  391ms dev-hugepages.mount                                  
  384ms dev-mqueue.mount                                     
  376ms sys-kernel-debug.mount                               
  367ms sys-kernel-tracing.mount                             
  335ms user@1000.service                                    
  331ms keyboard-setup.service                               
  330ms systemd-journald.service                             
  310ms grub-initrd-fallback.service                         
  307ms kmod-static-nodes.service                            
  302ms atd.service                                          
  262ms rsyslog.service                                      
  237ms e2scrub_reap.service                                 
  236ms systemd-resolved.service                             
  223ms systemd-udev-trigger.service                         
  211ms modprobe@drm.service                                 
  139ms systemd-fsck-root.service                            
  138ms systemd-user-sessions.service                        
  128ms systemd-networkd.service                             
  127ms systemd-fsck@dev-disk-by\x2duuid-3493\x2d2CC4.service
  118ms systemd-modules-load.service                         
  107ms systemd-remount-fs.service                           
  100ms setvtrgb.service                                     
   96ms ssh.service                                          
   88ms systemd-machine-id-commit.service                    
   87ms ufw.service                                          
   84ms snap-snapd-11402.mount                               
   84ms plymouth-read-write.service                          
   82ms finalrd.service                                      
   80ms sys-fs-fuse-connections.mount                        
   79ms sys-kernel-config.mount                              
   78ms console-setup.service                                
   75ms systemd-tmpfiles-setup.service                       
   71ms systemd-sysusers.service                             
   60ms snap-lxd-19823.mount                                 
   60ms snap-core18-1988.mount                               
   55ms snapd.socket                                         
   52ms systemd-sysctl.service                               
   49ms polkit.service                                       
   48ms systemd-journal-flush.service                        
   41ms multipathd.service                                   
   33ms boot-efi.mount                                       
   33ms systemd-udevd.service                                
   31ms systemd-random-seed.service                          
   22ms blk-availability.service                             
   22ms systemd-update-utmp-runlevel.service                 
   22ms plymouth-quit-wait.service                           
   22ms plymouth-quit.service                                
   21ms ephemeral-disk-warning.service                       
   20ms systemd-update-utmp.service                          
   15ms dev-loop1.device                                     
   14ms systemd-tmpfiles-setup-dev.service                   
   10ms user-runtime-dir@1000.service                        
    6ms dev-loop2.device                                     
    1ms dev-loop0.device                                     
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00800s +00.00500s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.05700s +00.00100s
|`->get_boot_telemetry @00.05800s +00.02700s
|`->get_system_info @00.08600s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.08600s +00.08900s
|`->load_azure_ds_dir @00.17500s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.29900s +00.00000s
Starting stage: azure-ds/_get_preprovisioning_cfgs
|`->_get_preprovisionedvm_cfg_value @00.30000s +00.00500s
|`->_get_preprovisionedvmtype_cfg_value @00.30500s +00.00000s
Finished stage: (azure-ds/_get_preprovisioning_cfgs) 00.00500 seconds

Finished stage: (azure-ds/read_azure_ovf) 00.00900 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01400 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.34200s +00.18300s
|`->_get_metadata_from_imds @00.52500s +00.06000s
Finished stage: (azure-ds/get_metadata_from_imds) 00.27700 seconds

|`->_get_random_seed @00.62000s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.53900 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.62500s +00.00100s
|`->write_files @00.62600s +00.00300s
Finished stage: (azure-ds/_get_data) 00.57200 seconds

|`->get_public_ssh_keys @00.63200s +00.00100s
Finished stage: (init-local/search-Azure) 00.58500 seconds

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.74500s +00.00300s
Finished stage: (azure-ds/parse_network_config) 00.00400 seconds

Finished stage: (init-local) 01.09100 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.75000s +00.02100s
Total Time: 3.09600 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.00000s +00.00100s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @00.01100s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @00.01500s +00.10300s
Starting stage: azure-ds/_fetch_goal_state_from_azure
Starting stage: azure-ds/_get_raw_goal_state_xml_from_azure
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @00.11900s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/goalstate-retrieval
|`->http_with_retries @00.12000s +00.00800s
Finished stage: (azure-ds/goalstate-retrieval) 00.00800 seconds

Finished stage: (azure-ds/_get_raw_goal_state_xml_from_azure) 00.01100 seconds

Starting stage: azure-ds/_parse_raw_goal_state_xml
Starting stage: azure-ds/get-certificates-xml
|`->http_with_retries @00.13000s +00.01200s
Finished stage: (azure-ds/get-certificates-xml) 00.01300 seconds

Finished stage: (azure-ds/_parse_raw_goal_state_xml) 00.01300 seconds

Finished stage: (azure-ds/_fetch_goal_state_from_azure) 00.02500 seconds

Starting stage: azure-ds/_get_user_pubkeys
Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @00.14300s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @00.15700s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.03600 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @00.19300s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.05700 seconds

Finished stage: (azure-ds/_get_user_pubkeys) 00.05700 seconds

Starting stage: azure-ds/send_ready_signal
Starting stage: azure-ds/_post_health_report
Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.20100s +00.00000s
Finished stage: (azure-ds/push_log_to_kvp) 00.01100 seconds

|`->http_with_retries @00.21300s +03.09400s
Finished stage: (azure-ds/_post_health_report) 03.10700 seconds

Finished stage: (azure-ds/send_ready_signal) 03.10900 seconds

Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.29500 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.29500 seconds

Finished stage: (azure-ds/_negotiate) 03.30000 seconds

Finished stage: (azure-ds/setup) 03.30000 seconds

Finished stage: (init-network/setup-datasource) 03.30000 seconds

|`->reading and applying user-data @03.31600s +00.00800s
|`->reading and applying vendor-data @03.32400s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.35800s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.35900s +00.14700s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @03.57600s +00.00200s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.08000 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.22900 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.23000 seconds

Total Time: 23.49000 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.00000s +00.00000s
Finished stage: (azure-ds/push_log_to_kvp) 00.02100 seconds

Finished stage: (azure-ds/activate) 00.25200 seconds

Finished stage: (init-network/activate-datasource) 00.25800 seconds

|`->config-migrator ran successfully @00.07700s +00.00100s
|`->config-seed_random ran successfully @00.07800s +00.00200s
|`->config-bootcmd ran successfully @00.08000s +00.00100s
|`->config-write-files ran successfully @00.08100s +00.00100s
|`->config-growpart ran successfully @00.08200s +00.85500s
|`->config-resizefs ran successfully @00.93700s +02.60000s
|`->config-disk_setup ran successfully @03.53700s +02.95500s
|`->config-mounts ran successfully @06.49200s +00.31600s
|`->config-set_hostname ran successfully @06.80900s +00.00700s
|`->config-update_hostname ran successfully @06.81700s +00.00100s
|`->config-update_etc_hosts ran successfully @06.81900s +00.00000s
|`->config-ca-certs ran successfully @06.82000s +00.00000s
|`->config-rsyslog ran successfully @06.82100s +00.00100s
Starting stage: init-network/config-users-groups
|`->get_public_ssh_keys @06.82300s +00.00100s
Finished stage: (init-network/config-users-groups) 00.17000 seconds

Starting stage: init-network/config-ssh
|`->get_public_ssh_keys @07.68500s +00.00100s
Finished stage: (init-network/config-ssh) 00.70300 seconds

Finished stage: (init-network) 11.36600 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @17.70000s +00.00100s
|`->config-snap ran successfully @17.70100s +00.00100s
|`->config-ssh-import-id ran successfully @17.70300s +00.77100s
|`->config-locale ran successfully @18.47500s +00.02500s
|`->config-set-passwords ran successfully @18.50100s +00.00200s
|`->config-grub-dpkg ran successfully @18.50300s +01.01900s
|`->config-apt-pipelining ran successfully @19.52300s +00.00100s
|`->config-apt-configure ran successfully @19.52400s +00.20900s
|`->config-ubuntu-advantage ran successfully @19.73400s +00.00100s
|`->config-ntp ran successfully @19.73500s +00.00100s
|`->config-timezone ran successfully @19.73600s +00.00100s
|`->config-disable-ec2-metadata ran successfully @19.73800s +00.00000s
|`->config-runcmd ran successfully @19.73900s +00.00000s
|`->config-byobu ran successfully @19.74000s +00.00000s
Finished stage: (modules-config) 02.06700 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @20.32000s +00.00100s
|`->config-fan ran successfully @20.32200s +00.00100s
|`->config-landscape ran successfully @20.32300s +00.00100s
|`->config-lxd ran successfully @20.32400s +00.00100s
|`->config-ubuntu-drivers ran successfully @20.32600s +00.00000s
|`->config-puppet ran successfully @20.32700s +00.00100s
|`->config-chef ran successfully @20.32800s +00.00000s
|`->config-mcollective ran successfully @20.32900s +00.00100s
|`->config-salt-minion ran successfully @20.33000s +00.00100s
|`->config-reset_rmc ran successfully @20.33100s +00.00100s
|`->config-refresh_rmc_and_interface ran successfully @20.33300s +00.00000s
|`->config-rightscale_userdata ran successfully @20.33400s +00.00100s
|`->config-scripts-vendor ran successfully @20.33500s +00.00100s
|`->config-scripts-per-once ran successfully @20.33600s +00.00100s
|`->config-scripts-per-boot ran successfully @20.33700s +00.00100s
|`->config-scripts-per-instance ran successfully @20.33800s +00.00100s
|`->config-scripts-user ran successfully @20.33900s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @20.34100s +00.09500s
|`->config-keys-to-console ran successfully @20.43700s +00.11800s
|`->config-phone-home ran successfully @20.55600s +00.00100s
|`->config-final-message ran successfully @20.55800s +00.00400s
|`->config-power-state-change ran successfully @20.56300s +00.00100s
Finished stage: (modules-final) 00.26900 seconds

Total Time: 15.10600 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init analyze blame
-- Boot Record 01 --
     00.18300s (azure-ds/obtain-dhcp-lease)
     00.08900s (azure-ds/list_possible_azure_ds_devs)
     00.06000s (azure-ds/_get_metadata_from_imds)
     00.02700s (azure-ds/get_boot_telemetry)
     00.02100s (init-network/check-cache)
     00.00500s (init-local/check-cache)
     00.00500s (azure-ds/_get_preprovisionedvm_cfg_value)
     00.00300s (azure-ds/write_files)
     00.00300s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00100s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/check-platform-viability)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_get_preprovisionedvmtype_cfg_value)

-- Boot Record 02 --
     03.09400s (azure-ds/http_with_retries)
     00.14700s (azure-ds/_has_ntfs_filesystem)
     00.10300s (azure-ds/generate_certificate)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01200s (azure-ds/http_with_retries)
     00.00800s (init-network/consume-user-data)
     00.00800s (azure-ds/http_with_retries)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00200s (azure-ds/count_files)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/get_last_log_byte_pushed_to_kvp_index)

-- Boot Record 03 --
     02.95500s (init-network/config-disk_setup)
     02.60000s (init-network/config-resizefs)
     01.01900s (modules-config/config-grub-dpkg)
     00.85500s (init-network/config-growpart)
     00.77100s (modules-config/config-ssh-import-id)
     00.31600s (init-network/config-mounts)
     00.20900s (modules-config/config-apt-configure)
     00.11800s (modules-final/config-keys-to-console)
     00.09500s (modules-final/config-ssh-authkey-fingerprints)
     00.02500s (modules-config/config-locale)
     00.00700s (init-network/config-set_hostname)
     00.00400s (modules-final/config-final-message)
     00.00200s (modules-config/config-set-passwords)
     00.00200s (init-network/config-seed_random)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-reset_rmc)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-refresh_rmc_and_interface)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (modules-config/config-byobu)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-ca-certs)
     00.00000s (azure-ds/get_last_log_byte_pushed_to_kvp_index)

3 boot records analyzed
+ echo 'Writing networking config: previous-network.out'
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@65.52.73.71:.
+ egrep cloud-init
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- sudo bash setup_proposed.sh
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu groovy-proposed/main amd64 cloud-init all 21.1-19-gbad84ad4-0ubuntu1~20.10.1 [439 kB]
Preparing to unpack .../cloud-init_21.1-19-gbad84ad4-0ubuntu1~20.10.1_all.deb ...
Unpacking cloud-init (21.1-19-gbad84ad4-0ubuntu1~20.10.1) over (20.4.1-0ubuntu1~20.10.1) ...
Setting up cloud-init (21.1-19-gbad84ad4-0ubuntu1~20.10.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- dpkg-query --show cloud-init
cloud-init	21.1-19-gbad84ad4-0ubuntu1~20.10.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- sudo cloud-init clean --logs --reboot
Connection to 65.52.73.71 closed by remote host.
+ true
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init status --wait --long

status: done
time: Mon, 05 Apr 2021 20:22:33 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- '!' grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- sudo systemd-analyze blame
4.690s snap.lxd.activate.service                                  
4.516s snapd.service                                              
3.474s cloud-init.service                                         
2.648s lvm2-monitor.service                                       
2.447s dev-sda1.device                                            
2.136s cloud-config.service                                       
2.086s systemd-udev-settle.service                                
1.850s cloud-init-local.service                                   
1.231s systemd-networkd-wait-online.service                       
1.078s networkd-dispatcher.service                                
1.076s accounts-daemon.service                                    
 811ms cloud-final.service                                        
 787ms grub-common.service                                        
 714ms chrony.service                                             
 713ms systemd-logind.service                                     
 487ms ssh.service                                                
 476ms walinuxagent-network-setup.service                         
 449ms systemd-udev-trigger.service                               
 445ms systemd-journald.service                                   
 404ms keyboard-setup.service                                     
 370ms apport.service                                             
 297ms sys-kernel-tracing.mount                                   
 286ms sys-kernel-debug.mount                                     
 278ms dev-mqueue.mount                                           
 273ms dev-hugepages.mount                                        
 268ms kmod-static-nodes.service                                  
 261ms blk-availability.service                                   
 250ms modprobe@drm.service                                       
 240ms apparmor.service                                           
 235ms systemd-fsck-root.service                                  
 232ms systemd-modules-load.service                               
 226ms e2scrub_reap.service                                       
 221ms rsyslog.service                                            
 216ms ufw.service                                                
 212ms atd.service                                                
 202ms snapd.apparmor.service                                     
 201ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
 164ms systemd-fsck@dev-disk-by\x2duuid-3493\x2d2CC4.service      
 152ms systemd-resolved.service                                   
 139ms systemd-remount-fs.service                                 
 125ms systemd-tmpfiles-setup.service                             
 113ms user@1000.service                                          
 109ms systemd-journal-flush.service                              
 107ms systemd-random-seed.service                                
  98ms systemd-networkd.service                                   
  97ms grub-initrd-fallback.service                               
  95ms setvtrgb.service                                           
  91ms finalrd.service                                            
  88ms plymouth-read-write.service                                
  79ms dev-loop1.device                                           
  75ms multipathd.service                                         
  73ms snapd.seeded.service                                       
  67ms polkit.service                                             
  65ms sys-fs-fuse-connections.mount                              
  65ms systemd-sysusers.service                                   
  62ms systemd-udevd.service                                      
  62ms systemd-user-sessions.service                              
  60ms sys-kernel-config.mount                                    
  58ms snap-snapd-11402.mount                                     
  55ms snap-lxd-19823.mount                                       
  51ms snap-core18-1988.mount                                     
  50ms snapd.socket                                               
  42ms console-setup.service                                      
  42ms systemd-sysctl.service                                     
  41ms plymouth-quit.service                                      
  41ms systemd-tmpfiles-setup-dev.service                         
  34ms dev-loop0.device                                           
  31ms boot-efi.mount                                             
  28ms plymouth-quit-wait.service                                 
  21ms systemd-update-utmp.service                                
  19ms dev-loop2.device                                           
  15ms systemd-update-utmp-runlevel.service                       
  13ms user-runtime-dir@1000.service                              
   7ms ephemeral-disk-warning.service                             
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03000s +00.00100s
|`->get_boot_telemetry @00.03100s +00.02000s
|`->get_system_info @00.05100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05100s +00.21200s
|`->load_azure_ds_dir @00.26400s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.26800s +00.00000s
Starting stage: azure-ds/_get_preprovisioning_cfgs
|`->_get_preprovisionedvm_cfg_value @00.26800s +00.00100s
|`->_get_preprovisionedvmtype_cfg_value @00.26900s +00.00000s
Finished stage: (azure-ds/_get_preprovisioning_cfgs) 00.00100 seconds

Finished stage: (azure-ds/read_azure_ovf) 00.00500 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_imds_data_with_api_fallback
Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.29100s +00.30200s
|`->_get_metadata_from_imds @00.59300s +00.01000s
Finished stage: (azure-ds/get_metadata_from_imds) 00.33400 seconds

Finished stage: (azure-ds/get_imds_data_with_api_fallback) 00.33400 seconds

|`->_get_random_seed @00.62500s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.57500 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.62600s +00.00000s
|`->write_files @00.62600s +00.00300s
Finished stage: (azure-ds/_get_data) 00.59900 seconds

|`->get_public_ssh_keys @00.62900s +00.00100s
Finished stage: (init-local/search-Azure) 00.60500 seconds

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.68500s +00.00100s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Finished stage: (init-local) 00.99700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.18500s +00.02100s
Total Time: 3.45600 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.00000s +00.00000s
Finished stage: (azure-ds/parse_network_config) 00.00000 seconds

Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @00.01000s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @00.01500s +00.10400s
Starting stage: azure-ds/_fetch_goal_state_from_azure
Starting stage: azure-ds/_get_raw_goal_state_xml_from_azure
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @00.12000s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/goalstate-retrieval
|`->http_with_retries @00.12200s +00.00600s
Finished stage: (azure-ds/goalstate-retrieval) 00.00600 seconds

Finished stage: (azure-ds/_get_raw_goal_state_xml_from_azure) 00.00800 seconds

Starting stage: azure-ds/_parse_raw_goal_state_xml
Starting stage: azure-ds/get-certificates-xml
|`->http_with_retries @00.12900s +00.01000s
Finished stage: (azure-ds/get-certificates-xml) 00.01100 seconds

Finished stage: (azure-ds/_parse_raw_goal_state_xml) 00.01100 seconds

Finished stage: (azure-ds/_fetch_goal_state_from_azure) 00.02100 seconds

Starting stage: azure-ds/_get_user_pubkeys
Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @00.14100s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @00.15500s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.09800 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @00.25300s +00.00700s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.11900 seconds

Finished stage: (azure-ds/_get_user_pubkeys) 00.11900 seconds

Starting stage: azure-ds/send_ready_signal
Starting stage: azure-ds/_post_health_report
Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.26100s +00.00000s
Finished stage: (azure-ds/push_log_to_kvp) 00.01200 seconds

|`->http_with_retries @00.27300s +00.00600s
Finished stage: (azure-ds/_post_health_report) 00.01900 seconds

Finished stage: (azure-ds/send_ready_signal) 00.01900 seconds

Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.26500 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.26600 seconds

Finished stage: (azure-ds/_negotiate) 00.27100 seconds

Finished stage: (azure-ds/setup) 00.27100 seconds

Finished stage: (init-network/setup-datasource) 00.27100 seconds

|`->reading and applying user-data @00.28800s +00.00700s
|`->reading and applying vendor-data @00.29600s +00.00000s
|`->reading and applying vendor-data2 @00.29600s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @00.34400s +00.13700s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.14700 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.14700 seconds

Total Time: 2.09400 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.00000s +00.00100s
Finished stage: (azure-ds/push_log_to_kvp) 00.02700 seconds

Finished stage: (azure-ds/activate) 00.17600 seconds

Finished stage: (init-network/activate-datasource) 00.18000 seconds

|`->config-migrator ran successfully @00.07800s +00.00100s
|`->config-seed_random ran successfully @00.08200s +00.00100s
|`->config-bootcmd ran successfully @00.08400s +00.00100s
|`->config-write-files ran successfully @00.08500s +00.00600s
|`->config-growpart ran successfully @00.09100s +00.05800s
|`->config-resizefs ran successfully @00.15000s +00.32600s
|`->config-disk_setup ran successfully @00.47600s +00.76800s
|`->config-mounts ran successfully @01.24500s +00.31200s
|`->config-set_hostname ran successfully @01.55700s +00.00700s
|`->config-update_hostname ran successfully @01.56500s +00.00100s
|`->config-update_etc_hosts ran successfully @01.56600s +00.00100s
|`->config-ca-certs ran successfully @01.56700s +00.00100s
|`->config-rsyslog ran successfully @01.56900s +00.00000s
Starting stage: init-network/config-users-groups
|`->get_public_ssh_keys @01.57100s +00.00100s
Finished stage: (init-network/config-users-groups) 00.18100 seconds

Starting stage: init-network/config-ssh
|`->get_public_ssh_keys @02.38300s +00.00100s
Finished stage: (init-network/config-ssh) 00.63900 seconds

Finished stage: (init-network) 02.95400 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @08.17700s +00.00000s
|`->config-snap ran successfully @08.17800s +00.00100s
|`->config-ssh-import-id ran successfully @08.17900s +00.68700s
|`->config-locale ran successfully @08.86700s +00.02600s
|`->config-set-passwords ran successfully @08.89300s +00.00100s
|`->config-grub-dpkg ran successfully @08.89500s +00.44700s
|`->config-apt-pipelining ran successfully @09.34300s +00.00100s
|`->config-apt-configure ran successfully @09.34500s +00.18600s
|`->config-ubuntu-advantage ran successfully @09.53200s +00.00100s
|`->config-ntp ran successfully @09.53400s +00.00000s
|`->config-timezone ran successfully @09.53500s +00.00100s
|`->config-disable-ec2-metadata ran successfully @09.53600s +00.00100s
|`->config-runcmd ran successfully @09.53700s +00.00100s
|`->config-byobu ran successfully @09.53800s +00.00100s
Finished stage: (modules-config) 01.37900 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @10.09000s +00.00100s
|`->config-fan ran successfully @10.09200s +00.00100s
|`->config-landscape ran successfully @10.09300s +00.00100s
|`->config-lxd ran successfully @10.09400s +00.00100s
|`->config-ubuntu-drivers ran successfully @10.09600s +00.00000s
|`->config-puppet ran successfully @10.09700s +00.00100s
|`->config-chef ran successfully @10.09800s +00.00000s
|`->config-mcollective ran successfully @10.09900s +00.00100s
|`->config-salt-minion ran successfully @10.10000s +00.00100s
|`->config-reset_rmc ran successfully @10.10100s +00.00100s
|`->config-refresh_rmc_and_interface ran successfully @10.10300s +00.00000s
|`->config-rightscale_userdata ran successfully @10.10400s +00.00000s
|`->config-scripts-vendor ran successfully @10.10500s +00.00100s
|`->config-scripts-per-once ran successfully @10.10600s +00.00100s
|`->config-scripts-per-boot ran successfully @10.10700s +00.00100s
|`->config-scripts-per-instance ran successfully @10.10800s +00.00100s
|`->config-scripts-user ran successfully @10.10900s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @10.11100s +00.12400s
|`->config-keys-to-console ran successfully @10.23600s +00.09900s
|`->config-phone-home ran successfully @10.33600s +00.00100s
|`->config-final-message ran successfully @10.33800s +00.00400s
|`->config-power-state-change ran successfully @10.34300s +00.00100s
Finished stage: (modules-final) 00.27300 seconds

Total Time: 5.80900 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init analyze blame
-- Boot Record 01 --
     00.30200s (azure-ds/obtain-dhcp-lease)
     00.21200s (azure-ds/list_possible_azure_ds_devs)
     00.02100s (init-network/check-cache)
     00.02000s (azure-ds/get_boot_telemetry)
     00.01000s (azure-ds/_get_metadata_from_imds)
     00.00300s (azure-ds/write_files)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/check-platform-viability)
     00.00100s (azure-ds/_get_preprovisionedvm_cfg_value)
     00.00100s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_get_preprovisionedvmtype_cfg_value)

-- Boot Record 02 --
     00.13700s (azure-ds/_has_ntfs_filesystem)
     00.10400s (azure-ds/generate_certificate)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/http_with_retries)
     00.00700s (init-network/consume-user-data)
     00.00700s (azure-ds/_run_x509_action)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/http_with_retries)
     00.00600s (azure-ds/http_with_retries)
     00.00100s (init-network/consume-vendor-data2)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00000s (init-network/consume-vendor-data)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/get_last_log_byte_pushed_to_kvp_index)
     00.00000s (azure-ds/_generate_network_config_from_imds_metadata)

-- Boot Record 03 --
     00.76800s (init-network/config-disk_setup)
     00.68700s (modules-config/config-ssh-import-id)
     00.44700s (modules-config/config-grub-dpkg)
     00.32600s (init-network/config-resizefs)
     00.31200s (init-network/config-mounts)
     00.18600s (modules-config/config-apt-configure)
     00.12400s (modules-final/config-ssh-authkey-fingerprints)
     00.09900s (modules-final/config-keys-to-console)
     00.05800s (init-network/config-growpart)
     00.02600s (modules-config/config-locale)
     00.00700s (init-network/config-set_hostname)
     00.00600s (init-network/config-write-files)
     00.00400s (modules-final/config-final-message)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-scripts-per-boot)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-reset_rmc)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-update_etc_hosts)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-ca-certs)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/get_last_log_byte_pushed_to_kvp_index)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-rightscale_userdata)
     00.00000s (modules-final/config-refresh_rmc_and_interface)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-ntp)
     00.00000s (modules-config/config-emit_upstart)
     00.00000s (init-network/config-rsyslog)

3 boot records analyzed
+ echo 'After upgrade write network config: upgrade-network.out'
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- grep DHCP /var/log/syslog
+ echo '------- Diff previous-network to post-upgrade-network ------'
------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
--- previous-network.out	2021-04-05 16:21:23.537049287 -0400
+++ upgrade-network.out	2021-04-05 16:23:22.618822266 -0400
@@ -40,3 +40,10 @@
 Apr  5 20:20:47 SRU-worked-azure dhclient[471]: DHCPACK of 10.0.0.55 from 168.63.129.16 (xid=0x81561e62)
 Apr  5 20:20:47 SRU-worked-azure systemd-networkd[506]: eth0: DHCPv4 address 10.0.0.55/24 via 10.0.0.1
 Apr  5 20:20:47 SRU-worked-azure systemd-networkd[506]: eth0: Classless static routes received from DHCP server: ignoring router option
+Apr  5 20:22:25 SRU-worked-azure dhclient[494]: Internet Systems Consortium DHCP Client 4.4.1
+Apr  5 20:22:25 SRU-worked-azure dhclient[494]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0x946f446d)
+Apr  5 20:22:25 SRU-worked-azure dhclient[494]: DHCPOFFER of 10.0.0.55 from 168.63.129.16
+Apr  5 20:22:25 SRU-worked-azure dhclient[494]: DHCPREQUEST for 10.0.0.55 on eth0 to 255.255.255.255 port 67 (xid=0x6d446f94)
+Apr  5 20:22:25 SRU-worked-azure dhclient[494]: DHCPACK of 10.0.0.55 from 168.63.129.16 (xid=0x946f446d)
+Apr  5 20:22:25 SRU-worked-azure systemd-networkd[533]: eth0: DHCPv4 address 10.0.0.55/24 via 10.0.0.1
+Apr  5 20:22:25 SRU-worked-azure systemd-networkd[533]: eth0: Classless static routes received from DHCP server: ignoring router option
+ true
+ echo '------- Diff previous-network to post-upgrade-network ------'
------- Diff previous-network to post-upgrade-network ------
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init query --format ''\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: azure-northeurope
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init query --format ''\''cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'\'''
cloud-region: azure-northeurope
+ echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to be System Boot'
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be System Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- sudo reboot
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- cloud-init status --wait --long

status: done
time: Mon, 05 Apr 2021 20:23:55 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2021-04-05 20:22:19,061 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2021-04-05 20:23:43,767 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2021-04-05 20:23:44,185 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo 'Validate https://github.com/canonical/cloud-init/commit/22e683df'
Validate https://github.com/canonical/cloud-init/commit/22e683df
+ echo 'Azure needs to use __builtin__ agent by default on all releases'
Azure needs to use __builtin__ agent by default on all releases
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@65.52.73.71 -- 'egrep '\''fabric'\'' /var/log/cloud-init.log'
2021-04-05 20:22:22,297 - DataSourceAzure.py[DEBUG]: negotiating with fabric via agent command __builtin__
2021-04-05 20:22:22,297 - handlers.py[DEBUG]: start: azure-ds/get_metadata_from_fabric: get_metadata_from_fabric
2021-04-05 20:22:22,298 - azure.py[DEBUG]: Generating certificate for communication with fabric...
2021-04-05 20:22:22,543 - azure.py[DEBUG]: Reporting ready to Azure fabric.
2021-04-05 20:22:22,556 - azure.py[DEBUG]: Sending health report to Azure fabric.
2021-04-05 20:22:22,562 - azure.py[DEBUG]: Successfully sent health report to Azure fabric
2021-04-05 20:22:22,562 - azure.py[INFO]: Reported ready to Azure fabric.
2021-04-05 20:22:22,563 - handlers.py[DEBUG]: finish: azure-ds/get_metadata_from_fabric: SUCCESS: get_metadata_from_fabric
2021-04-05 20:23:47,246 - DataSourceAzure.py[DEBUG]: negotiating with fabric via agent command __builtin__
2021-04-05 20:23:47,246 - handlers.py[DEBUG]: start: azure-ds/get_metadata_from_fabric: get_metadata_from_fabric
2021-04-05 20:23:47,247 - azure.py[DEBUG]: Generating certificate for communication with fabric...
2021-04-05 20:23:47,406 - azure.py[DEBUG]: Reporting ready to Azure fabric.
2021-04-05 20:23:47,426 - azure.py[DEBUG]: Sending health report to Azure fabric.
2021-04-05 20:23:47,432 - azure.py[DEBUG]: Successfully sent health report to Azure fabric
2021-04-05 20:23:47,432 - azure.py[INFO]: Reported ready to Azure fabric.
2021-04-05 20:23:47,433 - handlers.py[DEBUG]: finish: azure-ds/get_metadata_from_fabric: SUCCESS: get_metadata_from_fabric
+ echo '### END groovy'
### END groovy
