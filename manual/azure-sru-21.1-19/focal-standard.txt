+ SRU_VARS=./sru-scripts/sru-vars.template
+ '[' '!' -f ./sru-scripts/sru-vars.template ']'
+ . ./sru-scripts/sru-vars.template
++ PRESERVE_INSTANCE=false
++ UBUNTU_RELEASE=
++ LP_USER=oddbloke
++ PROPOSED_SCRIPT=setup_proposed.sh
++ USE_DEV_PPA=0
++ ENI_NETCFG_FILE=/etc/network/interfaces.d/50-cloud-init.cfg
++ NETPLAN_NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
++ SAMPLE_CLOUDCONFIG=sethostname.yaml
++ SSH_KEY=/home/daniel/.ssh/id_rsa.pub
++ SSHOPTS=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR)
++ AZURE_REGION=UNSET
++ AZURE_VNET_NAME=UNSET
++ AZURE_NETWORK_SECURITY_GROUP=UNSET
++ AZURE_NIC_NAME=UNSET
++ AZURE_RESOURCE_GROUP=UNSET
++ AZURE_BOOT_DIAG=UNSET
++ AZURE_ADVANCED_NIC_TESTS=true
++ GCE_ZONE=UNSET
++ OPENSTACK_ADMIN_NET_ID=UNSET
++ OPENSTACK_SSH_KEY_NAME=UNSET
++ OCI_COMPARTMENT_ID=UNSET
++ SRU_VARS_RC=.sru-vars.rc
++ '[' -f .sru-vars.rc ']'
++ . ./.sru-vars.rc
+++ PRESERVE_INSTANCE=false
+++ UBUNTU_RELEASE=
+++ LP_USER=oddbloke
+++ PROPOSED_SCRIPT=setup_proposed.sh
+++ USE_DEV_PPA=0
+++ ENI_NETCFG_FILE=/etc/network/interfaces.d/50-cloud-init.cfg
+++ NETPLAN_NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
+++ SAMPLE_CLOUDCONFIG=sethostname.yaml
+++ SSH_KEY=/home/daniel/.ssh/id_rsa.canonical.pub
+++ SSHOPTS=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR)
+++ AZURE_REGION=northeurope
+++ AZURE_VNET_NAME=sruscripts
+++ AZURE_NETWORK_SECURITY_GROUP=sruscripts
+++ AZURE_NIC_NAME=sruscripts
+++ AZURE_RESOURCE_GROUP=xx16resourcegroup
+++ AZURE_BOOT_DIAG=sruscripts
+++ AZURE_ADVANCED_NIC_TESTS=true
+++ GCE_ZONE=UNSET
+++ OPENSTACK_ADMIN_NET_ID=UNSET
+++ OPENSTACK_SSH_KEY_NAME=UNSET
+ parse_args ./sru-scripts/manual/azure-sru focal
+ script=./sru-scripts/manual/azure-sru
+ shift
+ '[' 1 = 0 ']'
+ '[' 1 -ne 0 ']'
+ case "$1" in
+ UBUNTU_RELEASE=focal
+ NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
+ shift
+ '[' 0 -ne 0 ']'
+ '[' -z focal ']'
+ assert_expected_vars PROPOSED_SCRIPT AZURE_REGION AZURE_VNET_NAME AZURE_NETWORK_SECURITY_GROUP AZURE_NIC_NAME AZURE_RESOURCE_GROUP AZURE_BOOT_DIAG SSH_KEY SAMPLE_CLOUDCONFIG AZURE_ADVANCED_NIC_TESTS
+ local value=
+ for var in $@
+ eval 'value=$PROPOSED_SCRIPT > /dev/null'
++ value=setup_proposed.sh
+ '[' -z setup_proposed.sh -o setup_proposed.sh = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_REGION > /dev/null'
++ value=northeurope
+ '[' -z northeurope -o northeurope = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_VNET_NAME > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_NETWORK_SECURITY_GROUP > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_NIC_NAME > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_RESOURCE_GROUP > /dev/null'
++ value=xx16resourcegroup
+ '[' -z xx16resourcegroup -o xx16resourcegroup = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_BOOT_DIAG > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$SSH_KEY > /dev/null'
++ value=/home/daniel/.ssh/id_rsa.canonical.pub
+ '[' -z /home/daniel/.ssh/id_rsa.canonical.pub -o /home/daniel/.ssh/id_rsa.canonical.pub = UNSET ']'
+ for var in $@
+ eval 'value=$SAMPLE_CLOUDCONFIG > /dev/null'
++ value=sethostname.yaml
+ '[' -z sethostname.yaml -o sethostname.yaml = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_ADVANCED_NIC_TESTS > /dev/null'
++ value=true
+ '[' -z true -o true = UNSET ']'
+ create_samplecloudconfig SAMPLE_CLOUDCONFIG
+ filename=SAMPLE_CLOUDCONFIG
+ cat
+ create_setup_proposed_script
+ '[' 0 -eq 0 ']'
+ cat
+ AZURE_VNET_NAME=sruscripts-focal
++ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
++ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
++ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
++ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ '[' Registered '!=' Registered -o Registered '!=' Registered ']'
++ az provider show -n Microsoft.Network
++ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo 'Waiting for Microsoft.Network IPv6 feature registration'
Waiting for Microsoft.Network IPv6 feature registration
+ '[' Registered '!=' Registered ']'
+ echo '### BEGIN focal'
### BEGIN focal
+ az group show -g xx16resourcegroup
+ '[' -n sruscripts ']'
+ az storage account show --name sruscripts
+ AZURE_BOOT_DIAG_ARG='--boot-diagnostics-storage sruscripts'
+ az network nsg show --name sruscripts -g xx16resourcegroup
+ az network nsg rule show --name allowSSHIn --nsg-name sruscripts -g xx16resourcegroup
+ az network nsg rule show --name allowAllOut --nsg-name sruscripts -g xx16resourcegroup
+ az network vnet show --name sruscripts-focal -g xx16resourcegroup
+ az network vnet subnet show --name sruSubnet --vnet-name sruscripts-focal -g xx16resourcegroup
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ case $UBUNTU_RELEASE in
+ image_version=Canonical:0001-com-ubuntu-server-focal-daily:20_04-daily-lts
+ for nics in ""
+ '[' '' = '' ']'
+ echo 'Creating standard network vm'
Creating standard network vm
+ name=test-sru-focal
+ az vm show --name test-sru-focal -g xx16resourcegroup
+ az vm create --name=test-sru-focal --image=Canonical:0001-com-ubuntu-server-focal-daily:20_04-daily-lts:latest --admin-username=root --admin-username=ubuntu -g xx16resourcegroup --ssh-key-value /home/daniel/.ssh/id_rsa.canonical.pub --boot-diagnostics-storage sruscripts --custom-data sethostname.yaml
{
  "fqdns": "",
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Compute/virtualMachines/test-sru-focal",
  "location": "northeurope",
  "macAddress": "00-22-48-9A-98-60",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.56",
  "publicIpAddress": "137.135.221.167",
  "resourceGroup": "xx16resourcegroup",
  "zones": ""
}
++ az vm list-ip-addresses --name test-sru-focal
++ jq -r '.[] | .virtualMachine.network.publicIpAddresses[].ipAddress'
++ awk '{printf "ubuntu@%s", $1}'
+ IP=ubuntu@137.135.221.167
+ echo 'Created test-sru-focal: ubuntu@ubuntu@137.135.221.167'
Created test-sru-focal: ubuntu@ubuntu@137.135.221.167
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init status --wait --long

status: done
time: Mon, 05 Apr 2021 20:26:22 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- dpkg-query --show cloud-init
cloud-init	20.4.1-0ubuntu1~20.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- '!' grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- systemd-analyze
Startup finished in 2.492s (kernel) + 35.517s (userspace) = 38.009s 
graphical.target reached after 34.653s in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- systemd-analyze blame
11.609s cloud-init.service                                   
 7.726s snapd.seeded.service                                 
 3.069s snapd.service                                        
 2.900s cloud-config.service                                 
 2.707s snapd.apparmor.service                               
 2.165s cloud-init-local.service                             
 2.087s lvm2-monitor.service                                 
 1.925s systemd-networkd-wait-online.service                 
 1.841s dev-sdb1.device                                      
 1.672s pollinate.service                                    
 1.669s systemd-udev-settle.service                          
 1.637s accounts-daemon.service                              
 1.213s snap.lxd.activate.service                            
  950ms apparmor.service                                     
  941ms apport.service                                       
  935ms networkd-dispatcher.service                          
  833ms cloud-final.service                                  
  778ms grub-common.service                                  
  702ms systemd-logind.service                               
  534ms chrony.service                                       
  433ms atd.service                                          
  351ms rsyslog.service                                      
  339ms dev-hugepages.mount                                  
  334ms dev-mqueue.mount                                     
  332ms e2scrub_reap.service                                 
  327ms sys-kernel-debug.mount                               
  320ms sys-kernel-tracing.mount                             
  294ms keyboard-setup.service                               
  283ms systemd-journald.service                             
  268ms kmod-static-nodes.service                            
  237ms dev-loop2.device                                     
  217ms grub-initrd-fallback.service                         
  205ms systemd-udev-trigger.service                         
  191ms systemd-resolved.service                             
  186ms modprobe@drm.service                                 
  176ms systemd-user-sessions.service                        
  168ms user@1000.service                                    
  150ms systemd-networkd.service                             
  140ms snap-snapd-11402.mount                               
  123ms systemd-fsck-root.service                            
  115ms dev-loop0.device                                     
  111ms systemd-tmpfiles-setup.service                       
  110ms systemd-modules-load.service                         
  109ms ssh.service                                          
  107ms systemd-machine-id-commit.service                    
  102ms plymouth-read-write.service                          
  101ms systemd-remount-fs.service                           
   99ms polkit.service                                       
   98ms finalrd.service                                      
   94ms dev-loop1.device                                     
   93ms console-setup.service                                
   90ms snap-lxd-19647.mount                                 
   85ms snap-core18-1997.mount                               
   85ms sys-kernel-config.mount                              
   82ms plymouth-quit.service                                
   80ms ufw.service                                          
   73ms sys-fs-fuse-connections.mount                        
   73ms systemd-sysusers.service                             
   69ms multipathd.service                                   
   63ms plymouth-quit-wait.service                           
   62ms systemd-fsck@dev-disk-by\x2duuid-EB08\x2d3784.service
   60ms setvtrgb.service                                     
   59ms snapd.socket                                         
   52ms systemd-journal-flush.service                        
   43ms systemd-sysctl.service                               
   31ms systemd-udevd.service                                
   31ms blk-availability.service                             
   30ms ephemeral-disk-warning.service                       
   30ms boot-efi.mount                                       
   29ms systemd-random-seed.service                          
   28ms systemd-update-utmp-runlevel.service                 
   26ms systemd-update-utmp.service                          
   16ms user-runtime-dir@1000.service                        
   14ms systemd-tmpfiles-setup-dev.service                   
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.01200s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.06400s +00.00000s
|`->get_boot_telemetry @00.06500s +00.02600s
|`->get_system_info @00.09100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.09200s +00.07200s
|`->load_azure_ds_dir @00.16500s +00.00000s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.28500s +00.00000s
Starting stage: azure-ds/_get_preprovisioning_cfgs
|`->_get_preprovisionedvm_cfg_value @00.28500s +00.00100s
|`->_get_preprovisionedvmtype_cfg_value @00.28600s +00.00200s
Finished stage: (azure-ds/_get_preprovisioning_cfgs) 00.00300 seconds

Finished stage: (azure-ds/read_azure_ovf) 00.00700 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.01100 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.32600s +00.19000s
|`->_get_metadata_from_imds @00.51700s +00.01600s
Finished stage: (azure-ds/get_metadata_from_imds) 00.23300 seconds

|`->_get_random_seed @00.56500s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.47500 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.56600s +00.00000s
|`->write_files @00.56700s +00.00600s
Finished stage: (azure-ds/_get_data) 00.50900 seconds

|`->get_public_ssh_keys @00.57300s +00.00100s
Finished stage: (init-local/search-Azure) 00.51800 seconds

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.68100s +00.00000s
Finished stage: (azure-ds/parse_network_config) 00.00000 seconds

Finished stage: (init-local) 01.01200 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @03.68900s +00.01900s
Total Time: 2.76800 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.00000s +00.00100s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @00.01000s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @00.01500s +00.21600s
Starting stage: azure-ds/_fetch_goal_state_from_azure
Starting stage: azure-ds/_get_raw_goal_state_xml_from_azure
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @00.23200s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/goalstate-retrieval
|`->http_with_retries @00.23400s +00.00800s
Finished stage: (azure-ds/goalstate-retrieval) 00.00900 seconds

Finished stage: (azure-ds/_get_raw_goal_state_xml_from_azure) 00.01000 seconds

Starting stage: azure-ds/_parse_raw_goal_state_xml
Starting stage: azure-ds/get-certificates-xml
|`->http_with_retries @00.24300s +00.01000s
Finished stage: (azure-ds/get-certificates-xml) 00.01100 seconds

Finished stage: (azure-ds/_parse_raw_goal_state_xml) 00.01200 seconds

Finished stage: (azure-ds/_fetch_goal_state_from_azure) 00.02400 seconds

Starting stage: azure-ds/_get_user_pubkeys
Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @00.25500s +00.01300s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @00.26900s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.03800 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @00.30800s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00700 seconds

Finished stage: (azure-ds/parse_certificates) 00.05900 seconds

Finished stage: (azure-ds/_get_user_pubkeys) 00.05900 seconds

Starting stage: azure-ds/send_ready_signal
Starting stage: azure-ds/_post_health_report
Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.31500s +00.00000s
Finished stage: (azure-ds/push_log_to_kvp) 00.01100 seconds

|`->http_with_retries @00.32700s +02.81400s
Finished stage: (azure-ds/_post_health_report) 02.82600 seconds

Finished stage: (azure-ds/send_ready_signal) 02.82700 seconds

Finished stage: (azure-ds/register_with_azure_and_fetch_data) 03.12700 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 03.12800 seconds

Finished stage: (azure-ds/_negotiate) 03.13300 seconds

Finished stage: (azure-ds/setup) 03.13300 seconds

Finished stage: (init-network/setup-datasource) 03.13300 seconds

|`->reading and applying user-data @03.14900s +00.00800s
|`->reading and applying vendor-data @03.15700s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.19100s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.19100s +00.14100s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @03.39800s +00.00300s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.08300 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.22400 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.22400 seconds

Total Time: 22.08400 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.00000s +00.00000s
Finished stage: (azure-ds/push_log_to_kvp) 00.00900 seconds

Finished stage: (azure-ds/activate) 00.23500 seconds

Finished stage: (init-network/activate-datasource) 00.23800 seconds

|`->config-migrator ran successfully @00.06500s +00.00100s
|`->config-seed_random ran successfully @00.06600s +00.00100s
|`->config-bootcmd ran successfully @00.06800s +00.00000s
|`->config-write-files ran successfully @00.06900s +00.00100s
|`->config-growpart ran successfully @00.07000s +00.72300s
|`->config-resizefs ran successfully @00.79400s +02.13500s
|`->config-disk_setup ran successfully @02.92900s +02.95300s
|`->config-mounts ran successfully @05.88400s +00.31900s
|`->config-set_hostname ran successfully @06.20400s +00.01300s
|`->config-update_hostname ran successfully @06.21800s +00.00300s
|`->config-update_etc_hosts ran successfully @06.22200s +00.00000s
|`->config-ca-certs ran successfully @06.22300s +00.00200s
|`->config-rsyslog ran successfully @06.22500s +00.00400s
Starting stage: init-network/config-users-groups
|`->get_public_ssh_keys @06.23000s +00.00100s
Finished stage: (init-network/config-users-groups) 00.17200 seconds

Starting stage: init-network/config-ssh
|`->get_public_ssh_keys @07.54200s +00.00100s
Finished stage: (init-network/config-ssh) 01.14600 seconds

Finished stage: (init-network) 11.04000 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @19.66500s +00.00100s
|`->config-snap ran successfully @19.66600s +00.00100s
|`->config-ssh-import-id ran successfully @19.66700s +00.81400s
|`->config-locale ran successfully @20.48100s +00.04000s
|`->config-set-passwords ran successfully @20.52200s +00.00100s
|`->config-grub-dpkg ran successfully @20.52300s +01.26000s
|`->config-apt-pipelining ran successfully @21.78400s +00.00100s
|`->config-apt-configure ran successfully @21.78500s +00.12100s
|`->config-ubuntu-advantage ran successfully @21.90700s +00.00100s
|`->config-ntp ran successfully @21.90800s +00.00100s
|`->config-timezone ran successfully @21.91000s +00.00000s
|`->config-disable-ec2-metadata ran successfully @21.91100s +00.00000s
|`->config-runcmd ran successfully @21.91200s +00.00000s
|`->config-byobu ran successfully @21.91300s +00.00100s
Finished stage: (modules-config) 02.28600 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @22.57900s +00.00100s
|`->config-fan ran successfully @22.58100s +00.00100s
|`->config-landscape ran successfully @22.58200s +00.00100s
|`->config-lxd ran successfully @22.58300s +00.00200s
|`->config-ubuntu-drivers ran successfully @22.58500s +00.00100s
|`->config-puppet ran successfully @22.58600s +00.00100s
|`->config-chef ran successfully @22.58700s +00.00100s
|`->config-mcollective ran successfully @22.58800s +00.00100s
|`->config-salt-minion ran successfully @22.58900s +00.00100s
|`->config-reset_rmc ran successfully @22.59100s +00.00100s
|`->config-refresh_rmc_and_interface ran successfully @22.59200s +00.00100s
|`->config-rightscale_userdata ran successfully @22.59300s +00.00100s
|`->config-scripts-vendor ran successfully @22.59400s +00.00200s
|`->config-scripts-per-once ran successfully @22.59600s +00.00100s
|`->config-scripts-per-boot ran successfully @22.59700s +00.00000s
|`->config-scripts-per-instance ran successfully @22.59800s +00.00100s
|`->config-scripts-user ran successfully @22.59900s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @22.60000s +00.05500s
|`->config-keys-to-console ran successfully @22.65600s +00.14600s
|`->config-phone-home ran successfully @22.80300s +00.00100s
|`->config-final-message ran successfully @22.80400s +00.00400s
|`->config-power-state-change ran successfully @22.80800s +00.00100s
Finished stage: (modules-final) 00.25100 seconds

Total Time: 15.37700 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init analyze blame
-- Boot Record 01 --
     00.19000s (azure-ds/obtain-dhcp-lease)
     00.07200s (azure-ds/list_possible_azure_ds_devs)
     00.02600s (azure-ds/get_boot_telemetry)
     00.01900s (init-network/check-cache)
     00.01600s (azure-ds/_get_metadata_from_imds)
     00.00600s (azure-ds/write_files)
     00.00200s (azure-ds/_get_preprovisionedvmtype_cfg_value)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/_get_preprovisionedvm_cfg_value)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/load_azure_ds_dir)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/check-platform-viability)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_generate_network_config_from_imds_metadata)

-- Boot Record 02 --
     02.81400s (azure-ds/http_with_retries)
     00.21600s (azure-ds/generate_certificate)
     00.14100s (azure-ds/_has_ntfs_filesystem)
     00.01300s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/http_with_retries)
     00.00800s (init-network/consume-user-data)
     00.00800s (azure-ds/http_with_retries)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00300s (azure-ds/count_files)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/get_last_log_byte_pushed_to_kvp_index)

-- Boot Record 03 --
     02.95300s (init-network/config-disk_setup)
     02.13500s (init-network/config-resizefs)
     01.26000s (modules-config/config-grub-dpkg)
     00.81400s (modules-config/config-ssh-import-id)
     00.72300s (init-network/config-growpart)
     00.31900s (init-network/config-mounts)
     00.14600s (modules-final/config-keys-to-console)
     00.12100s (modules-config/config-apt-configure)
     00.05500s (modules-final/config-ssh-authkey-fingerprints)
     00.04000s (modules-config/config-locale)
     00.01300s (init-network/config-set_hostname)
     00.00400s (modules-final/config-final-message)
     00.00400s (init-network/config-rsyslog)
     00.00300s (init-network/config-update_hostname)
     00.00200s (modules-final/config-scripts-vendor)
     00.00200s (modules-final/config-lxd)
     00.00200s (init-network/config-ca-certs)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-reset_rmc)
     00.00100s (modules-final/config-refresh_rmc_and_interface)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-migrator)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-config/config-timezone)
     00.00000s (modules-config/config-runcmd)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/get_last_log_byte_pushed_to_kvp_index)

3 boot records analyzed
+ echo 'Writing networking config: previous-network.out'
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@137.135.221.167:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- sudo bash setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu focal-proposed/main amd64 cloud-init all 21.1-19-gbad84ad4-0ubuntu1~20.04.1 [452 kB]
Preparing to unpack .../cloud-init_21.1-19-gbad84ad4-0ubuntu1~20.04.1_all.deb ...
Unpacking cloud-init (21.1-19-gbad84ad4-0ubuntu1~20.04.1) over (20.4.1-0ubuntu1~20.04.1) ...
Setting up cloud-init (21.1-19-gbad84ad4-0ubuntu1~20.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- dpkg-query --show cloud-init
cloud-init	21.1-19-gbad84ad4-0ubuntu1~20.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- sudo cloud-init clean --logs --reboot
Connection to 137.135.221.167 closed by remote host.
+ true
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init status --wait --long

status: done
time: Mon, 05 Apr 2021 20:28:05 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- '!' grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- sudo systemd-analyze blame
3.322s snap.lxd.activate.service                                  
3.175s snapd.service                                              
3.025s cloud-init.service                                         
2.605s lvm2-monitor.service                                       
2.384s dev-sda1.device                                            
2.275s cloud-config.service                                       
2.114s systemd-udev-settle.service                                
1.494s cloud-init-local.service                                   
1.242s networkd-dispatcher.service                                
1.162s accounts-daemon.service                                    
1.061s systemd-networkd-wait-online.service                       
 859ms cloud-final.service                                        
 834ms systemd-logind.service                                     
 651ms chrony.service                                             
 477ms walinuxagent-network-setup.service                         
 414ms ssh.service                                                
 399ms apport.service                                             
 391ms grub-common.service                                        
 383ms systemd-udev-trigger.service                               
 349ms keyboard-setup.service                                     
 348ms systemd-journald.service                                   
 313ms dev-loop1.device                                           
 311ms sys-kernel-tracing.mount                                   
 304ms sys-kernel-debug.mount                                     
 297ms dev-loop2.device                                           
 292ms dev-mqueue.mount                                           
 285ms kmod-static-nodes.service                                  
 281ms modprobe@drm.service                                       
 280ms dev-hugepages.mount                                        
 256ms systemd-fsck-root.service                                  
 245ms e2scrub_reap.service                                       
 240ms systemd-modules-load.service                               
 214ms ufw.service                                                
 210ms rsyslog.service                                            
 209ms atd.service                                                
 189ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
 174ms systemd-resolved.service                                   
 164ms apparmor.service                                           
 160ms user@1000.service                                          
 158ms systemd-fsck@dev-disk-by\x2duuid-EB08\x2d3784.service      
 155ms snapd.seeded.service                                       
 154ms systemd-journal-flush.service                              
 149ms systemd-remount-fs.service                                 
 148ms snapd.apparmor.service                                     
 133ms dev-loop0.device                                           
 125ms systemd-networkd.service                                   
 110ms grub-initrd-fallback.service                               
  80ms polkit.service                                             
  77ms systemd-udevd.service                                      
  68ms systemd-random-seed.service                                
  68ms multipathd.service                                         
  67ms systemd-sysusers.service                                   
  64ms systemd-tmpfiles-setup.service                             
  63ms systemd-update-utmp-runlevel.service                       
  60ms snap-snapd-11402.mount                                     
  59ms snap-lxd-19647.mount                                       
  57ms snap-core18-1997.mount                                     
  57ms systemd-user-sessions.service                              
  57ms sys-fs-fuse-connections.mount                              
  56ms snapd.socket                                               
  54ms sys-kernel-config.mount                                    
  50ms setvtrgb.service                                           
  48ms plymouth-read-write.service                                
  48ms console-setup.service                                      
  48ms finalrd.service                                            
  42ms systemd-sysctl.service                                     
  39ms plymouth-quit.service                                      
  38ms systemd-tmpfiles-setup-dev.service                         
  27ms boot-efi.mount                                             
  23ms blk-availability.service                                   
  22ms systemd-update-utmp.service                                
  21ms plymouth-quit-wait.service                                 
  17ms user-runtime-dir@1000.service                              
  12ms ephemeral-disk-warning.service                             
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00000s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03000s +00.00100s
|`->get_boot_telemetry @00.03100s +00.02000s
|`->get_system_info @00.05100s +00.00000s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05200s +00.16400s
|`->load_azure_ds_dir @00.21700s +00.03300s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.25300s +00.00000s
Starting stage: azure-ds/_get_preprovisioning_cfgs
|`->_get_preprovisionedvm_cfg_value @00.25400s +00.00000s
|`->_get_preprovisionedvmtype_cfg_value @00.25400s +00.00100s
Finished stage: (azure-ds/_get_preprovisioning_cfgs) 00.00200 seconds

Finished stage: (azure-ds/read_azure_ovf) 00.00500 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00600 seconds

Starting stage: azure-ds/get_imds_data_with_api_fallback
Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.27800s +00.09800s
|`->_get_metadata_from_imds @00.37600s +00.01000s
Finished stage: (azure-ds/get_metadata_from_imds) 00.13100 seconds

Finished stage: (azure-ds/get_imds_data_with_api_fallback) 00.13100 seconds

|`->_get_random_seed @00.40900s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 00.35900 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.41000s +00.00000s
|`->write_files @00.41100s +00.00200s
Finished stage: (azure-ds/_get_data) 00.38300 seconds

|`->get_public_ssh_keys @00.41400s +00.00000s
Finished stage: (init-local/search-Azure) 00.38900 seconds

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.46500s +00.00000s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Finished stage: (init-local) 00.66700 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @02.69600s +00.02000s
Total Time: 2.07400 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.00000s +00.00100s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @00.01100s +00.00100s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @00.01600s +00.04700s
Starting stage: azure-ds/_fetch_goal_state_from_azure
Starting stage: azure-ds/_get_raw_goal_state_xml_from_azure
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @00.06400s +00.00000s
Finished stage: (azure-ds/find_endpoint) 00.00100 seconds

Starting stage: azure-ds/goalstate-retrieval
|`->http_with_retries @00.06600s +00.00600s
Finished stage: (azure-ds/goalstate-retrieval) 00.00600 seconds

Finished stage: (azure-ds/_get_raw_goal_state_xml_from_azure) 00.01000 seconds

Starting stage: azure-ds/_parse_raw_goal_state_xml
Starting stage: azure-ds/get-certificates-xml
|`->http_with_retries @00.07400s +00.01000s
Finished stage: (azure-ds/get-certificates-xml) 00.01000 seconds

Finished stage: (azure-ds/_parse_raw_goal_state_xml) 00.01200 seconds

Finished stage: (azure-ds/_fetch_goal_state_from_azure) 00.02200 seconds

Starting stage: azure-ds/_get_user_pubkeys
Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @00.08700s +00.01400s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @00.10200s +00.00700s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.01400 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @00.11700s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03700 seconds

Finished stage: (azure-ds/_get_user_pubkeys) 00.03900 seconds

Starting stage: azure-ds/send_ready_signal
Starting stage: azure-ds/_post_health_report
Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.12400s +00.00100s
Finished stage: (azure-ds/push_log_to_kvp) 00.01100 seconds

|`->http_with_retries @00.13700s +00.00500s
Finished stage: (azure-ds/_post_health_report) 00.01900 seconds

Finished stage: (azure-ds/send_ready_signal) 00.01900 seconds

Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.12700 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.12800 seconds

Finished stage: (azure-ds/_negotiate) 00.13300 seconds

Finished stage: (azure-ds/setup) 00.13400 seconds

Finished stage: (init-network/setup-datasource) 00.13400 seconds

|`->reading and applying user-data @00.15300s +00.00700s
|`->reading and applying vendor-data @00.16000s +00.00100s
|`->reading and applying vendor-data2 @00.16100s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @00.20000s +00.15600s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.15700 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.15700 seconds

Total Time: 1.18100 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.00000s +00.00100s
Finished stage: (azure-ds/push_log_to_kvp) 00.02200 seconds

Finished stage: (azure-ds/activate) 00.18700 seconds

Finished stage: (init-network/activate-datasource) 00.18900 seconds

|`->config-migrator ran successfully @00.05900s +00.00200s
|`->config-seed_random ran successfully @00.06900s +00.00100s
|`->config-bootcmd ran successfully @00.07000s +00.00200s
|`->config-write-files ran successfully @00.07300s +00.00100s
|`->config-growpart ran successfully @00.07400s +00.16300s
|`->config-resizefs ran successfully @00.23800s +00.24700s
|`->config-disk_setup ran successfully @00.48600s +00.65000s
|`->config-mounts ran successfully @01.13600s +00.28300s
|`->config-set_hostname ran successfully @01.41900s +00.01200s
|`->config-update_hostname ran successfully @01.43200s +00.00100s
|`->config-update_etc_hosts ran successfully @01.43400s +00.00000s
|`->config-ca-certs ran successfully @01.43500s +00.00100s
|`->config-rsyslog ran successfully @01.43600s +00.00100s
Starting stage: init-network/config-users-groups
|`->get_public_ssh_keys @01.43900s +00.00000s
Finished stage: (init-network/config-users-groups) 00.08100 seconds

Starting stage: init-network/config-ssh
|`->get_public_ssh_keys @02.07800s +00.00100s
Finished stage: (init-network/config-ssh) 00.56600 seconds

Finished stage: (init-network) 02.51800 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @06.81500s +00.00100s
|`->config-snap ran successfully @06.81600s +00.00100s
|`->config-ssh-import-id ran successfully @06.81700s +00.61500s
|`->config-locale ran successfully @07.43200s +00.04300s
|`->config-set-passwords ran successfully @07.47600s +00.00100s
|`->config-grub-dpkg ran successfully @07.47800s +00.53900s
|`->config-apt-pipelining ran successfully @08.01800s +00.00100s
|`->config-apt-configure ran successfully @08.01900s +00.12300s
|`->config-ubuntu-advantage ran successfully @08.14300s +00.00000s
|`->config-ntp ran successfully @08.14400s +00.00100s
|`->config-timezone ran successfully @08.14500s +00.00100s
|`->config-disable-ec2-metadata ran successfully @08.14600s +00.00100s
|`->config-runcmd ran successfully @08.14700s +00.00100s
|`->config-byobu ran successfully @08.14800s +00.00200s
Finished stage: (modules-config) 01.35400 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @08.77200s +00.00100s
|`->config-fan ran successfully @08.77300s +00.00200s
|`->config-landscape ran successfully @08.77500s +00.00100s
|`->config-lxd ran successfully @08.77600s +00.00100s
|`->config-ubuntu-drivers ran successfully @08.77800s +00.00000s
|`->config-puppet ran successfully @08.77900s +00.00000s
|`->config-chef ran successfully @08.78000s +00.00000s
|`->config-mcollective ran successfully @08.78100s +00.00100s
|`->config-salt-minion ran successfully @08.78300s +00.00100s
|`->config-reset_rmc ran successfully @08.78500s +00.00200s
|`->config-refresh_rmc_and_interface ran successfully @08.78700s +00.00100s
|`->config-rightscale_userdata ran successfully @08.78800s +00.00300s
|`->config-scripts-vendor ran successfully @08.79100s +00.00100s
|`->config-scripts-per-once ran successfully @08.79300s +00.00100s
|`->config-scripts-per-boot ran successfully @08.79400s +00.00000s
|`->config-scripts-per-instance ran successfully @08.79500s +00.00100s
|`->config-scripts-user ran successfully @08.79600s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @08.79800s +00.11100s
|`->config-keys-to-console ran successfully @08.90900s +00.10100s
|`->config-phone-home ran successfully @09.01000s +00.00200s
|`->config-final-message ran successfully @09.01200s +00.00400s
|`->config-power-state-change ran successfully @09.01700s +00.00100s
Finished stage: (modules-final) 00.26600 seconds

Total Time: 5.18300 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init analyze blame
-- Boot Record 01 --
     00.16400s (azure-ds/list_possible_azure_ds_devs)
     00.09800s (azure-ds/obtain-dhcp-lease)
     00.03300s (azure-ds/load_azure_ds_dir)
     00.02000s (init-network/check-cache)
     00.02000s (azure-ds/get_boot_telemetry)
     00.01000s (azure-ds/_get_metadata_from_imds)
     00.00200s (azure-ds/write_files)
     00.00100s (azure-ds/check-platform-viability)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_get_preprovisionedvmtype_cfg_value)
     00.00000s (init-local/check-cache)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_system_info)
     00.00000s (azure-ds/get_public_ssh_keys)
     00.00000s (azure-ds/_get_preprovisionedvm_cfg_value)
     00.00000s (azure-ds/_generate_network_config_from_imds_metadata)

-- Boot Record 02 --
     00.15600s (azure-ds/_has_ntfs_filesystem)
     00.04700s (azure-ds/generate_certificate)
     00.01400s (azure-ds/_decrypt_certs_from_xml)
     00.01000s (azure-ds/http_with_retries)
     00.00700s (init-network/consume-user-data)
     00.00700s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/http_with_retries)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (azure-ds/http_with_retries)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (azure-ds/temporary_hostname)
     00.00100s (azure-ds/get_last_log_byte_pushed_to_kvp_index)
     00.00100s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00000s (init-network/consume-vendor-data2)
     00.00000s (azure-ds/_networkd_get_value_from_leases)

-- Boot Record 03 --
     00.65000s (init-network/config-disk_setup)
     00.61500s (modules-config/config-ssh-import-id)
     00.53900s (modules-config/config-grub-dpkg)
     00.28300s (init-network/config-mounts)
     00.24700s (init-network/config-resizefs)
     00.16300s (init-network/config-growpart)
     00.12300s (modules-config/config-apt-configure)
     00.11100s (modules-final/config-ssh-authkey-fingerprints)
     00.10100s (modules-final/config-keys-to-console)
     00.04300s (modules-config/config-locale)
     00.01200s (init-network/config-set_hostname)
     00.00400s (modules-final/config-final-message)
     00.00300s (modules-final/config-rightscale_userdata)
     00.00200s (modules-final/config-reset_rmc)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-final/config-fan)
     00.00200s (modules-config/config-byobu)
     00.00200s (init-network/config-migrator)
     00.00200s (init-network/config-bootcmd)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-refresh_rmc_and_interface)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-update_hostname)
     00.00100s (init-network/config-seed_random)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-ca-certs)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/get_last_log_byte_pushed_to_kvp_index)
     00.00000s (modules-final/config-ubuntu-drivers)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-puppet)
     00.00000s (modules-final/config-chef)
     00.00000s (modules-config/config-ubuntu-advantage)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (azure-ds/get_public_ssh_keys)

3 boot records analyzed
+ echo 'After upgrade write network config: upgrade-network.out'
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- grep DHCP /var/log/syslog
+ echo '------- Diff previous-network to post-upgrade-network ------'
------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
--- previous-network.out	2021-04-05 16:26:55.034047815 -0400
+++ upgrade-network.out	2021-04-05 16:28:53.899879063 -0400
@@ -39,3 +39,9 @@
 Apr  5 20:26:07 SRU-worked-azure dhclient[454]: DHCPREQUEST for 10.0.0.56 on eth0 to 255.255.255.255 port 67 (xid=0x6c0cb929)
 Apr  5 20:26:07 SRU-worked-azure dhclient[454]: DHCPACK of 10.0.0.56 from 168.63.129.16 (xid=0x29b90c6c)
 Apr  5 20:26:07 SRU-worked-azure systemd-networkd[490]: eth0: DHCPv4 address 10.0.0.56/24 via 10.0.0.1
+Apr  5 20:27:59 SRU-worked-azure dhclient[475]: Internet Systems Consortium DHCP Client 4.4.1
+Apr  5 20:27:59 SRU-worked-azure dhclient[475]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0x836a8f5d)
+Apr  5 20:27:59 SRU-worked-azure dhclient[475]: DHCPOFFER of 10.0.0.56 from 168.63.129.16
+Apr  5 20:27:59 SRU-worked-azure dhclient[475]: DHCPREQUEST for 10.0.0.56 on eth0 to 255.255.255.255 port 67 (xid=0x5d8f6a83)
+Apr  5 20:27:59 SRU-worked-azure dhclient[475]: DHCPACK of 10.0.0.56 from 168.63.129.16 (xid=0x836a8f5d)
+Apr  5 20:27:59 SRU-worked-azure systemd-networkd[514]: eth0: DHCPv4 address 10.0.0.56/24 via 10.0.0.1
+ true
+ echo '------- Diff previous-network to post-upgrade-network ------'
------- Diff previous-network to post-upgrade-network ------
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init query --format ''\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: azure-northeurope
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init query --format ''\''cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'\'''
cloud-region: azure-northeurope
+ echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to be System Boot'
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be System Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- sudo reboot
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- cloud-init status --wait --long

status: done
time: Mon, 05 Apr 2021 20:29:25 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2021-04-05 20:27:53,332 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2021-04-05 20:29:15,622 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2021-04-05 20:29:16,028 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo 'Validate https://github.com/canonical/cloud-init/commit/22e683df'
Validate https://github.com/canonical/cloud-init/commit/22e683df
+ echo 'Azure needs to use __builtin__ agent by default on all releases'
Azure needs to use __builtin__ agent by default on all releases
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@137.135.221.167 -- 'egrep '\''fabric'\'' /var/log/cloud-init.log'
2021-04-05 20:27:56,077 - DataSourceAzure.py[DEBUG]: negotiating with fabric via agent command __builtin__
2021-04-05 20:27:56,078 - handlers.py[DEBUG]: start: azure-ds/get_metadata_from_fabric: get_metadata_from_fabric
2021-04-05 20:27:56,078 - azure.py[DEBUG]: Generating certificate for communication with fabric...
2021-04-05 20:27:56,186 - azure.py[DEBUG]: Reporting ready to Azure fabric.
2021-04-05 20:27:56,198 - azure.py[DEBUG]: Sending health report to Azure fabric.
2021-04-05 20:27:56,205 - azure.py[DEBUG]: Successfully sent health report to Azure fabric
2021-04-05 20:27:56,205 - azure.py[INFO]: Reported ready to Azure fabric.
2021-04-05 20:27:56,206 - handlers.py[DEBUG]: finish: azure-ds/get_metadata_from_fabric: SUCCESS: get_metadata_from_fabric
2021-04-05 20:29:18,908 - DataSourceAzure.py[DEBUG]: negotiating with fabric via agent command __builtin__
2021-04-05 20:29:18,908 - handlers.py[DEBUG]: start: azure-ds/get_metadata_from_fabric: get_metadata_from_fabric
2021-04-05 20:29:18,909 - azure.py[DEBUG]: Generating certificate for communication with fabric...
2021-04-05 20:29:19,069 - azure.py[DEBUG]: Reporting ready to Azure fabric.
2021-04-05 20:29:19,086 - azure.py[DEBUG]: Sending health report to Azure fabric.
2021-04-05 20:29:19,092 - azure.py[DEBUG]: Successfully sent health report to Azure fabric
2021-04-05 20:29:19,092 - azure.py[INFO]: Reported ready to Azure fabric.
2021-04-05 20:29:19,093 - handlers.py[DEBUG]: finish: azure-ds/get_metadata_from_fabric: SUCCESS: get_metadata_from_fabric
+ echo '### END focal'
### END focal
