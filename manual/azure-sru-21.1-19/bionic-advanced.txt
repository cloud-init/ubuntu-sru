+ SRU_VARS=./sru-scripts/sru-vars.template
+ '[' '!' -f ./sru-scripts/sru-vars.template ']'
+ . ./sru-scripts/sru-vars.template
++ PRESERVE_INSTANCE=false
++ UBUNTU_RELEASE=
++ LP_USER=oddbloke
++ PROPOSED_SCRIPT=setup_proposed.sh
++ USE_DEV_PPA=0
++ ENI_NETCFG_FILE=/etc/network/interfaces.d/50-cloud-init.cfg
++ NETPLAN_NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
++ SAMPLE_CLOUDCONFIG=sethostname.yaml
++ SSH_KEY=/home/daniel/.ssh/id_rsa.pub
++ SSHOPTS=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR)
++ AZURE_REGION=UNSET
++ AZURE_VNET_NAME=UNSET
++ AZURE_NETWORK_SECURITY_GROUP=UNSET
++ AZURE_NIC_NAME=UNSET
++ AZURE_RESOURCE_GROUP=UNSET
++ AZURE_BOOT_DIAG=UNSET
++ AZURE_ADVANCED_NIC_TESTS=true
++ GCE_ZONE=UNSET
++ OPENSTACK_ADMIN_NET_ID=UNSET
++ OPENSTACK_SSH_KEY_NAME=UNSET
++ OCI_COMPARTMENT_ID=UNSET
++ SRU_VARS_RC=.sru-vars.rc
++ '[' -f .sru-vars.rc ']'
++ . ./.sru-vars.rc
+++ PRESERVE_INSTANCE=false
+++ UBUNTU_RELEASE=
+++ LP_USER=oddbloke
+++ PROPOSED_SCRIPT=setup_proposed.sh
+++ USE_DEV_PPA=0
+++ ENI_NETCFG_FILE=/etc/network/interfaces.d/50-cloud-init.cfg
+++ NETPLAN_NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
+++ SAMPLE_CLOUDCONFIG=sethostname.yaml
+++ SSH_KEY=/home/daniel/.ssh/id_rsa.canonical.pub
+++ SSHOPTS=(-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR)
+++ AZURE_REGION=northeurope
+++ AZURE_VNET_NAME=sruscripts
+++ AZURE_NETWORK_SECURITY_GROUP=sruscripts
+++ AZURE_NIC_NAME=sruscripts
+++ AZURE_RESOURCE_GROUP=xx16resourcegroup
+++ AZURE_BOOT_DIAG=sruscripts
+++ AZURE_ADVANCED_NIC_TESTS=true
+++ GCE_ZONE=UNSET
+++ OPENSTACK_ADMIN_NET_ID=UNSET
+++ OPENSTACK_SSH_KEY_NAME=UNSET
+ parse_args ./sru-scripts/manual/azure-sru bionic
+ script=./sru-scripts/manual/azure-sru
+ shift
+ '[' 1 = 0 ']'
+ '[' 1 -ne 0 ']'
+ case "$1" in
+ UBUNTU_RELEASE=bionic
+ NETCFG_FILE=/etc/netplan/50-cloud-init.yaml
+ shift
+ '[' 0 -ne 0 ']'
+ '[' -z bionic ']'
+ assert_expected_vars PROPOSED_SCRIPT AZURE_REGION AZURE_VNET_NAME AZURE_NETWORK_SECURITY_GROUP AZURE_NIC_NAME AZURE_RESOURCE_GROUP AZURE_BOOT_DIAG SSH_KEY SAMPLE_CLOUDCONFIG AZURE_ADVANCED_NIC_TESTS
+ local value=
+ for var in $@
+ eval 'value=$PROPOSED_SCRIPT > /dev/null'
++ value=setup_proposed.sh
+ '[' -z setup_proposed.sh -o setup_proposed.sh = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_REGION > /dev/null'
++ value=northeurope
+ '[' -z northeurope -o northeurope = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_VNET_NAME > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_NETWORK_SECURITY_GROUP > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_NIC_NAME > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_RESOURCE_GROUP > /dev/null'
++ value=xx16resourcegroup
+ '[' -z xx16resourcegroup -o xx16resourcegroup = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_BOOT_DIAG > /dev/null'
++ value=sruscripts
+ '[' -z sruscripts -o sruscripts = UNSET ']'
+ for var in $@
+ eval 'value=$SSH_KEY > /dev/null'
++ value=/home/daniel/.ssh/id_rsa.canonical.pub
+ '[' -z /home/daniel/.ssh/id_rsa.canonical.pub -o /home/daniel/.ssh/id_rsa.canonical.pub = UNSET ']'
+ for var in $@
+ eval 'value=$SAMPLE_CLOUDCONFIG > /dev/null'
++ value=sethostname.yaml
+ '[' -z sethostname.yaml -o sethostname.yaml = UNSET ']'
+ for var in $@
+ eval 'value=$AZURE_ADVANCED_NIC_TESTS > /dev/null'
++ value=true
+ '[' -z true -o true = UNSET ']'
+ create_samplecloudconfig SAMPLE_CLOUDCONFIG
+ filename=SAMPLE_CLOUDCONFIG
+ cat
+ create_setup_proposed_script
+ '[' 0 -eq 0 ']'
+ cat
+ AZURE_VNET_NAME=sruscripts-bionic
++ az feature show --name AllowIPv6VirtualNetwork --namespace Microsoft.Network
++ jq -r .properties.state
+ IPV6_NET_REGISTERED=Registered
++ az feature show --name AllowIPv6CAOnStandardLB --namespace Microsoft.Network
++ jq -r .properties.state
+ IPV6_CA_LB_REGISTERED=Registered
+ '[' Registered '!=' Registered -o Registered '!=' Registered ']'
++ az provider show -n Microsoft.Network
++ jq -r .registrationState
+ IPV6_REGISTRATION_COMPLETE=Registered
+ echo 'Waiting for Microsoft.Network IPv6 feature registration'
Waiting for Microsoft.Network IPv6 feature registration
+ '[' Registered '!=' Registered ']'
+ echo '### BEGIN bionic'
### BEGIN bionic
+ az group show -g xx16resourcegroup
+ '[' -n sruscripts ']'
+ az storage account show --name sruscripts
+ AZURE_BOOT_DIAG_ARG='--boot-diagnostics-storage sruscripts'
+ az network nsg show --name sruscripts -g xx16resourcegroup
+ az network nsg rule show --name allowSSHIn --nsg-name sruscripts -g xx16resourcegroup
+ az network nsg rule show --name allowAllOut --nsg-name sruscripts -g xx16resourcegroup
+ az network vnet show --name sruscripts-bionic -g xx16resourcegroup
+ az network vnet create --resource-group xx16resourcegroup --location northeurope --name sruscripts-bionic --address-prefixes 10.0.0.0/16 ace:cab:deca::/48
{
  "newVNet": {
    "addressSpace": {
      "addressPrefixes": [
        "10.0.0.0/16",
        "ace:cab:deca::/48"
      ]
    },
    "bgpCommunities": null,
    "ddosProtectionPlan": null,
    "dhcpOptions": {
      "dnsServers": []
    },
    "enableDdosProtection": false,
    "enableVmProtection": null,
    "etag": "W/\"7df7b357-588c-4c21-8246-a247af7f463b\"",
    "extendedLocation": null,
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/virtualNetworks/sruscripts-bionic",
    "ipAllocations": null,
    "location": "northeurope",
    "name": "sruscripts-bionic",
    "provisioningState": "Succeeded",
    "resourceGroup": "xx16resourcegroup",
    "resourceGuid": "107f4eff-17e5-49ba-a084-97d0db1057c1",
    "subnets": [],
    "tags": {},
    "type": "Microsoft.Network/virtualNetworks",
    "virtualNetworkPeerings": []
  }
}
+ az network vnet subnet show --name sruSubnet --vnet-name sruscripts-bionic -g xx16resourcegroup
+ az network vnet subnet create --name sruSubnet --resource-group xx16resourcegroup --vnet-name sruscripts-bionic --address-prefixes 10.0.0.0/24 ace:cab:deca:deed::/64 --network-security-group sruscripts
{
  "addressPrefix": null,
  "addressPrefixes": [
    "10.0.0.0/24",
    "ace:cab:deca:deed::/64"
  ],
  "delegations": [],
  "etag": "W/\"b5b4debd-1aa1-4c20-82a0-43c30c083a82\"",
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/virtualNetworks/sruscripts-bionic/subnets/sruSubnet",
  "ipAllocations": null,
  "ipConfigurationProfiles": null,
  "ipConfigurations": null,
  "name": "sruSubnet",
  "natGateway": null,
  "networkSecurityGroup": {
    "defaultSecurityRules": null,
    "etag": null,
    "flowLogs": null,
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/networkSecurityGroups/sruscripts",
    "location": null,
    "name": null,
    "networkInterfaces": null,
    "provisioningState": null,
    "resourceGroup": "xx16resourcegroup",
    "resourceGuid": null,
    "securityRules": null,
    "subnets": null,
    "tags": null,
    "type": null
  },
  "privateEndpointNetworkPolicies": "Enabled",
  "privateEndpoints": null,
  "privateLinkServiceNetworkPolicies": "Enabled",
  "provisioningState": "Succeeded",
  "purpose": null,
  "resourceGroup": "xx16resourcegroup",
  "resourceNavigationLinks": null,
  "routeTable": null,
  "serviceAssociationLinks": null,
  "serviceEndpointPolicies": null,
  "serviceEndpoints": null,
  "type": "Microsoft.Network/virtualNetworks/subnets"
}
+ netcfg=/etc/netplan/50-cloud-init.yaml
+ case $UBUNTU_RELEASE in
+ image_version=Canonical:UbuntuServer:18.04-DAILY-LTS
+ for nics in "--nics $AZURE_NIC_NAME-$UBUNTU_RELEASE ${AZURE_NIC_NAME}2-$UBUNTU_RELEASE --size Standard_DS2_v2"
+ '[' '' = '--nics sruscripts-bionic sruscripts2-bionic --size Standard_DS2_v2' ']'
+ '[' true = false ']'
+ echo 'Creating advanced network vm'
Creating advanced network vm
+ name=test-sru-bionic-advanced
+ az network public-ip create --name vmPublicIP-IPv4-bionic --resource-group xx16resourcegroup --location northeurope --sku BASIC --allocation-method dynamic --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"24a0c5f6-5f8a-436b-98c1-963d8ce3e746\"",
    "extendedLocation": null,
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/publicIPAddresses/vmPublicIP-IPv4-bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "northeurope",
    "name": "vmPublicIP-IPv4-bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "xx16resourcegroup",
    "resourceGuid": "e07f99c3-b810-4500-8a52-eadc232a9654",
    "sku": {
      "name": "Basic",
      "tier": "Regional"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name lbPublicIP_v4_bionic --resource-group xx16resourcegroup --location northeurope --sku BASIC --allocation-method dynamic --version IPv4
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"d7bb2765-bd31-446e-9d10-78a8575172ca\"",
    "extendedLocation": null,
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v4_bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "northeurope",
    "name": "lbPublicIP_v4_bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv4",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "xx16resourcegroup",
    "resourceGuid": "48f6be13-c386-44c1-84b0-615af79b4236",
    "sku": {
      "name": "Basic",
      "tier": "Regional"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network public-ip create --name lbPublicIP_v6_bionic --resource-group xx16resourcegroup --location northeurope --sku BASIC --allocation-method dynamic --version IPv6
{
  "publicIp": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": "W/\"f1a3e813-8c09-4430-bb07-aaee022ddba0\"",
    "extendedLocation": null,
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v6_bionic",
    "idleTimeoutInMinutes": 4,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": [],
    "location": "northeurope",
    "name": "lbPublicIP_v6_bionic",
    "provisioningState": "Succeeded",
    "publicIpAddressVersion": "IPv6",
    "publicIpAllocationMethod": "Dynamic",
    "publicIpPrefix": null,
    "resourceGroup": "xx16resourcegroup",
    "resourceGuid": "0444ac03-7a4d-465e-82cc-8093e4572f7d",
    "sku": {
      "name": "Basic",
      "tier": "Regional"
    },
    "tags": null,
    "type": "Microsoft.Network/publicIPAddresses",
    "zones": null
  }
}
+ az network lb create --name dsLB_bionic --resource-group xx16resourcegroup --sku Basic --location northeurope --frontend-ip-name dsLbFrontEnd_v4_bionic --public-ip-address lbPublicIP_v4_bionic --backend-pool-name dsLbBackEndPool_v4_bionic
{
  "loadBalancer": {
    "backendAddressPools": [
      {
        "etag": "W/\"f0f8e70d-c284-405d-82cd-f70f144df02e\"",
        "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v4_bionic",
        "name": "dsLbBackEndPool_v4_bionic",
        "properties": {
          "provisioningState": "Succeeded"
        },
        "resourceGroup": "xx16resourcegroup",
        "type": "Microsoft.Network/loadBalancers/backendAddressPools"
      }
    ],
    "frontendIPConfigurations": [
      {
        "etag": "W/\"f0f8e70d-c284-405d-82cd-f70f144df02e\"",
        "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/frontendIPConfigurations/dsLbFrontEnd_v4_bionic",
        "name": "dsLbFrontEnd_v4_bionic",
        "properties": {
          "privateIPAddressVersion": "IPv4",
          "privateIPAllocationMethod": "Dynamic",
          "provisioningState": "Succeeded",
          "publicIPAddress": {
            "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v4_bionic",
            "resourceGroup": "xx16resourcegroup"
          }
        },
        "resourceGroup": "xx16resourcegroup",
        "type": "Microsoft.Network/loadBalancers/frontendIPConfigurations"
      }
    ],
    "inboundNatPools": [],
    "inboundNatRules": [],
    "loadBalancingRules": [],
    "probes": [],
    "provisioningState": "Succeeded",
    "resourceGuid": "ec11f8ed-03fc-4c61-8073-692fd186e314"
  }
}
+ az network lb frontend-ip create --lb-name dsLB_bionic --name dsLbFrontEnd_v6_bionic --resource-group xx16resourcegroup --public-ip-address lbPublicIP_v6_bionic
{
  "etag": "W/\"e5713221-ab3b-40b2-a089-4526e56876de\"",
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/frontendIPConfigurations/dsLbFrontEnd_v6_bionic",
  "inboundNatPools": null,
  "inboundNatRules": null,
  "loadBalancingRules": null,
  "name": "dsLbFrontEnd_v6_bionic",
  "outboundRules": null,
  "privateIpAddress": null,
  "privateIpAddressVersion": "IPv4",
  "privateIpAllocationMethod": "Dynamic",
  "provisioningState": "Succeeded",
  "publicIpAddress": {
    "ddosSettings": null,
    "dnsSettings": null,
    "etag": null,
    "extendedLocation": null,
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/publicIPAddresses/lbPublicIP_v6_bionic",
    "idleTimeoutInMinutes": null,
    "ipAddress": null,
    "ipConfiguration": null,
    "ipTags": null,
    "location": null,
    "name": null,
    "provisioningState": null,
    "publicIpAddressVersion": null,
    "publicIpAllocationMethod": null,
    "publicIpPrefix": null,
    "resourceGroup": "xx16resourcegroup",
    "resourceGuid": null,
    "sku": null,
    "tags": null,
    "type": null,
    "zones": null
  },
  "publicIpPrefix": null,
  "resourceGroup": "xx16resourcegroup",
  "subnet": null,
  "type": "Microsoft.Network/loadBalancers/frontendIPConfigurations",
  "zones": null
}
+ az network lb address-pool create --lb-name dsLB_bionic --name dsLbBackEndPool_v6_bionic --resource-group xx16resourcegroup
{
  "backendIpConfigurations": null,
  "etag": "W/\"0d4e9393-35d2-4b00-a2f7-3932d48b5e13\"",
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v6_bionic",
  "loadBalancerBackendAddresses": null,
  "loadBalancingRules": null,
  "location": null,
  "name": "dsLbBackEndPool_v6_bionic",
  "outboundRule": null,
  "outboundRules": null,
  "provisioningState": "Succeeded",
  "resourceGroup": "xx16resourcegroup",
  "type": "Microsoft.Network/loadBalancers/backendAddressPools"
}
+ az network lb probe create -g xx16resourcegroup --lb-name dsLB_bionic -n dsProbe_bionic --protocol tcp --port 22
{
  "etag": "W/\"413ecde2-8ceb-4f1a-bfd8-8007bb291074\"",
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/probes/dsProbe_bionic",
  "intervalInSeconds": 15,
  "loadBalancingRules": null,
  "name": "dsProbe_bionic",
  "numberOfProbes": 2,
  "port": 22,
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "requestPath": null,
  "resourceGroup": "xx16resourcegroup",
  "type": "Microsoft.Network/loadBalancers/probes"
}
+ az network lb rule create --lb-name dsLB_bionic --name dsLBrule_v4_bionic --resource-group xx16resourcegroup --frontend-ip-name dsLbFrontEnd_v4_bionic --protocol Tcp --frontend-port 22 --backend-port 22 --probe-name dsProbe_bionic --backend-pool-name dsLbBackEndPool_v4_bionic
{
  "backendAddressPool": {
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v4_bionic",
    "resourceGroup": "xx16resourcegroup"
  },
  "backendPort": 22,
  "disableOutboundSnat": null,
  "enableFloatingIp": false,
  "enableTcpReset": false,
  "etag": "W/\"b0ce65ae-4320-444e-a413-a50c23842a37\"",
  "frontendIpConfiguration": {
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/frontendIPConfigurations/dsLbFrontEnd_v4_bionic",
    "resourceGroup": "xx16resourcegroup"
  },
  "frontendPort": 22,
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/loadBalancingRules/dsLBrule_v4_bionic",
  "idleTimeoutInMinutes": 4,
  "loadDistribution": "Default",
  "name": "dsLBrule_v4_bionic",
  "probe": {
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/probes/dsProbe_bionic",
    "resourceGroup": "xx16resourcegroup"
  },
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "xx16resourcegroup",
  "type": "Microsoft.Network/loadBalancers/loadBalancingRules"
}
+ az network lb rule create --lb-name dsLB_bionic --name dsLBrule_v6_bionic --resource-group xx16resourcegroup --frontend-ip-name dsLbFrontEnd_v6_bionic --protocol Tcp --frontend-port 22 --backend-port 22 --probe-name dsProbe_bionic --backend-pool-name dsLbBackEndPool_v6_bionic
{
  "backendAddressPool": {
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v6_bionic",
    "resourceGroup": "xx16resourcegroup"
  },
  "backendPort": 22,
  "disableOutboundSnat": null,
  "enableFloatingIp": false,
  "enableTcpReset": false,
  "etag": "W/\"88dfd91e-72d5-4d57-b934-c618556cded1\"",
  "frontendIpConfiguration": {
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/frontendIPConfigurations/dsLbFrontEnd_v6_bionic",
    "resourceGroup": "xx16resourcegroup"
  },
  "frontendPort": 22,
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/loadBalancingRules/dsLBrule_v6_bionic",
  "idleTimeoutInMinutes": 4,
  "loadDistribution": "Default",
  "name": "dsLBrule_v6_bionic",
  "probe": {
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/probes/dsProbe_bionic",
    "resourceGroup": "xx16resourcegroup"
  },
  "protocol": "Tcp",
  "provisioningState": "Succeeded",
  "resourceGroup": "xx16resourcegroup",
  "type": "Microsoft.Network/loadBalancers/loadBalancingRules"
}
+ az vm availability-set create --name dsAVset_bionic --resource-group xx16resourcegroup --location northeurope --platform-fault-domain-count 2 --platform-update-domain-count 2
{
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Compute/availabilitySets/dsAVset_bionic",
  "location": "northeurope",
  "name": "dsAVset_bionic",
  "platformFaultDomainCount": 2,
  "platformUpdateDomainCount": 2,
  "proximityPlacementGroup": null,
  "resourceGroup": "xx16resourcegroup",
  "sku": {
    "capacity": null,
    "name": "Aligned",
    "tier": null
  },
  "statuses": null,
  "tags": {},
  "type": "Microsoft.Compute/availabilitySets",
  "virtualMachines": []
}
+ az network nic create --name sruscripts-bionic --resource-group xx16resourcegroup --network-security-group sruscripts --vnet-name sruscripts-bionic --accelerated-networking true --subnet sruSubnet --private-ip-address-version IPv4 --lb-address-pools dsLbBackEndPool_v4_bionic --lb-name dsLB_bionic --public-ip-address vmPublicIP-IPv4-bionic
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "53hh4ehfc43etiees5inwecxyb.fx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "dscpConfiguration": null,
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"bebb3524-5ded-46b8-83e1-174e8d368dbf\"",
    "extendedLocation": null,
    "hostedWorkloads": [],
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/networkInterfaces/sruscripts-bionic",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"bebb3524-5ded-46b8-83e1-174e8d368dbf\"",
        "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/networkInterfaces/sruscripts-bionic/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": [
          {
            "backendIpConfigurations": null,
            "etag": null,
            "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v4_bionic",
            "loadBalancerBackendAddresses": null,
            "loadBalancingRules": null,
            "location": null,
            "name": null,
            "outboundRule": null,
            "outboundRules": null,
            "provisioningState": null,
            "resourceGroup": "xx16resourcegroup",
            "type": null
          }
        ],
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "10.0.0.4",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "privateLinkConnectionProperties": null,
        "provisioningState": "Succeeded",
        "publicIpAddress": {
          "ddosSettings": null,
          "dnsSettings": null,
          "etag": null,
          "extendedLocation": null,
          "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/publicIPAddresses/vmPublicIP-IPv4-bionic",
          "idleTimeoutInMinutes": null,
          "ipAddress": null,
          "ipConfiguration": null,
          "ipTags": null,
          "location": null,
          "name": null,
          "provisioningState": null,
          "publicIpAddressVersion": null,
          "publicIpAllocationMethod": null,
          "publicIpPrefix": null,
          "resourceGroup": "xx16resourcegroup",
          "resourceGuid": null,
          "sku": null,
          "tags": null,
          "type": null,
          "zones": null
        },
        "resourceGroup": "xx16resourcegroup",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/virtualNetworks/sruscripts-bionic/subnets/sruSubnet",
          "ipAllocations": null,
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "xx16resourcegroup",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "northeurope",
    "macAddress": null,
    "name": "sruscripts-bionic",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "flowLogs": null,
      "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/networkSecurityGroups/sruscripts",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "xx16resourcegroup",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "xx16resourcegroup",
    "resourceGuid": "512d3c65-923d-4bfd-a0f3-ce3fc86e457f",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic create --name sruscripts2-bionic --resource-group xx16resourcegroup --network-security-group sruscripts --vnet-name sruscripts-bionic --accelerated-networking true --subnet sruSubnet --private-ip-address-version IPv4
{
  "NewNIC": {
    "dnsSettings": {
      "appliedDnsServers": [],
      "dnsServers": [],
      "internalDnsNameLabel": null,
      "internalDomainNameSuffix": "53hh4ehfc43etiees5inwecxyb.fx.internal.cloudapp.net",
      "internalFqdn": null
    },
    "dscpConfiguration": null,
    "enableAcceleratedNetworking": true,
    "enableIpForwarding": false,
    "etag": "W/\"815e40f4-c4cc-4595-b136-e236ae232384\"",
    "extendedLocation": null,
    "hostedWorkloads": [],
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/networkInterfaces/sruscripts2-bionic",
    "ipConfigurations": [
      {
        "applicationGatewayBackendAddressPools": null,
        "applicationSecurityGroups": null,
        "etag": "W/\"815e40f4-c4cc-4595-b136-e236ae232384\"",
        "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/networkInterfaces/sruscripts2-bionic/ipConfigurations/ipconfig1",
        "loadBalancerBackendAddressPools": null,
        "loadBalancerInboundNatRules": null,
        "name": "ipconfig1",
        "primary": true,
        "privateIpAddress": "10.0.0.5",
        "privateIpAddressVersion": "IPv4",
        "privateIpAllocationMethod": "Dynamic",
        "privateLinkConnectionProperties": null,
        "provisioningState": "Succeeded",
        "publicIpAddress": null,
        "resourceGroup": "xx16resourcegroup",
        "subnet": {
          "addressPrefix": null,
          "addressPrefixes": null,
          "delegations": null,
          "etag": null,
          "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/virtualNetworks/sruscripts-bionic/subnets/sruSubnet",
          "ipAllocations": null,
          "ipConfigurationProfiles": null,
          "ipConfigurations": null,
          "name": null,
          "natGateway": null,
          "networkSecurityGroup": null,
          "privateEndpointNetworkPolicies": null,
          "privateEndpoints": null,
          "privateLinkServiceNetworkPolicies": null,
          "provisioningState": null,
          "purpose": null,
          "resourceGroup": "xx16resourcegroup",
          "resourceNavigationLinks": null,
          "routeTable": null,
          "serviceAssociationLinks": null,
          "serviceEndpointPolicies": null,
          "serviceEndpoints": null
        },
        "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
        "virtualNetworkTaps": null
      }
    ],
    "location": "northeurope",
    "macAddress": null,
    "name": "sruscripts2-bionic",
    "networkSecurityGroup": {
      "defaultSecurityRules": null,
      "etag": null,
      "flowLogs": null,
      "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/networkSecurityGroups/sruscripts",
      "location": null,
      "name": null,
      "networkInterfaces": null,
      "provisioningState": null,
      "resourceGroup": "xx16resourcegroup",
      "resourceGuid": null,
      "securityRules": null,
      "subnets": null,
      "tags": null,
      "type": null
    },
    "primary": null,
    "privateEndpoint": null,
    "provisioningState": "Succeeded",
    "resourceGroup": "xx16resourcegroup",
    "resourceGuid": "c1f65c6d-41ff-4fec-b21f-31bfcfccc79f",
    "tags": null,
    "tapConfigurations": [],
    "type": "Microsoft.Network/networkInterfaces",
    "virtualMachine": null
  }
}
+ az network nic ip-config create --name sruscripts-bionic-v6 --nic-name sruscripts-bionic --resource-group xx16resourcegroup --vnet-name sruscripts-bionic --subnet sruSubnet --lb-address-pools dsLbBackEndPool_v6_bionic --lb-name dsLB_bionic --private-ip-address-version IPv6
{
  "applicationGatewayBackendAddressPools": null,
  "applicationSecurityGroups": null,
  "etag": "W/\"e4109290-e827-429c-8213-7f9b83cbed4d\"",
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/networkInterfaces/sruscripts-bionic/ipConfigurations/sruscripts-bionic-v6",
  "loadBalancerBackendAddressPools": [
    {
      "backendIpConfigurations": null,
      "etag": null,
      "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/loadBalancers/dsLB_bionic/backendAddressPools/dsLbBackEndPool_v6_bionic",
      "loadBalancerBackendAddresses": null,
      "loadBalancingRules": null,
      "location": null,
      "name": null,
      "outboundRule": null,
      "outboundRules": null,
      "provisioningState": null,
      "resourceGroup": "xx16resourcegroup",
      "type": null
    }
  ],
  "loadBalancerInboundNatRules": null,
  "name": "sruscripts-bionic-v6",
  "primary": null,
  "privateIpAddress": "ace:cab:deca:deed::4",
  "privateIpAddressVersion": "IPv6",
  "privateIpAllocationMethod": "Dynamic",
  "privateLinkConnectionProperties": null,
  "provisioningState": "Succeeded",
  "publicIpAddress": null,
  "resourceGroup": "xx16resourcegroup",
  "subnet": {
    "addressPrefix": null,
    "addressPrefixes": null,
    "delegations": null,
    "etag": null,
    "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Network/virtualNetworks/sruscripts-bionic/subnets/sruSubnet",
    "ipAllocations": null,
    "ipConfigurationProfiles": null,
    "ipConfigurations": null,
    "name": null,
    "natGateway": null,
    "networkSecurityGroup": null,
    "privateEndpointNetworkPolicies": null,
    "privateEndpoints": null,
    "privateLinkServiceNetworkPolicies": null,
    "provisioningState": null,
    "purpose": null,
    "resourceGroup": "xx16resourcegroup",
    "resourceNavigationLinks": null,
    "routeTable": null,
    "serviceAssociationLinks": null,
    "serviceEndpointPolicies": null,
    "serviceEndpoints": null
  },
  "type": "Microsoft.Network/networkInterfaces/ipConfigurations",
  "virtualNetworkTaps": null
}
+ az vm show --name test-sru-bionic-advanced -g xx16resourcegroup
+ az vm create --name=test-sru-bionic-advanced --image=Canonical:UbuntuServer:18.04-DAILY-LTS:latest --admin-username=root --admin-username=ubuntu -g xx16resourcegroup --ssh-key-value /home/daniel/.ssh/id_rsa.canonical.pub --boot-diagnostics-storage sruscripts --custom-data sethostname.yaml --nics sruscripts-bionic sruscripts2-bionic --size Standard_DS2_v2
{
  "fqdns": "",
  "id": "/subscriptions/9a37cc2c-dc4a-4097-84dd-45dd2b8cbc63/resourceGroups/xx16resourcegroup/providers/Microsoft.Compute/virtualMachines/test-sru-bionic-advanced",
  "location": "northeurope",
  "macAddress": "00-22-48-99-EA-89,00-22-48-9B-61-68",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4,ace:cab:deca:deed::4,10.0.0.5",
  "publicIpAddress": "138.91.52.38",
  "resourceGroup": "xx16resourcegroup",
  "zones": ""
}
++ az vm list-ip-addresses --name test-sru-bionic-advanced
++ jq -r '.[] | .virtualMachine.network.publicIpAddresses[].ipAddress'
++ awk '{printf "ubuntu@%s", $1}'
+ IP=ubuntu@138.91.52.38
+ echo 'Created test-sru-bionic-advanced: ubuntu@ubuntu@138.91.52.38'
Created test-sru-bionic-advanced: ubuntu@ubuntu@138.91.52.38
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init status --wait --long

status: done
time: Wed, 31 Mar 2021 17:27:48 +0000
detail:
DataSourceAzure [seed=/dev/sr0]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- dpkg-query --show cloud-init
cloud-init	20.4.1-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/dev/sr0]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- '!' grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- systemd-analyze
Startup finished in 6.828s (kernel) + 1min 1.318s (userspace) = 1min 8.146s
graphical.target reached after 1min 446ms in userspace
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- systemd-analyze blame
         42.287s cloud-init-local.service
          9.079s cloud-init.service
          2.258s cloud-config.service
          1.960s systemd-networkd-wait-online.service
          1.315s snapd.service
          1.132s lxd-containers.service
          1.071s snapd.seeded.service
           959ms dev-sda1.device
           883ms cloud-final.service
           841ms pollinate.service
           631ms apparmor.service
           349ms networkd-dispatcher.service
           300ms accounts-daemon.service
           252ms grub-common.service
           236ms systemd-udev-trigger.service
           233ms apport.service
           206ms keyboard-setup.service
           190ms rsyslog.service
           168ms systemd-logind.service
           156ms lvm2-monitor.service
           154ms ufw.service
           150ms dev-mqueue.mount
           148ms kmod-static-nodes.service
           147ms systemd-remount-fs.service
           145ms dev-hugepages.mount
           145ms systemd-user-sessions.service
           142ms systemd-modules-load.service
           128ms sys-kernel-debug.mount
           107ms systemd-journald.service
            90ms polkit.service
            79ms lxd.socket
            72ms systemd-random-seed.service
            69ms ssh.service
            68ms sys-fs-fuse-connections.mount
            68ms systemd-tmpfiles-setup-dev.service
            67ms sys-kernel-config.mount
            66ms systemd-sysctl.service
            66ms snapd.socket
            65ms systemd-timesyncd.service
            61ms ebtables.service
            53ms ephemeral-disk-warning.service
            51ms systemd-tmpfiles-setup.service
            43ms systemd-journal-flush.service
            37ms snapd.apparmor.service
            34ms blk-availability.service
            32ms plymouth-read-write.service
            31ms user@1000.service
            30ms systemd-fsck@dev-disk-by\x2duuid-2FBA\x2dC33A.service
            28ms systemd-resolved.service
            27ms systemd-udevd.service
            23ms systemd-networkd.service
            22ms systemd-machine-id-commit.service
            19ms systemd-update-utmp.service
            17ms plymouth-quit-wait.service
            17ms setvtrgb.service
            16ms plymouth-quit.service
            11ms systemd-update-utmp-runlevel.service
            10ms boot-efi.mount
             8ms console-setup.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03300s +00.00100s
|`->get_boot_telemetry @00.03400s +00.01500s
|`->get_system_info @00.04900s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05000s +00.04700s
|`->load_azure_ds_dir @00.09700s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.22400s +00.00000s
Starting stage: azure-ds/_get_preprovisioning_cfgs
|`->_get_preprovisionedvm_cfg_value @00.22500s +00.00000s
|`->_get_preprovisionedvmtype_cfg_value @00.22500s +00.00100s
Finished stage: (azure-ds/_get_preprovisioning_cfgs) 00.00100 seconds

Finished stage: (azure-ds/read_azure_ovf) 00.00500 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00900 seconds

Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.25400s +40.47600s
|`->_get_metadata_from_imds @40.73000s +00.58700s
Finished stage: (azure-ds/get_metadata_from_imds) 41.09000 seconds

|`->_get_random_seed @41.34400s +00.00100s
Finished stage: (azure-ds/crawl_metadata) 41.29500 seconds

|`->maybe_remove_ubuntu_network_config_scripts @41.34600s +00.00000s
|`->write_files @41.34600s +00.00300s
Finished stage: (azure-ds/_get_data) 41.31600 seconds

|`->get_public_ssh_keys @41.35000s +00.00000s
Finished stage: (init-local/search-Azure) 41.32200 seconds

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @41.41000s +00.00100s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Finished stage: (init-local) 41.60000 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/dev/sr0] @44.10200s +00.02100s
Total Time: 206.63900 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.00000s +00.00100s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @00.01300s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @00.01800s +00.20700s
Starting stage: azure-ds/_fetch_goal_state_from_azure
Starting stage: azure-ds/_get_raw_goal_state_xml_from_azure
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @00.22600s +00.00100s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/goalstate-retrieval
|`->http_with_retries @00.22800s +00.01200s
Finished stage: (azure-ds/goalstate-retrieval) 00.01200 seconds

Finished stage: (azure-ds/_get_raw_goal_state_xml_from_azure) 00.01500 seconds

Starting stage: azure-ds/_parse_raw_goal_state_xml
Starting stage: azure-ds/get-certificates-xml
|`->http_with_retries @00.24100s +00.01100s
Finished stage: (azure-ds/get-certificates-xml) 00.01100 seconds

Finished stage: (azure-ds/_parse_raw_goal_state_xml) 00.01200 seconds

Finished stage: (azure-ds/_fetch_goal_state_from_azure) 00.02700 seconds

Starting stage: azure-ds/_get_user_pubkeys
Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @00.25200s +00.01000s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @00.26300s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.11400 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @00.37800s +00.00500s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.13200 seconds

Finished stage: (azure-ds/_get_user_pubkeys) 00.13200 seconds

Starting stage: azure-ds/send_ready_signal
Starting stage: azure-ds/_post_health_report
Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.38400s +00.00100s
Finished stage: (azure-ds/push_log_to_kvp) 00.01100 seconds

|`->http_with_retries @00.39600s +02.58700s
Finished stage: (azure-ds/_post_health_report) 02.59900 seconds

Finished stage: (azure-ds/send_ready_signal) 02.60000 seconds

Finished stage: (azure-ds/register_with_azure_and_fetch_data) 02.96700 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 02.96800 seconds

Finished stage: (azure-ds/_negotiate) 02.97300 seconds

Finished stage: (azure-ds/setup) 02.97300 seconds

Finished stage: (init-network/setup-datasource) 02.97300 seconds

|`->reading and applying user-data @03.00100s +00.00900s
|`->reading and applying vendor-data @03.01000s +00.00100s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
|`->wait for ephemeral disk @03.03600s +00.00000s
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @03.03700s +00.27600s
Starting stage: azure-ds/mount-ntfs-and-count
|`->count_files @03.37600s +00.00200s
Finished stage: (azure-ds/mount-ntfs-and-count) 00.07700 seconds

Finished stage: (azure-ds/can_dev_be_reformatted) 00.35400 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.35500 seconds

Total Time: 21.31800 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.00000s +00.00300s
Finished stage: (azure-ds/push_log_to_kvp) 00.03000 seconds

Finished stage: (azure-ds/activate) 00.38700 seconds

Finished stage: (init-network/activate-datasource) 00.38900 seconds

|`->config-migrator ran successfully @00.06800s +00.00100s
|`->config-seed_random ran successfully @00.06900s +00.00200s
|`->config-bootcmd ran successfully @00.07200s +00.00000s
|`->config-write-files ran successfully @00.07200s +00.00100s
|`->config-growpart ran successfully @00.07400s +00.36100s
|`->config-resizefs ran successfully @00.43600s +02.63800s
|`->config-disk_setup ran successfully @03.07400s +01.27200s
|`->config-mounts ran successfully @04.34700s +00.15100s
|`->config-set_hostname ran successfully @04.49900s +00.00700s
|`->config-update_hostname ran successfully @04.50600s +00.00300s
|`->config-update_etc_hosts ran successfully @04.51000s +00.00000s
|`->config-ca-certs ran successfully @04.51000s +00.00200s
|`->config-rsyslog ran successfully @04.51200s +00.00100s
Starting stage: init-network/config-users-groups
|`->get_public_ssh_keys @04.51500s +00.00000s
Finished stage: (init-network/config-users-groups) 00.21500 seconds

Starting stage: init-network/config-ssh
|`->get_public_ssh_keys @04.88000s +00.00000s
Finished stage: (init-network/config-ssh) 00.16100 seconds

Finished stage: (init-network) 08.38200 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @08.35300s +00.00100s
|`->config-snap ran successfully @08.35400s +00.00200s
|`->config-ssh-import-id ran successfully @08.35700s +00.49800s
|`->config-locale ran successfully @08.85900s +00.00900s
|`->config-set-passwords ran successfully @08.86900s +00.00100s
|`->config-grub-dpkg ran successfully @08.87100s +01.03500s
|`->config-apt-pipelining ran successfully @09.90700s +00.00100s
|`->config-apt-configure ran successfully @09.90900s +00.12900s
|`->config-ubuntu-advantage ran successfully @10.03900s +00.00100s
|`->config-ntp ran successfully @10.04100s +00.00100s
|`->config-timezone ran successfully @10.04200s +00.00100s
|`->config-disable-ec2-metadata ran successfully @10.04400s +00.00000s
|`->config-runcmd ran successfully @10.04400s +00.00200s
|`->config-byobu ran successfully @10.04600s +00.00100s
Finished stage: (modules-config) 01.71000 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @10.70100s +00.00100s
|`->config-fan ran successfully @10.70300s +00.00100s
|`->config-landscape ran successfully @10.70400s +00.00100s
|`->config-lxd ran successfully @10.70600s +00.00000s
|`->config-ubuntu-drivers ran successfully @10.70700s +00.00100s
|`->config-puppet ran successfully @10.70800s +00.00100s
|`->config-chef ran successfully @10.70900s +00.00100s
|`->config-mcollective ran successfully @10.71000s +00.00100s
|`->config-salt-minion ran successfully @10.71200s +00.00100s
|`->config-reset_rmc ran successfully @10.71300s +00.00200s
|`->config-refresh_rmc_and_interface ran successfully @10.71500s +00.00100s
|`->config-rightscale_userdata ran successfully @10.71600s +00.00100s
|`->config-scripts-vendor ran successfully @10.71800s +00.00000s
|`->config-scripts-per-once ran successfully @10.71900s +00.00100s
|`->config-scripts-per-boot ran successfully @10.72000s +00.00000s
|`->config-scripts-per-instance ran successfully @10.72100s +00.00100s
|`->config-scripts-user ran successfully @10.72200s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @10.72300s +00.01000s
|`->config-keys-to-console ran successfully @10.73400s +00.25200s
|`->config-phone-home ran successfully @10.98700s +00.00100s
|`->config-final-message ran successfully @10.98900s +00.00600s
|`->config-power-state-change ran successfully @10.99600s +00.00100s
Finished stage: (modules-final) 00.31500 seconds

Total Time: 11.58900 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init analyze blame
-- Boot Record 01 --
     40.47600s (azure-ds/obtain-dhcp-lease)
     00.58700s (azure-ds/_get_metadata_from_imds)
     00.04700s (azure-ds/list_possible_azure_ds_devs)
     00.02100s (init-network/check-cache)
     00.01500s (azure-ds/get_boot_telemetry)
     00.00300s (azure-ds/write_files)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/check-platform-viability)
     00.00100s (azure-ds/_get_random_seed)
     00.00100s (azure-ds/_get_preprovisionedvmtype_cfg_value)
     00.00100s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_public_ssh_keys)
     00.00000s (azure-ds/_get_preprovisionedvm_cfg_value)

-- Boot Record 02 --
     02.58700s (azure-ds/http_with_retries)
     00.27600s (azure-ds/_has_ntfs_filesystem)
     00.20700s (azure-ds/generate_certificate)
     00.01200s (azure-ds/http_with_retries)
     00.01100s (azure-ds/http_with_retries)
     00.01000s (azure-ds/_decrypt_certs_from_xml)
     00.00900s (init-network/consume-user-data)
     00.00600s (azure-ds/_run_x509_action)
     00.00500s (azure-ds/_run_x509_action)
     00.00200s (azure-ds/count_files)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (azure-ds/get_last_log_byte_pushed_to_kvp_index)
     00.00100s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00000s (azure-ds/wait-for-ephemeral-disk)
     00.00000s (azure-ds/temporary_hostname)

-- Boot Record 03 --
     02.63800s (init-network/config-resizefs)
     01.27200s (init-network/config-disk_setup)
     01.03500s (modules-config/config-grub-dpkg)
     00.49800s (modules-config/config-ssh-import-id)
     00.36100s (init-network/config-growpart)
     00.25200s (modules-final/config-keys-to-console)
     00.15100s (init-network/config-mounts)
     00.12900s (modules-config/config-apt-configure)
     00.01000s (modules-final/config-ssh-authkey-fingerprints)
     00.00900s (modules-config/config-locale)
     00.00700s (init-network/config-set_hostname)
     00.00600s (modules-final/config-final-message)
     00.00300s (init-network/config-update_hostname)
     00.00300s (azure-ds/get_last_log_byte_pushed_to_kvp_index)
     00.00200s (modules-final/config-reset_rmc)
     00.00200s (modules-config/config-snap)
     00.00200s (modules-config/config-runcmd)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-ca-certs)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-once)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-rightscale_userdata)
     00.00100s (modules-final/config-refresh_rmc_and_interface)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-phone-home)
     00.00100s (modules-final/config-package-update-upgrade-install)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-final/config-fan)
     00.00100s (modules-final/config-chef)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00000s (modules-final/config-scripts-vendor)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-lxd)
     00.00000s (modules-config/config-disable-ec2-metadata)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (init-network/config-bootcmd)
     00.00000s (azure-ds/get_public_ssh_keys)
     00.00000s (azure-ds/get_public_ssh_keys)

3 boot records analyzed
+ echo 'Writing networking config: previous-network.out'
Writing networking config: previous-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- grep DHCP /var/log/syslog
+ scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR setup_proposed.sh ubuntu@138.91.52.38:.
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- sudo bash setup_proposed.sh
+ egrep cloud-init
  cloud-init
Get:1 http://archive.ubuntu.com/ubuntu bionic-proposed/main amd64 cloud-init all 21.1-19-gbad84ad4-0ubuntu1~18.04.1 [455 kB]
Preparing to unpack .../cloud-init_21.1-19-gbad84ad4-0ubuntu1~18.04.1_all.deb ...
Unpacking cloud-init (21.1-19-gbad84ad4-0ubuntu1~18.04.1) over (20.4.1-0ubuntu1~18.04.1) ...
Setting up cloud-init (21.1-19-gbad84ad4-0ubuntu1~18.04.1) ...
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- dpkg-query --show cloud-init
cloud-init	21.1-19-gbad84ad4-0ubuntu1~18.04.1
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- sudo hostname SRU-didnt-work
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- sudo rm -f /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- sudo cloud-init clean --logs --reboot
Connection to 138.91.52.38 closed by remote host.
+ true
+ sleep 60
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init status --wait --long

status: done
time: Wed, 31 Mar 2021 17:29:22 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- '!' grep Trace /var/log/cloud-init.log
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- sudo cat /run/cloud-init/result.json
{
 "v1": {
  "datasource": "DataSourceAzure [seed=/var/lib/waagent]",
  "errors": []
 }
}
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- sudo systemd-analyze blame
          2.172s systemd-networkd-wait-online.service
          2.088s cloud-init.service
          1.749s cloud-config.service
          1.746s cloud-init-local.service
          1.125s dev-sdb1.device
           892ms snapd.service
           840ms cloud-final.service
           740ms lxd-containers.service
           699ms networkd-dispatcher.service
           434ms accounts-daemon.service
           380ms grub-common.service
           366ms rsyslog.service
           330ms systemd-logind.service
           311ms ssh.service
           219ms lvm2-monitor.service
           208ms apport.service
           170ms apparmor.service
           157ms systemd-udev-trigger.service
           146ms systemd-modules-load.service
           145ms ufw.service
           143ms systemd-remount-fs.service
           138ms dev-hugepages.mount
           138ms keyboard-setup.service
           138ms blk-availability.service
           125ms systemd-user-sessions.service
           125ms kmod-static-nodes.service
            97ms sys-kernel-debug.mount
            97ms systemd-journal-flush.service
            93ms dev-mqueue.mount
            87ms setvtrgb.service
            82ms ebtables.service
            79ms systemd-timesyncd.service
            78ms polkit.service
            65ms systemd-fsck@dev-disk-by\x2duuid-2FBA\x2dC33A.service
            64ms systemd-journald.service
            59ms systemd-resolved.service
            57ms systemd-udevd.service
            56ms systemd-sysctl.service
            56ms sys-fs-fuse-connections.mount
            54ms systemd-random-seed.service
            54ms sys-kernel-config.mount
            53ms systemd-tmpfiles-setup-dev.service
            36ms plymouth-quit.service
            35ms user@1000.service
            29ms systemd-fsck@dev-disk-cloud-azure_resource\x2dpart1.service
            28ms systemd-networkd.service
            26ms systemd-tmpfiles-setup.service
            26ms snapd.seeded.service
            25ms systemd-update-utmp.service
            23ms boot-efi.mount
            23ms lxd.socket
            21ms console-setup.service
            19ms snapd.socket
            18ms plymouth-read-write.service
            17ms snapd.apparmor.service
            15ms plymouth-quit-wait.service
            14ms systemd-update-utmp-runlevel.service
            13ms ephemeral-disk-warning.service
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init analyze show
-- Boot Record 01 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: init-local
|`->no cache found @00.00400s +00.00100s
Starting stage: init-local/search-Azure
Starting stage: azure-ds/_get_data
|`->found azure asset tag @00.03500s +00.00000s
|`->get_boot_telemetry @00.03600s +00.01500s
|`->get_system_info @00.05100s +00.00100s
Starting stage: azure-ds/crawl_metadata
|`->list_possible_azure_ds_devs @00.05200s +00.19300s
|`->load_azure_ds_dir @00.24500s +00.00100s
Starting stage: azure-ds/load_azure_ds_dir
Starting stage: azure-ds/read_azure_ovf
|`->load_azure_ovf_pubkeys @00.24900s +00.00000s
Starting stage: azure-ds/_get_preprovisioning_cfgs
|`->_get_preprovisionedvm_cfg_value @00.25000s +00.00000s
|`->_get_preprovisionedvmtype_cfg_value @00.25000s +00.00100s
Finished stage: (azure-ds/_get_preprovisioning_cfgs) 00.00100 seconds

Finished stage: (azure-ds/read_azure_ovf) 00.00400 seconds

Finished stage: (azure-ds/load_azure_ds_dir) 00.00500 seconds

Starting stage: azure-ds/get_imds_data_with_api_fallback
Starting stage: azure-ds/get_metadata_from_imds
|`->obtain dhcp lease @00.27300s +00.28700s
|`->_get_metadata_from_imds @00.56100s +00.01100s
Finished stage: (azure-ds/get_metadata_from_imds) 00.35300 seconds

Finished stage: (azure-ds/get_imds_data_with_api_fallback) 00.35400 seconds

|`->_get_random_seed @00.62700s +00.00000s
Finished stage: (azure-ds/crawl_metadata) 00.57600 seconds

|`->maybe_remove_ubuntu_network_config_scripts @00.62800s +00.00000s
|`->write_files @00.62900s +00.00200s
Finished stage: (azure-ds/_get_data) 00.59700 seconds

|`->get_public_ssh_keys @00.63200s +00.00000s
Finished stage: (init-local/search-Azure) 00.60300 seconds

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.69500s +00.00100s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Finished stage: (init-local) 00.85800 seconds

Starting stage: init-network
|`->restored from cache with run check: DataSourceAzure [seed=/var/lib/waagent] @03.58600s +00.02100s
Total Time: 3.35200 seconds

-- Boot Record 02 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/parse_network_config
|`->_generate_network_config_from_imds_metadata @00.00000s +00.00100s
Finished stage: (azure-ds/parse_network_config) 00.00100 seconds

Starting stage: init-network/setup-datasource
Starting stage: azure-ds/setup
Starting stage: azure-ds/_negotiate
Starting stage: azure-ds/bounce_network_with_azure_hostname
|`->temporary_hostname @00.01300s +00.00000s
Finished stage: (azure-ds/bounce_network_with_azure_hostname) 00.00400 seconds

Starting stage: azure-ds/get_metadata_from_fabric
Starting stage: azure-ds/register_with_azure_and_fetch_data
|`->generate_certificate @00.01800s +00.04500s
Starting stage: azure-ds/_fetch_goal_state_from_azure
Starting stage: azure-ds/_get_raw_goal_state_xml_from_azure
Starting stage: azure-ds/find_endpoint
|`->_networkd_get_value_from_leases @00.06400s +00.00200s
Finished stage: (azure-ds/find_endpoint) 00.00200 seconds

Starting stage: azure-ds/goalstate-retrieval
|`->http_with_retries @00.06600s +00.00800s
Finished stage: (azure-ds/goalstate-retrieval) 00.00800 seconds

Finished stage: (azure-ds/_get_raw_goal_state_xml_from_azure) 00.01000 seconds

Starting stage: azure-ds/_parse_raw_goal_state_xml
Starting stage: azure-ds/get-certificates-xml
|`->http_with_retries @00.07500s +00.01100s
Finished stage: (azure-ds/get-certificates-xml) 00.01100 seconds

Finished stage: (azure-ds/_parse_raw_goal_state_xml) 00.01200 seconds

Finished stage: (azure-ds/_fetch_goal_state_from_azure) 00.02200 seconds

Starting stage: azure-ds/_get_user_pubkeys
Starting stage: azure-ds/parse_certificates
|`->_decrypt_certs_from_xml @00.08700s +00.00900s
Starting stage: azure-ds/_get_ssh_key_from_cert
|`->_run_x509_action @00.09700s +00.00600s
Finished stage: (azure-ds/_get_ssh_key_from_cert) 00.02300 seconds

Starting stage: azure-ds/_get_fingerprint_from_cert
|`->_run_x509_action @00.12000s +00.00600s
Finished stage: (azure-ds/_get_fingerprint_from_cert) 00.00600 seconds

Finished stage: (azure-ds/parse_certificates) 00.03900 seconds

Finished stage: (azure-ds/_get_user_pubkeys) 00.04100 seconds

Starting stage: azure-ds/send_ready_signal
Starting stage: azure-ds/_post_health_report
Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.12700s +00.00000s
Finished stage: (azure-ds/push_log_to_kvp) 00.01300 seconds

|`->http_with_retries @00.14100s +00.00600s
Finished stage: (azure-ds/_post_health_report) 00.02000 seconds

Finished stage: (azure-ds/send_ready_signal) 00.02000 seconds

Finished stage: (azure-ds/register_with_azure_and_fetch_data) 00.12900 seconds

Finished stage: (azure-ds/get_metadata_from_fabric) 00.13100 seconds

Finished stage: (azure-ds/_negotiate) 00.13600 seconds

Finished stage: (azure-ds/setup) 00.13700 seconds

Finished stage: (init-network/setup-datasource) 00.13800 seconds

|`->reading and applying user-data @00.16200s +00.00800s
|`->reading and applying vendor-data @00.17000s +00.00100s
|`->reading and applying vendor-data2 @00.17100s +00.00000s
Starting stage: init-network/activate-datasource
Starting stage: azure-ds/activate
Starting stage: azure-ds/address_ephemeral_resize
Starting stage: azure-ds/can_dev_be_reformatted
|`->_has_ntfs_filesystem @00.20100s +00.34700s
Finished stage: (azure-ds/can_dev_be_reformatted) 00.34700 seconds

Finished stage: (azure-ds/address_ephemeral_resize) 00.34800 seconds

Total Time: 1.59800 seconds

-- Boot Record 03 --
The total time elapsed since completing an event is printed after the "@" character.
The time the event takes is printed after the "+" character.

Starting stage: azure-ds/push_log_to_kvp
|`->get_last_log_byte_pushed_to_kvp_index @00.00000s +00.00100s
Finished stage: (azure-ds/push_log_to_kvp) 00.01000 seconds

Finished stage: (azure-ds/activate) 00.35900 seconds

Finished stage: (init-network/activate-datasource) 00.36100 seconds

|`->config-migrator ran successfully @00.02900s +00.00100s
|`->config-seed_random ran successfully @00.03000s +00.00200s
|`->config-bootcmd ran successfully @00.03200s +00.00100s
|`->config-write-files ran successfully @00.03300s +00.00100s
|`->config-growpart ran successfully @00.03500s +00.04300s
|`->config-resizefs ran successfully @00.07900s +00.01400s
|`->config-disk_setup ran successfully @00.09400s +00.12700s
|`->config-mounts ran successfully @00.22200s +00.13900s
|`->config-set_hostname ran successfully @00.36200s +00.00700s
|`->config-update_hostname ran successfully @00.36900s +00.00200s
|`->config-update_etc_hosts ran successfully @00.37200s +00.00000s
|`->config-ca-certs ran successfully @00.37200s +00.00200s
|`->config-rsyslog ran successfully @00.37500s +00.00100s
Starting stage: init-network/config-users-groups
|`->get_public_ssh_keys @00.37700s +00.00100s
Finished stage: (init-network/config-users-groups) 00.51000 seconds

Starting stage: init-network/config-ssh
|`->get_public_ssh_keys @00.96900s +00.00000s
Finished stage: (init-network/config-ssh) 00.08700 seconds

Finished stage: (init-network) 01.61100 seconds

Starting stage: modules-config
|`->config-emit_upstart ran successfully @02.70400s +00.00100s
|`->config-snap ran successfully @02.70600s +00.00100s
|`->config-ssh-import-id ran successfully @02.70700s +00.44600s
|`->config-locale ran successfully @03.15400s +00.00800s
|`->config-set-passwords ran successfully @03.16300s +00.00100s
|`->config-grub-dpkg ran successfully @03.16500s +00.39000s
|`->config-apt-pipelining ran successfully @03.55700s +00.00100s
|`->config-apt-configure ran successfully @03.55900s +00.24100s
|`->config-ubuntu-advantage ran successfully @03.80200s +00.00100s
|`->config-ntp ran successfully @03.80300s +00.00100s
|`->config-timezone ran successfully @03.80500s +00.00100s
|`->config-disable-ec2-metadata ran successfully @03.80600s +00.00100s
|`->config-runcmd ran successfully @03.80700s +00.00100s
|`->config-byobu ran successfully @03.80900s +00.00100s
Finished stage: (modules-config) 01.12900 seconds

Starting stage: modules-final
|`->config-package-update-upgrade-install ran successfully @04.41200s +00.00200s
|`->config-fan ran successfully @04.41400s +00.00200s
|`->config-landscape ran successfully @04.41600s +00.00100s
|`->config-lxd ran successfully @04.41700s +00.00100s
|`->config-ubuntu-drivers ran successfully @04.41900s +00.00100s
|`->config-puppet ran successfully @04.42100s +00.00100s
|`->config-chef ran successfully @04.42200s +00.00000s
|`->config-mcollective ran successfully @04.42300s +00.00100s
|`->config-salt-minion ran successfully @04.42500s +00.00100s
|`->config-reset_rmc ran successfully @04.42700s +00.00100s
|`->config-refresh_rmc_and_interface ran successfully @04.42800s +00.00100s
|`->config-rightscale_userdata ran successfully @04.42900s +00.00200s
|`->config-scripts-vendor ran successfully @04.43100s +00.00100s
|`->config-scripts-per-once ran successfully @04.43200s +00.00200s
|`->config-scripts-per-boot ran successfully @04.43400s +00.00000s
|`->config-scripts-per-instance ran successfully @04.43500s +00.00100s
|`->config-scripts-user ran successfully @04.43700s +00.00100s
|`->config-ssh-authkey-fingerprints ran successfully @04.43800s +00.14500s
|`->config-keys-to-console ran successfully @04.58400s +00.09600s
|`->config-phone-home ran successfully @04.68100s +00.00200s
|`->config-final-message ran successfully @04.68400s +00.00600s
|`->config-power-state-change ran successfully @04.69100s +00.00100s
Finished stage: (modules-final) 00.30000 seconds

Total Time: 4.36700 seconds

3 boot records analyzed
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init analyze blame
-- Boot Record 01 --
     00.28700s (azure-ds/obtain-dhcp-lease)
     00.19300s (azure-ds/list_possible_azure_ds_devs)
     00.02100s (init-network/check-cache)
     00.01500s (azure-ds/get_boot_telemetry)
     00.01100s (azure-ds/_get_metadata_from_imds)
     00.00200s (azure-ds/write_files)
     00.00100s (init-local/check-cache)
     00.00100s (azure-ds/load_azure_ds_dir)
     00.00100s (azure-ds/get_system_info)
     00.00100s (azure-ds/_get_preprovisionedvmtype_cfg_value)
     00.00100s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00000s (azure-ds/maybe_remove_ubuntu_network_config_scripts)
     00.00000s (azure-ds/load_azure_ovf_pubkeys)
     00.00000s (azure-ds/get_public_ssh_keys)
     00.00000s (azure-ds/check-platform-viability)
     00.00000s (azure-ds/_get_random_seed)
     00.00000s (azure-ds/_get_preprovisionedvm_cfg_value)

-- Boot Record 02 --
     00.34700s (azure-ds/_has_ntfs_filesystem)
     00.04500s (azure-ds/generate_certificate)
     00.01100s (azure-ds/http_with_retries)
     00.00900s (azure-ds/_decrypt_certs_from_xml)
     00.00800s (init-network/consume-user-data)
     00.00800s (azure-ds/http_with_retries)
     00.00600s (azure-ds/http_with_retries)
     00.00600s (azure-ds/_run_x509_action)
     00.00600s (azure-ds/_run_x509_action)
     00.00200s (azure-ds/_networkd_get_value_from_leases)
     00.00100s (init-network/consume-vendor-data)
     00.00100s (azure-ds/_generate_network_config_from_imds_metadata)
     00.00000s (init-network/consume-vendor-data2)
     00.00000s (azure-ds/temporary_hostname)
     00.00000s (azure-ds/get_last_log_byte_pushed_to_kvp_index)

-- Boot Record 03 --
     00.44600s (modules-config/config-ssh-import-id)
     00.39000s (modules-config/config-grub-dpkg)
     00.24100s (modules-config/config-apt-configure)
     00.14500s (modules-final/config-ssh-authkey-fingerprints)
     00.13900s (init-network/config-mounts)
     00.12700s (init-network/config-disk_setup)
     00.09600s (modules-final/config-keys-to-console)
     00.04300s (init-network/config-growpart)
     00.01400s (init-network/config-resizefs)
     00.00800s (modules-config/config-locale)
     00.00700s (init-network/config-set_hostname)
     00.00600s (modules-final/config-final-message)
     00.00200s (modules-final/config-scripts-per-once)
     00.00200s (modules-final/config-rightscale_userdata)
     00.00200s (modules-final/config-phone-home)
     00.00200s (modules-final/config-package-update-upgrade-install)
     00.00200s (modules-final/config-fan)
     00.00200s (init-network/config-update_hostname)
     00.00200s (init-network/config-seed_random)
     00.00200s (init-network/config-ca-certs)
     00.00100s (modules-final/config-ubuntu-drivers)
     00.00100s (modules-final/config-scripts-vendor)
     00.00100s (modules-final/config-scripts-user)
     00.00100s (modules-final/config-scripts-per-instance)
     00.00100s (modules-final/config-salt-minion)
     00.00100s (modules-final/config-reset_rmc)
     00.00100s (modules-final/config-refresh_rmc_and_interface)
     00.00100s (modules-final/config-puppet)
     00.00100s (modules-final/config-power-state-change)
     00.00100s (modules-final/config-mcollective)
     00.00100s (modules-final/config-lxd)
     00.00100s (modules-final/config-landscape)
     00.00100s (modules-config/config-ubuntu-advantage)
     00.00100s (modules-config/config-timezone)
     00.00100s (modules-config/config-snap)
     00.00100s (modules-config/config-set-passwords)
     00.00100s (modules-config/config-runcmd)
     00.00100s (modules-config/config-ntp)
     00.00100s (modules-config/config-emit_upstart)
     00.00100s (modules-config/config-disable-ec2-metadata)
     00.00100s (modules-config/config-byobu)
     00.00100s (modules-config/config-apt-pipelining)
     00.00100s (init-network/config-write-files)
     00.00100s (init-network/config-rsyslog)
     00.00100s (init-network/config-migrator)
     00.00100s (init-network/config-bootcmd)
     00.00100s (azure-ds/get_public_ssh_keys)
     00.00100s (azure-ds/get_last_log_byte_pushed_to_kvp_index)
     00.00000s (modules-final/config-scripts-per-boot)
     00.00000s (modules-final/config-chef)
     00.00000s (init-network/config-update_etc_hosts)
     00.00000s (azure-ds/get_public_ssh_keys)

3 boot records analyzed
+ echo 'After upgrade write network config: upgrade-network.out'
After upgrade write network config: upgrade-network.out
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cat /etc/netplan/50-cloud-init.yaml
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- ip -4 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- ip -4 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- ip -6 route
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- ip -6 addr
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- grep DHCP /var/log/syslog
+ echo '------- Diff previous-network to post-upgrade-network ------'
------- Diff previous-network to post-upgrade-network ------
+ diff -urN previous-network.out upgrade-network.out
--- previous-network.out	2021-03-31 13:28:23.816666385 -0400
+++ upgrade-network.out	2021-03-31 13:30:17.530339370 -0400
@@ -27,8 +27,8 @@
             set-name: eth1
     version: 2
 default via 10.0.0.1 dev eth0 proto dhcp src 10.0.0.4 metric 100 
-10.0.0.0/24 dev eth1 proto kernel scope link src 10.0.0.5 
 10.0.0.0/24 dev eth0 proto kernel scope link src 10.0.0.4 
+10.0.0.0/24 dev eth1 proto kernel scope link src 10.0.0.5 
 168.63.129.16 via 10.0.0.1 dev eth0 proto dhcp src 10.0.0.4 metric 100 
 169.254.169.254 via 10.0.0.1 dev eth0 proto dhcp src 10.0.0.4 metric 100 
 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
@@ -42,15 +42,15 @@
        valid_lft forever preferred_lft forever
 ::1 dev lo proto kernel metric 256 pref medium
 ace:cab:deca:deed::/64 dev eth0 proto ra metric 100 pref medium
-fe80::/64 dev eth1 proto kernel metric 256 pref medium
 fe80::/64 dev eth0 proto kernel metric 256 pref medium
+fe80::/64 dev eth1 proto kernel metric 256 pref medium
 default via fe80::1234:5678:9abc dev eth0 proto ra metric 100 pref medium
 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 state UNKNOWN qlen 1000
     inet6 ::1/128 scope host 
        valid_lft forever preferred_lft forever
 2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 state UP qlen 1000
     inet6 ace:cab:deca:deed::4/128 scope global dynamic noprefixroute 
-       valid_lft 17279951sec preferred_lft 8639951sec
+       valid_lft 17279941sec preferred_lft 8639941sec
     inet6 fe80::222:48ff:fe99:ea89/64 scope link 
        valid_lft forever preferred_lft forever
 3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 state UP qlen 1000
@@ -69,3 +69,12 @@
 Mar 31 17:27:42 SRU-worked-azure systemd-networkd[801]: eth1: DHCP: No routes received from DHCP server: No data available
 Mar 31 17:27:42 SRU-worked-azure systemd-networkd[801]: eth0: DHCPv4 address 10.0.0.4/24 via 10.0.0.1
 Mar 31 17:27:42 SRU-worked-azure systemd-networkd[801]: eth0: DHCPv6 address ace:cab:deca:deed::4/128 timeout preferred 8640000 valid 17280000
+Mar 31 17:29:18 SRU-worked-azure dhclient[823]: Internet Systems Consortium DHCP Client 4.3.5
+Mar 31 17:29:18 SRU-worked-azure dhclient[823]: DHCPDISCOVER on eth0 to 255.255.255.255 port 67 interval 3 (xid=0x9492963)
+Mar 31 17:29:18 SRU-worked-azure dhclient[823]: DHCPREQUEST of 10.0.0.4 on eth0 to 255.255.255.255 port 67 (xid=0x63294909)
+Mar 31 17:29:18 SRU-worked-azure dhclient[823]: DHCPOFFER of 10.0.0.4 from 168.63.129.16
+Mar 31 17:29:18 SRU-worked-azure dhclient[823]: DHCPACK of 10.0.0.4 from 168.63.129.16
+Mar 31 17:29:18 SRU-worked-azure systemd-networkd[850]: eth0: DHCPv4 address 10.0.0.4/24 via 10.0.0.1
+Mar 31 17:29:18 SRU-worked-azure systemd-networkd[850]: eth1: DHCPv4 address 10.0.0.5/24
+Mar 31 17:29:18 SRU-worked-azure systemd-networkd[850]: eth1: DHCP: No routes received from DHCP server: No data available
+Mar 31 17:29:18 SRU-worked-azure systemd-networkd[850]: eth0: DHCPv6 address ace:cab:deca:deed::4/128 timeout preferred 8640000 valid 17280000
+ true
+ echo '------- Diff previous-network to post-upgrade-network ------'
------- Diff previous-network to post-upgrade-network ------
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init query --format ''\''cloud-region: {{cloud_name}}-{{region}}'\'''
cloud-region: azure-northeurope
+ echo 'Get cloud-id'
Get cloud-id
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-id
azure
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init query --format ''\''cloud-region: {{cloud_name}}-{{ds.meta_data.imds.compute.location}}'\'''
cloud-region: azure-northeurope
+ echo 'Validating whether metadata is being updated per boot LP:1819913. Expect last log to be System Boot'
Validating whether metadata is being updated per boot LP:1819913. Expect last log to be System Boot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- sudo reboot
Connection to 138.91.52.38 closed by remote host.
+ true
+ sleep 30
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- cloud-init status --wait --long

status: done
time: Wed, 31 Mar 2021 17:30:47 +0000
detail:
DataSourceAzure [seed=/var/lib/waagent]
+ echo 'After reboot'
After reboot
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- 'grep '\''Update datasource'\'' /var/log/cloud-init.log'
2021-03-31 17:29:13,331 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2021-03-31 17:30:41,589 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: New instance first boot
2021-03-31 17:30:42,106 - __init__.py[DEBUG]: Update datasource metadata and network config due to events: System boot
+ echo 'Validate https://github.com/canonical/cloud-init/commit/22e683df'
Validate https://github.com/canonical/cloud-init/commit/22e683df
+ echo 'Azure needs to use __builtin__ agent by default on all releases'
Azure needs to use __builtin__ agent by default on all releases
+ ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR ubuntu@138.91.52.38 -- 'egrep '\''fabric'\'' /var/log/cloud-init.log'
2021-03-31 17:29:16,971 - DataSourceAzure.py[DEBUG]: negotiating with fabric via agent command __builtin__
2021-03-31 17:29:16,971 - handlers.py[DEBUG]: start: azure-ds/get_metadata_from_fabric: get_metadata_from_fabric
2021-03-31 17:29:16,972 - azure.py[DEBUG]: Generating certificate for communication with fabric...
2021-03-31 17:29:17,081 - azure.py[DEBUG]: Reporting ready to Azure fabric.
2021-03-31 17:29:17,095 - azure.py[DEBUG]: Sending health report to Azure fabric.
2021-03-31 17:29:17,101 - azure.py[DEBUG]: Successfully sent health report to Azure fabric
2021-03-31 17:29:17,101 - azure.py[INFO]: Reported ready to Azure fabric.
2021-03-31 17:29:17,102 - handlers.py[DEBUG]: finish: azure-ds/get_metadata_from_fabric: SUCCESS: get_metadata_from_fabric
2021-03-31 17:30:44,701 - DataSourceAzure.py[DEBUG]: negotiating with fabric via agent command __builtin__
2021-03-31 17:30:44,701 - handlers.py[DEBUG]: start: azure-ds/get_metadata_from_fabric: get_metadata_from_fabric
2021-03-31 17:30:44,702 - azure.py[DEBUG]: Generating certificate for communication with fabric...
2021-03-31 17:30:44,837 - azure.py[DEBUG]: Reporting ready to Azure fabric.
2021-03-31 17:30:44,853 - azure.py[DEBUG]: Sending health report to Azure fabric.
2021-03-31 17:30:44,861 - azure.py[DEBUG]: Successfully sent health report to Azure fabric
2021-03-31 17:30:44,862 - azure.py[INFO]: Reported ready to Azure fabric.
2021-03-31 17:30:44,863 - handlers.py[DEBUG]: finish: azure-ds/get_metadata_from_fabric: SUCCESS: get_metadata_from_fabric
+ echo '### END bionic'
### END bionic
