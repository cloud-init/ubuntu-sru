https://github.com/canonical/cloud-init/commit/ced836e6

=== Begin SRU Template ===
[Impact]
When reading partition tables, prefer the partprobe command if it is available
rather than blkdev as blkdev is more fragile.

[Test Case]
There is an upstream test for this bug:
https://github.com/canonical/cloud-init/blob/master/tests/integration_tests/bugs/test_lp1920939.py

=== Bionic ===
(one test doesn't run on Bionic)

============================= test session starts ==============================
platform linux -- Python 3.5.10, pytest-6.1.2, py-1.10.0, pluggy-0.13.1
rootdir: /home/james/cloud-init-tests, configfile: tox.ini
plugins: cov-2.11.1
collected 2 items

tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_when_mounted Detected image: image_id=bionic os=ubuntu release=bionic

-------------------------------- live log setup --------------------------------
2021-05-14 20:56:35 INFO      integration_testing:clouds.py:88 Detected image: image_id=bionic os=ubuntu release=bionic
SKIPPED
tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_no_partprobe Detected image: image_id=bionic os=ubuntu release=bionic

-------------------------------- live log setup --------------------------------
2021-05-14 20:56:35 INFO      integration_testing:clouds.py:88 Detected image: image_id=bionic os=ubuntu release=bionic
Detected image: image_id=bionic os=ubuntu release=bionic
2021-05-14 20:56:35 INFO      integration_testing:clouds.py:88 Detected image: image_id=bionic os=ubuntu release=bionic
Settings:
CLOUD_INIT_SOURCE=PROPOSED
COLLECT_LOGS=ALWAYS
EXISTING_INSTANCE_ID=None
INSTANCE_TYPE=None
KEEP_IMAGE=False
KEEP_INSTANCE=False
KEYPAIR_NAME=None
LOCAL_LOG_PATH=/tmp/cloud_init_test_logs
OPENSTACK_NETWORK=falcojr_admin_net
OS_IMAGE=bionic
PLATFORM=lxd_vm
PUBLIC_SSH_KEY=None
RUN_UNSTABLE=False
2021-05-14 20:56:41 INFO      integration_testing:clouds.py:129 Settings:
CLOUD_INIT_SOURCE=PROPOSED
COLLECT_LOGS=ALWAYS
EXISTING_INSTANCE_ID=None
INSTANCE_TYPE=None
KEEP_IMAGE=False
KEEP_INSTANCE=False
KEYPAIR_NAME=None
LOCAL_LOG_PATH=/tmp/cloud_init_test_logs
OPENSTACK_NETWORK=falcojr_admin_net
OS_IMAGE=bionic
PLATFORM=lxd_vm
PUBLIC_SSH_KEY=None
RUN_UNSTABLE=False
Setting up environment for lxd_vm
2021-05-14 20:56:41 INFO      integration_testing:conftest.py:156 Setting up environment for lxd_vm
Launching instance with launch_kwargs:
user_data=None
image_id=ubuntu:4fb318cb190fc599b788584d5088c8a64bb32bbc5d8a429cac60263bddf4c7f5
2021-05-14 20:56:41 INFO      integration_testing:clouds.py:168 Launching instance with launch_kwargs:
user_data=None
image_id=ubuntu:4fb318cb190fc599b788584d5088c8a64bb32bbc5d8a429cac60263bddf4c7f5
The profile named pycloudlib-vm-bionic-v2 already exists
['lxc', 'init', 'ubuntu:4fb318cb190fc599b788584d5088c8a64bb32bbc5d8a429cac60263bddf4c7f5', '--profile', 'pycloudlib-vm-bionic-v2', '--config', 'user.meta-data=public-keys: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJMS8gdKw0kA1PDwAVkURrxgjbAgWVeiBq+VSOI1jFLafONDwkc0ZVriZofmCZ1BVjixCA6kqVQsmA88Av7eeI3jGvy4fwX+TKhDQk28rRC9mNz8nBLfB+gp3wfcgFJrVeekhjV+fgxiyq1wJC4WcJZfXKdXvsNTBzhd2RNZAsyKyRKBRahv57/KJjXozS94p83l0qq/gi6pYYBTTkLz65SiyVCUpkddgXDPfxEXqjsx6ha3VCdoKBdRgh3p2toADzcYafyqxDMPtfLJE+BofSA4Gi9YQAMhshdk4tzI+KYcq07cd8AtreXpVyZLC3r7cfe4m2IK7UvVSbTItYoUItN255P1M09eLQNlbbrJwnxuX3IUwxBkYZhVUIaEOQreWTnc+tg20ZK3olUzNWcJBurpeT5i6Hg/QoRrQSanVLFx8hff4l1V9Yxb23txlv9e2Pzh0i/0YVmrVlQxuen/5YyWNm553D1EfH8fEon3xVAqrbC8NS63GaP0QhGo7rlYs= james@newt\n', '--vm']
2021-05-14 20:56:44 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 20:57:09 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.254
Retrying SSH connection to ubuntu@10.37.179.254:22 (575s left)
2021-05-14 20:57:10 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.254
Retrying SSH connection to ubuntu@10.37.179.254:22 (573s left)
2021-05-14 20:57:11 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_7.6p1)
2021-05-14 20:57:11 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 20:57:12 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
Launched instance: LXDInstance(name=genuine-tahr)
2021-05-14 20:57:18 INFO      integration_testing:clouds.py:173 Launched instance: LXDInstance(name=genuine-tahr)
2021-05-14 20:57:18 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init --version'
2021-05-14 20:57:18 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_7.6p1)
2021-05-14 20:57:18 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 20:57:18 ERROR     paramiko.transport:transport.py:1819 Socket exception: Connection reset by peer (104)
2021-05-14 20:57:19 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.254
Retrying SSH connection to ubuntu@10.37.179.254:22 (598s left)
2021-05-14 20:57:52 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_7.6p1)
2021-05-14 20:57:52 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
cloud-init version: /usr/bin/cloud-init 21.1-19-gbad84ad4-0ubuntu1~18.04.2
2021-05-14 20:57:53 INFO      integration_testing:clouds.py:179 cloud-init version: /usr/bin/cloud-init 21.1-19-gbad84ad4-0ubuntu1~18.04.2
2021-05-14 20:57:53 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'grep serial /etc/cloud/build.info'
image serial: 20210512
2021-05-14 20:57:53 INFO      integration_testing:clouds.py:183 image serial: 20210512
Installing proposed image
2021-05-14 20:57:53 INFO      integration_testing:instances.py:144 Installing proposed image
2021-05-14 20:57:53 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'echo deb "http://archive.ubuntu.com/ubuntu $(lsb_release -sc)-proposed main" | tee /etc/apt/sources.list.d/proposed.list
apt-get update -q
apt-get install -qy cloud-init'
2021-05-14 20:58:07 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init -v'
Installed cloud-init version: 21.2-3-g899bfaa9-0ubuntu2~18.04.1
2021-05-14 20:58:07 INFO      integration_testing:instances.py:136 Installed cloud-init version: 21.2-3-g899bfaa9-0ubuntu2~18.04.1
2021-05-14 20:58:07 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 20:58:07 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
2021-05-14 20:58:07 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 20:58:08 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
2021-05-14 20:58:08 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 20:58:08 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
Created new image: local:genuine-tahr-snapshot
2021-05-14 20:59:25 INFO      integration_testing:instances.py:113 Created new image: local:genuine-tahr-snapshot
Done with environment setup
2021-05-14 20:59:25 INFO      integration_testing:conftest.py:162 Done with environment setup
Launching instance with launch_kwargs:
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

image_id=local:genuine-tahr-snapshot
2021-05-14 20:59:25 INFO      integration_testing:clouds.py:168 Launching instance with launch_kwargs:
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

image_id=local:genuine-tahr-snapshot
['lxc', 'init', 'local:genuine-tahr-snapshot', '--profile', 'pycloudlib-vm-bionic-v2', '--config', 'user.meta-data=public-keys: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJMS8gdKw0kA1PDwAVkURrxgjbAgWVeiBq+VSOI1jFLafONDwkc0ZVriZofmCZ1BVjixCA6kqVQsmA88Av7eeI3jGvy4fwX+TKhDQk28rRC9mNz8nBLfB+gp3wfcgFJrVeekhjV+fgxiyq1wJC4WcJZfXKdXvsNTBzhd2RNZAsyKyRKBRahv57/KJjXozS94p83l0qq/gi6pYYBTTkLz65SiyVCUpkddgXDPfxEXqjsx6ha3VCdoKBdRgh3p2toADzcYafyqxDMPtfLJE+BofSA4Gi9YQAMhshdk4tzI+KYcq07cd8AtreXpVyZLC3r7cfe4m2IK7UvVSbTItYoUItN255P1M09eLQNlbbrJwnxuX3IUwxBkYZhVUIaEOQreWTnc+tg20ZK3olUzNWcJBurpeT5i6Hg/QoRrQSanVLFx8hff4l1V9Yxb23txlv9e2Pzh0i/0YVmrVlQxuen/5YyWNm553D1EfH8fEon3xVAqrbC8NS63GaP0QhGo7rlYs= james@newt\n', '--config', 'user.user-data=#cloud-config\ndisk_setup:\n  /dev/sdb:\n    table_type: mbr\n    layout: [50, 50]\n    overwrite: True\nfs_setup:\n  - label: test\n    device: /dev/sdb1\n    filesystem: ext4\n  - label: test2\n    device: /dev/sdb2\n    filesystem: ext4\nmounts:\n- ["/dev/sdb1", "/mnt1"]\n- ["/dev/sdb2", "/mnt2"]\n', '--vm']
Running callback specified by 'lxd_setup' mark
2021-05-14 21:00:37 INFO      integration_testing:clouds.py:314 Running callback specified by 'lxd_setup' mark
2021-05-14 21:00:38 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:01:26 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.70
Retrying SSH connection to ubuntu@10.37.179.70:22 (552s left)
2021-05-14 21:01:27 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.70
Retrying SSH connection to ubuntu@10.37.179.70:22 (550s left)
2021-05-14 21:01:29 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_7.6p1)
2021-05-14 21:01:29 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:01:30 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
Launched instance: LXDInstance(name=gorgeous-hog)
2021-05-14 21:01:34 INFO      integration_testing:clouds.py:173 Launched instance: LXDInstance(name=gorgeous-hog)
2021-05-14 21:01:34 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init --version'
cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~18.04.1
2021-05-14 21:01:35 INFO      integration_testing:clouds.py:179 cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~18.04.1
2021-05-14 21:01:35 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'grep serial /etc/cloud/build.info'
image serial: 20210512
2021-05-14 21:01:35 INFO      integration_testing:clouds.py:183 image serial: 20210512
-------------------------------- live log call ---------------------------------
2021-05-14 21:01:35 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'rm $(which partprobe)'
2021-05-14 21:01:35 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init clean --logs'
Restarting instance and waiting for boot
2021-05-14 21:01:35 INFO      integration_testing:instances.py:65 Restarting instance and waiting for boot
2021-05-14 21:01:36 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:02:08 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_7.6p1)
2021-05-14 21:02:08 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:02:09 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
2021-05-14 21:02:13 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cat /var/log/cloud-init.log'
2021-05-14 21:02:13 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'lsblk --json'
PASSED
------------------------------ live log teardown -------------------------------
2021-05-14 21:02:13 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init collect-logs -u -t /var/tmp/cloud-init.tar.gz'
Writing logs to /tmp/cloud_init_test_logs/210514155635/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_no_partprobe
2021-05-14 21:02:14 INFO      integration_testing:conftest.py:192 Writing logs to /tmp/cloud_init_test_logs/210514155635/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_no_partprobe
2021-05-14 21:02:14 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'cp /var/tmp/cloud-init.tar.gz /var/tmp/509f56a3-c6be-47b4-8003-c4083e2dc734.tmp'
2021-05-14 21:02:14 INFO      paramiko.transport.sftp:sftp.py:158 [chan 6] Opened sftp connection (server version 3)
Deleting snapshot image created for this testrun: local:genuine-tahr-snapshot
2021-05-14 21:02:14 INFO      integration_testing:clouds.py:204 Deleting snapshot image created for this testrun: local:genuine-tahr-snapshot


=============================== warnings summary ===============================
../envs/cloud-init/lib/python3.5/site-packages/jwt/utils.py:8
  /home/james/envs/cloud-init/lib/python3.5/site-packages/jwt/utils.py:8: CryptographyDeprecationWarning: Python 3.5 support will be dropped in the next release of cryptography. Please upgrade your Python.
    from cryptography.hazmat.primitives.asymmetric.utils import (

tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_no_partprobe
  /home/james/envs/cloud-init/lib/python3.5/site-packages/simplestreams/mirrors/__init__.py:207: DeprecationWarning: The 'warn' method is deprecated, use 'warning' instead
    self.prefix, path)

-- Docs: https://docs.pytest.org/en/stable/warnings.html
============= 1 passed, 1 skipped, 2 warnings in 339.62s (0:05:39) =============


=== Focal ===
============================= test session starts ==============================
platform linux -- Python 3.5.10, pytest-6.1.2, py-1.10.0, pluggy-0.13.1
rootdir: /home/james/cloud-init-tests, configfile: tox.ini
plugins: cov-2.11.1
collected 2 items

tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_when_mounted Detected image: image_id=focal os=ubuntu release=focal

-------------------------------- live log setup --------------------------------
2021-05-14 21:20:38 INFO      integration_testing:clouds.py:88 Detected image: image_id=focal os=ubuntu release=focal
Detected image: image_id=focal os=ubuntu release=focal
2021-05-14 21:20:38 INFO      integration_testing:clouds.py:88 Detected image: image_id=focal os=ubuntu release=focal
Settings:
CLOUD_INIT_SOURCE=PROPOSED
COLLECT_LOGS=ALWAYS
EXISTING_INSTANCE_ID=None
INSTANCE_TYPE=None
KEEP_IMAGE=False
KEEP_INSTANCE=False
KEYPAIR_NAME=None
LOCAL_LOG_PATH=/tmp/cloud_init_test_logs
OPENSTACK_NETWORK=falcojr_admin_net
OS_IMAGE=focal
PLATFORM=lxd_vm
PUBLIC_SSH_KEY=None
RUN_UNSTABLE=False
2021-05-14 21:20:44 INFO      integration_testing:clouds.py:129 Settings:
CLOUD_INIT_SOURCE=PROPOSED
COLLECT_LOGS=ALWAYS
EXISTING_INSTANCE_ID=None
INSTANCE_TYPE=None
KEEP_IMAGE=False
KEEP_INSTANCE=False
KEYPAIR_NAME=None
LOCAL_LOG_PATH=/tmp/cloud_init_test_logs
OPENSTACK_NETWORK=falcojr_admin_net
OS_IMAGE=focal
PLATFORM=lxd_vm
PUBLIC_SSH_KEY=None
RUN_UNSTABLE=False
Setting up environment for lxd_vm
2021-05-14 21:20:44 INFO      integration_testing:conftest.py:156 Setting up environment for lxd_vm
Launching instance with launch_kwargs:
user_data=None
image_id=ubuntu:f217de8a505d919f42cac6a898ac66fdf582b8ccc092d73189b46101615f3612
2021-05-14 21:20:44 INFO      integration_testing:clouds.py:168 Launching instance with launch_kwargs:
user_data=None
image_id=ubuntu:f217de8a505d919f42cac6a898ac66fdf582b8ccc092d73189b46101615f3612
The profile named pycloudlib-vm-focal-v2 already exists
['lxc', 'init', 'ubuntu:f217de8a505d919f42cac6a898ac66fdf582b8ccc092d73189b46101615f3612', '--profile', 'pycloudlib-vm-focal-v2', '--config', 'user.meta-data=public-keys: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJMS8gdKw0kA1PDwAVkURrxgjbAgWVeiBq+VSOI1jFLafONDwkc0ZVriZofmCZ1BVjixCA6kqVQsmA88Av7eeI3jGvy4fwX+TKhDQk28rRC9mNz8nBLfB+gp3wfcgFJrVeekhjV+fgxiyq1wJC4WcJZfXKdXvsNTBzhd2RNZAsyKyRKBRahv57/KJjXozS94p83l0qq/gi6pYYBTTkLz65SiyVCUpkddgXDPfxEXqjsx6ha3VCdoKBdRgh3p2toADzcYafyqxDMPtfLJE+BofSA4Gi9YQAMhshdk4tzI+KYcq07cd8AtreXpVyZLC3r7cfe4m2IK7UvVSbTItYoUItN255P1M09eLQNlbbrJwnxuX3IUwxBkYZhVUIaEOQreWTnc+tg20ZK3olUzNWcJBurpeT5i6Hg/QoRrQSanVLFx8hff4l1V9Yxb23txlv9e2Pzh0i/0YVmrVlQxuen/5YyWNm553D1EfH8fEon3xVAqrbC8NS63GaP0QhGo7rlYs= james@newt\n', '--vm']
2021-05-14 21:20:47 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:21:10 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.197
Retrying SSH connection to ubuntu@10.37.179.197:22 (577s left)
2021-05-14 21:21:11 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.197
Retrying SSH connection to ubuntu@10.37.179.197:22 (575s left)
2021-05-14 21:21:14 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.197
Retrying SSH connection to ubuntu@10.37.179.197:22 (573s left)
2021-05-14 21:21:16 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.197
Retrying SSH connection to ubuntu@10.37.179.197:22 (571s left)
2021-05-14 21:21:18 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.197
Retrying SSH connection to ubuntu@10.37.179.197:22 (568s left)
2021-05-14 21:21:20 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.197
Retrying SSH connection to ubuntu@10.37.179.197:22 (567s left)
2021-05-14 21:21:21 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.2p1)
2021-05-14 21:21:21 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:21:22 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
Launched instance: LXDInstance(name=enjoyed-lioness)
2021-05-14 21:21:25 INFO      integration_testing:clouds.py:173 Launched instance: LXDInstance(name=enjoyed-lioness)
2021-05-14 21:21:25 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init --version'
cloud-init version: /usr/bin/cloud-init 21.1-19-gbad84ad4-0ubuntu1~20.04.2
2021-05-14 21:21:25 INFO      integration_testing:clouds.py:179 cloud-init version: /usr/bin/cloud-init 21.1-19-gbad84ad4-0ubuntu1~20.04.2
2021-05-14 21:21:25 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'grep serial /etc/cloud/build.info'
image serial: 20210510
2021-05-14 21:21:25 INFO      integration_testing:clouds.py:183 image serial: 20210510
Installing proposed image
2021-05-14 21:21:25 INFO      integration_testing:instances.py:144 Installing proposed image
2021-05-14 21:21:25 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'echo deb "http://archive.ubuntu.com/ubuntu $(lsb_release -sc)-proposed main" | tee /etc/apt/sources.list.d/proposed.list
apt-get update -q
apt-get install -qy cloud-init'
2021-05-14 21:21:46 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init -v'
Installed cloud-init version: 21.2-3-g899bfaa9-0ubuntu2~20.04.1
2021-05-14 21:21:47 INFO      integration_testing:instances.py:136 Installed cloud-init version: 21.2-3-g899bfaa9-0ubuntu2~20.04.1
2021-05-14 21:21:47 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 21:21:47 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
2021-05-14 21:21:47 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 21:21:47 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
2021-05-14 21:21:47 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 21:21:48 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
Created new image: local:enjoyed-lioness-snapshot
2021-05-14 21:23:19 INFO      integration_testing:instances.py:113 Created new image: local:enjoyed-lioness-snapshot
Done with environment setup
2021-05-14 21:23:19 INFO      integration_testing:conftest.py:162 Done with environment setup
Launching instance with launch_kwargs:
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

image_id=local:enjoyed-lioness-snapshot
2021-05-14 21:23:19 INFO      integration_testing:clouds.py:168 Launching instance with launch_kwargs:
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

image_id=local:enjoyed-lioness-snapshot
['lxc', 'init', 'local:enjoyed-lioness-snapshot', '--profile', 'pycloudlib-vm-focal-v2', '--config', 'user.meta-data=public-keys: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJMS8gdKw0kA1PDwAVkURrxgjbAgWVeiBq+VSOI1jFLafONDwkc0ZVriZofmCZ1BVjixCA6kqVQsmA88Av7eeI3jGvy4fwX+TKhDQk28rRC9mNz8nBLfB+gp3wfcgFJrVeekhjV+fgxiyq1wJC4WcJZfXKdXvsNTBzhd2RNZAsyKyRKBRahv57/KJjXozS94p83l0qq/gi6pYYBTTkLz65SiyVCUpkddgXDPfxEXqjsx6ha3VCdoKBdRgh3p2toADzcYafyqxDMPtfLJE+BofSA4Gi9YQAMhshdk4tzI+KYcq07cd8AtreXpVyZLC3r7cfe4m2IK7UvVSbTItYoUItN255P1M09eLQNlbbrJwnxuX3IUwxBkYZhVUIaEOQreWTnc+tg20ZK3olUzNWcJBurpeT5i6Hg/QoRrQSanVLFx8hff4l1V9Yxb23txlv9e2Pzh0i/0YVmrVlQxuen/5YyWNm553D1EfH8fEon3xVAqrbC8NS63GaP0QhGo7rlYs= james@newt\n', '--config', 'user.user-data=#cloud-config\ndisk_setup:\n  /dev/sdb:\n    table_type: mbr\n    layout: [50, 50]\n    overwrite: True\nfs_setup:\n  - label: test\n    device: /dev/sdb1\n    filesystem: ext4\n  - label: test2\n    device: /dev/sdb2\n    filesystem: ext4\nmounts:\n- ["/dev/sdb1", "/mnt1"]\n- ["/dev/sdb2", "/mnt2"]\n', '--vm']
Running callback specified by 'lxd_setup' mark
2021-05-14 21:24:27 INFO      integration_testing:clouds.py:314 Running callback specified by 'lxd_setup' mark
2021-05-14 21:24:28 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:24:48 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.18
Retrying SSH connection to ubuntu@10.37.179.18:22 (579s left)
2021-05-14 21:24:49 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.18
Retrying SSH connection to ubuntu@10.37.179.18:22 (578s left)
2021-05-14 21:24:51 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.18
Retrying SSH connection to ubuntu@10.37.179.18:22 (576s left)
2021-05-14 21:24:52 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.2p1)
2021-05-14 21:24:52 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:24:53 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
Launched instance: LXDInstance(name=amused-grouper)
2021-05-14 21:24:57 INFO      integration_testing:clouds.py:173 Launched instance: LXDInstance(name=amused-grouper)
2021-05-14 21:24:57 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init --version'
cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~20.04.1
2021-05-14 21:24:57 INFO      integration_testing:clouds.py:179 cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~20.04.1
2021-05-14 21:24:57 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'grep serial /etc/cloud/build.info'
image serial: 20210510
2021-05-14 21:24:57 INFO      integration_testing:clouds.py:183 image serial: 20210510
-------------------------------- live log call ---------------------------------
2021-05-14 21:24:57 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cat /var/log/cloud-init.log'
2021-05-14 21:24:57 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'lsblk --json'
2021-05-14 21:24:57 INFO      paramiko.transport.sftp:sftp.py:158 [chan 6] Opened sftp connection (server version 3)
2021-05-14 21:24:57 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'mv /var/tmp/f8970756-aed9-485f-8703-d7e027fb4a4c.tmp /var/lib/cloud/seed/nocloud-net/user-data'
2021-05-14 21:24:57 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'sed -i '"'"'s/write-files/write-files\n - mounts/'"'"' /etc/cloud/cloud.cfg'
2021-05-14 21:24:57 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init clean --logs'
Restarting instance and waiting for boot
2021-05-14 21:24:57 INFO      integration_testing:instances.py:65 Restarting instance and waiting for boot
2021-05-14 21:24:59 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:25:14 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.2p1)
2021-05-14 21:25:14 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:25:15 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
2021-05-14 21:25:18 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'lsblk --json'
PASSED
------------------------------ live log teardown -------------------------------
2021-05-14 21:25:18 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init collect-logs -u -t /var/tmp/cloud-init.tar.gz'
Writing logs to /tmp/cloud_init_test_logs/210514162038/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_when_mounted
2021-05-14 21:25:19 INFO      integration_testing:conftest.py:192 Writing logs to /tmp/cloud_init_test_logs/210514162038/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_when_mounted
2021-05-14 21:25:19 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'cp /var/tmp/cloud-init.tar.gz /var/tmp/da9d503c-076f-49ea-a163-8a02abfdfb3b.tmp'
2021-05-14 21:25:19 INFO      paramiko.transport.sftp:sftp.py:158 [chan 5] Opened sftp connection (server version 3)

tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_no_partprobe Detected image: image_id=focal os=ubuntu release=focal

-------------------------------- live log setup --------------------------------
2021-05-14 21:25:19 INFO      integration_testing:clouds.py:88 Detected image: image_id=focal os=ubuntu release=focal
Launching instance with launch_kwargs:
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

image_id=local:enjoyed-lioness-snapshot
2021-05-14 21:25:19 INFO      integration_testing:clouds.py:168 Launching instance with launch_kwargs:
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

image_id=local:enjoyed-lioness-snapshot
['lxc', 'init', 'local:enjoyed-lioness-snapshot', '--profile', 'pycloudlib-vm-focal-v2', '--config', 'user.meta-data=public-keys: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJMS8gdKw0kA1PDwAVkURrxgjbAgWVeiBq+VSOI1jFLafONDwkc0ZVriZofmCZ1BVjixCA6kqVQsmA88Av7eeI3jGvy4fwX+TKhDQk28rRC9mNz8nBLfB+gp3wfcgFJrVeekhjV+fgxiyq1wJC4WcJZfXKdXvsNTBzhd2RNZAsyKyRKBRahv57/KJjXozS94p83l0qq/gi6pYYBTTkLz65SiyVCUpkddgXDPfxEXqjsx6ha3VCdoKBdRgh3p2toADzcYafyqxDMPtfLJE+BofSA4Gi9YQAMhshdk4tzI+KYcq07cd8AtreXpVyZLC3r7cfe4m2IK7UvVSbTItYoUItN255P1M09eLQNlbbrJwnxuX3IUwxBkYZhVUIaEOQreWTnc+tg20ZK3olUzNWcJBurpeT5i6Hg/QoRrQSanVLFx8hff4l1V9Yxb23txlv9e2Pzh0i/0YVmrVlQxuen/5YyWNm553D1EfH8fEon3xVAqrbC8NS63GaP0QhGo7rlYs= james@newt\n', '--config', 'user.user-data=#cloud-config\ndisk_setup:\n  /dev/sdb:\n    table_type: mbr\n    layout: [50, 50]\n    overwrite: True\nfs_setup:\n  - label: test\n    device: /dev/sdb1\n    filesystem: ext4\n  - label: test2\n    device: /dev/sdb2\n    filesystem: ext4\nmounts:\n- ["/dev/sdb1", "/mnt1"]\n- ["/dev/sdb2", "/mnt2"]\n', '--vm']
Running callback specified by 'lxd_setup' mark
2021-05-14 21:25:19 INFO      integration_testing:clouds.py:314 Running callback specified by 'lxd_setup' mark
2021-05-14 21:25:20 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:25:39 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.134
Retrying SSH connection to ubuntu@10.37.179.134:22 (581s left)
2021-05-14 21:25:40 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.134
Retrying SSH connection to ubuntu@10.37.179.134:22 (579s left)
2021-05-14 21:25:41 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.134
Retrying SSH connection to ubuntu@10.37.179.134:22 (578s left)
2021-05-14 21:25:43 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.2p1)
2021-05-14 21:25:43 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:25:45 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
Launched instance: LXDInstance(name=uncommon-krill)
2021-05-14 21:25:47 INFO      integration_testing:clouds.py:173 Launched instance: LXDInstance(name=uncommon-krill)
2021-05-14 21:25:47 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init --version'
cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~20.04.1
2021-05-14 21:25:47 INFO      integration_testing:clouds.py:179 cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~20.04.1
2021-05-14 21:25:47 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'grep serial /etc/cloud/build.info'
image serial: 20210510
2021-05-14 21:25:47 INFO      integration_testing:clouds.py:183 image serial: 20210510
-------------------------------- live log call ---------------------------------
2021-05-14 21:25:47 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'rm $(which partprobe)'
2021-05-14 21:25:47 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init clean --logs'
Restarting instance and waiting for boot
2021-05-14 21:25:47 INFO      integration_testing:instances.py:65 Restarting instance and waiting for boot
2021-05-14 21:25:49 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:26:05 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.2p1)
2021-05-14 21:26:05 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:26:05 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
2021-05-14 21:26:07 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cat /var/log/cloud-init.log'
2021-05-14 21:26:07 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'lsblk --json'
PASSED
------------------------------ live log teardown -------------------------------
2021-05-14 21:26:08 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init collect-logs -u -t /var/tmp/cloud-init.tar.gz'
Writing logs to /tmp/cloud_init_test_logs/210514162038/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_no_partprobe
2021-05-14 21:26:08 INFO      integration_testing:conftest.py:192 Writing logs to /tmp/cloud_init_test_logs/210514162038/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_no_partprobe
2021-05-14 21:26:08 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'cp /var/tmp/cloud-init.tar.gz /var/tmp/dcace861-52cb-4488-89b1-18f3e2b9fa16.tmp'
2021-05-14 21:26:08 INFO      paramiko.transport.sftp:sftp.py:158 [chan 6] Opened sftp connection (server version 3)
Deleting snapshot image created for this testrun: local:enjoyed-lioness-snapshot
2021-05-14 21:26:09 INFO      integration_testing:clouds.py:204 Deleting snapshot image created for this testrun: local:enjoyed-lioness-snapshot


=============================== warnings summary ===============================
../envs/cloud-init/lib/python3.5/site-packages/jwt/utils.py:8
  /home/james/envs/cloud-init/lib/python3.5/site-packages/jwt/utils.py:8: CryptographyDeprecationWarning: Python 3.5 support will be dropped in the next release of cryptography. Please upgrade your Python.
    from cryptography.hazmat.primitives.asymmetric.utils import (

tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_when_mounted
  /home/james/envs/cloud-init/lib/python3.5/site-packages/simplestreams/mirrors/__init__.py:207: DeprecationWarning: The 'warn' method is deprecated, use 'warning' instead
    self.prefix, path)

-- Docs: https://docs.pytest.org/en/stable/warnings.html
================== 2 passed, 2 warnings in 331.20s (0:05:31) ===================


=== Groovy ===
============================= test session starts ==============================
platform linux -- Python 3.5.10, pytest-6.1.2, py-1.10.0, pluggy-0.13.1
rootdir: /home/james/cloud-init-tests, configfile: tox.ini
plugins: cov-2.11.1
collected 2 items

tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_when_mounted Detected image: image_id=groovy os=ubuntu release=groovy

-------------------------------- live log setup --------------------------------
2021-05-14 21:39:37 INFO      integration_testing:clouds.py:88 Detected image: image_id=groovy os=ubuntu release=groovy
Detected image: image_id=groovy os=ubuntu release=groovy
2021-05-14 21:39:37 INFO      integration_testing:clouds.py:88 Detected image: image_id=groovy os=ubuntu release=groovy
Settings:
CLOUD_INIT_SOURCE=PROPOSED
COLLECT_LOGS=ALWAYS
EXISTING_INSTANCE_ID=None
INSTANCE_TYPE=None
KEEP_IMAGE=False
KEEP_INSTANCE=False
KEYPAIR_NAME=None
LOCAL_LOG_PATH=/tmp/cloud_init_test_logs
OPENSTACK_NETWORK=falcojr_admin_net
OS_IMAGE=groovy
PLATFORM=lxd_vm
PUBLIC_SSH_KEY=None
RUN_UNSTABLE=False
2021-05-14 21:39:43 INFO      integration_testing:clouds.py:129 Settings:
CLOUD_INIT_SOURCE=PROPOSED
COLLECT_LOGS=ALWAYS
EXISTING_INSTANCE_ID=None
INSTANCE_TYPE=None
KEEP_IMAGE=False
KEEP_INSTANCE=False
KEYPAIR_NAME=None
LOCAL_LOG_PATH=/tmp/cloud_init_test_logs
OPENSTACK_NETWORK=falcojr_admin_net
OS_IMAGE=groovy
PLATFORM=lxd_vm
PUBLIC_SSH_KEY=None
RUN_UNSTABLE=False
Setting up environment for lxd_vm
2021-05-14 21:39:43 INFO      integration_testing:conftest.py:156 Setting up environment for lxd_vm
Launching instance with launch_kwargs:
image_id=ubuntu:982a39044cfe9c5372e65bb762453f2a34b339e26cef3d817b59f46c6e55c2b0
user_data=None
2021-05-14 21:39:43 INFO      integration_testing:clouds.py:168 Launching instance with launch_kwargs:
image_id=ubuntu:982a39044cfe9c5372e65bb762453f2a34b339e26cef3d817b59f46c6e55c2b0
user_data=None
The profile named pycloudlib-vm-groovy-v2 already exists
['lxc', 'init', 'ubuntu:982a39044cfe9c5372e65bb762453f2a34b339e26cef3d817b59f46c6e55c2b0', '--profile', 'pycloudlib-vm-groovy-v2', '--config', 'user.meta-data=public-keys: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJMS8gdKw0kA1PDwAVkURrxgjbAgWVeiBq+VSOI1jFLafONDwkc0ZVriZofmCZ1BVjixCA6kqVQsmA88Av7eeI3jGvy4fwX+TKhDQk28rRC9mNz8nBLfB+gp3wfcgFJrVeekhjV+fgxiyq1wJC4WcJZfXKdXvsNTBzhd2RNZAsyKyRKBRahv57/KJjXozS94p83l0qq/gi6pYYBTTkLz65SiyVCUpkddgXDPfxEXqjsx6ha3VCdoKBdRgh3p2toADzcYafyqxDMPtfLJE+BofSA4Gi9YQAMhshdk4tzI+KYcq07cd8AtreXpVyZLC3r7cfe4m2IK7UvVSbTItYoUItN255P1M09eLQNlbbrJwnxuX3IUwxBkYZhVUIaEOQreWTnc+tg20ZK3olUzNWcJBurpeT5i6Hg/QoRrQSanVLFx8hff4l1V9Yxb23txlv9e2Pzh0i/0YVmrVlQxuen/5YyWNm553D1EfH8fEon3xVAqrbC8NS63GaP0QhGo7rlYs= james@newt\n', '--vm']
2021-05-14 21:39:46 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:40:07 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.8
Retrying SSH connection to ubuntu@10.37.179.8:22 (578s left)
2021-05-14 21:40:08 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.8
Retrying SSH connection to ubuntu@10.37.179.8:22 (577s left)
2021-05-14 21:40:10 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.8
Retrying SSH connection to ubuntu@10.37.179.8:22 (576s left)
2021-05-14 21:40:11 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.3p1)
2021-05-14 21:40:11 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:40:13 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
Launched instance: LXDInstance(name=wealthy-cowbird)
2021-05-14 21:40:18 INFO      integration_testing:clouds.py:173 Launched instance: LXDInstance(name=wealthy-cowbird)
2021-05-14 21:40:18 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init --version'
cloud-init version: /usr/bin/cloud-init 21.1-19-gbad84ad4-0ubuntu1~20.10.2
2021-05-14 21:40:18 INFO      integration_testing:clouds.py:179 cloud-init version: /usr/bin/cloud-init 21.1-19-gbad84ad4-0ubuntu1~20.10.2
2021-05-14 21:40:18 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'grep serial /etc/cloud/build.info'
image serial: 20210511.1
2021-05-14 21:40:18 INFO      integration_testing:clouds.py:183 image serial: 20210511.1
Installing proposed image
2021-05-14 21:40:18 INFO      integration_testing:instances.py:144 Installing proposed image
2021-05-14 21:40:18 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'echo deb "http://archive.ubuntu.com/ubuntu $(lsb_release -sc)-proposed main" | tee /etc/apt/sources.list.d/proposed.list
apt-get update -q
apt-get install -qy cloud-init'
2021-05-14 21:40:33 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init -v'
Installed cloud-init version: 21.2-3-g899bfaa9-0ubuntu2~20.10.1
2021-05-14 21:40:33 INFO      integration_testing:instances.py:136 Installed cloud-init version: 21.2-3-g899bfaa9-0ubuntu2~20.10.1
2021-05-14 21:40:33 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 21:40:33 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
2021-05-14 21:40:33 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 21:40:34 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
2021-05-14 21:40:34 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo cloud-init clean --logs'
2021-05-14 21:40:34 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'sudo rm -rf /var/log/syslog'
Created new image: local:wealthy-cowbird-snapshot
2021-05-14 21:41:59 INFO      integration_testing:instances.py:113 Created new image: local:wealthy-cowbird-snapshot
Done with environment setup
2021-05-14 21:42:00 INFO      integration_testing:conftest.py:162 Done with environment setup
Launching instance with launch_kwargs:
image_id=local:wealthy-cowbird-snapshot
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

2021-05-14 21:42:00 INFO      integration_testing:clouds.py:168 Launching instance with launch_kwargs:
image_id=local:wealthy-cowbird-snapshot
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

['lxc', 'init', 'local:wealthy-cowbird-snapshot', '--profile', 'pycloudlib-vm-groovy-v2', '--config', 'user.meta-data=public-keys: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJMS8gdKw0kA1PDwAVkURrxgjbAgWVeiBq+VSOI1jFLafONDwkc0ZVriZofmCZ1BVjixCA6kqVQsmA88Av7eeI3jGvy4fwX+TKhDQk28rRC9mNz8nBLfB+gp3wfcgFJrVeekhjV+fgxiyq1wJC4WcJZfXKdXvsNTBzhd2RNZAsyKyRKBRahv57/KJjXozS94p83l0qq/gi6pYYBTTkLz65SiyVCUpkddgXDPfxEXqjsx6ha3VCdoKBdRgh3p2toADzcYafyqxDMPtfLJE+BofSA4Gi9YQAMhshdk4tzI+KYcq07cd8AtreXpVyZLC3r7cfe4m2IK7UvVSbTItYoUItN255P1M09eLQNlbbrJwnxuX3IUwxBkYZhVUIaEOQreWTnc+tg20ZK3olUzNWcJBurpeT5i6Hg/QoRrQSanVLFx8hff4l1V9Yxb23txlv9e2Pzh0i/0YVmrVlQxuen/5YyWNm553D1EfH8fEon3xVAqrbC8NS63GaP0QhGo7rlYs= james@newt\n', '--config', 'user.user-data=#cloud-config\ndisk_setup:\n  /dev/sdb:\n    table_type: mbr\n    layout: [50, 50]\n    overwrite: True\nfs_setup:\n  - label: test\n    device: /dev/sdb1\n    filesystem: ext4\n  - label: test2\n    device: /dev/sdb2\n    filesystem: ext4\nmounts:\n- ["/dev/sdb1", "/mnt1"]\n- ["/dev/sdb2", "/mnt2"]\n', '--vm']
Running callback specified by 'lxd_setup' mark
2021-05-14 21:43:02 INFO      integration_testing:clouds.py:314 Running callback specified by 'lxd_setup' mark
2021-05-14 21:43:03 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:43:23 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.64
Retrying SSH connection to ubuntu@10.37.179.64:22 (580s left)
2021-05-14 21:43:24 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.64
Retrying SSH connection to ubuntu@10.37.179.64:22 (578s left)
2021-05-14 21:43:26 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.64
Retrying SSH connection to ubuntu@10.37.179.64:22 (577s left)
2021-05-14 21:43:28 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.64
Retrying SSH connection to ubuntu@10.37.179.64:22 (575s left)
2021-05-14 21:43:29 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.3p1)
2021-05-14 21:43:29 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:43:30 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
Launched instance: LXDInstance(name=related-zebra)
2021-05-14 21:43:31 INFO      integration_testing:clouds.py:173 Launched instance: LXDInstance(name=related-zebra)
2021-05-14 21:43:31 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init --version'
cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~20.10.1
2021-05-14 21:43:32 INFO      integration_testing:clouds.py:179 cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~20.10.1
2021-05-14 21:43:32 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'grep serial /etc/cloud/build.info'
image serial: 20210511.1
2021-05-14 21:43:32 INFO      integration_testing:clouds.py:183 image serial: 20210511.1
-------------------------------- live log call ---------------------------------
2021-05-14 21:43:32 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cat /var/log/cloud-init.log'
2021-05-14 21:43:32 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'lsblk --json'
2021-05-14 21:43:32 INFO      paramiko.transport.sftp:sftp.py:158 [chan 6] Opened sftp connection (server version 3)
2021-05-14 21:43:32 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'mv /var/tmp/3c9638ee-123c-4f6b-9b8d-bc3ebf058886.tmp /var/lib/cloud/seed/nocloud-net/user-data'
2021-05-14 21:43:32 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'sed -i '"'"'s/write-files/write-files\n - mounts/'"'"' /etc/cloud/cloud.cfg'
2021-05-14 21:43:32 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init clean --logs'
Restarting instance and waiting for boot
2021-05-14 21:43:32 INFO      integration_testing:instances.py:65 Restarting instance and waiting for boot
2021-05-14 21:43:34 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:43:49 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.3p1)
2021-05-14 21:43:49 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:43:50 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
2021-05-14 21:43:52 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'lsblk --json'
PASSED
------------------------------ live log teardown -------------------------------
2021-05-14 21:43:52 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init collect-logs -u -t /var/tmp/cloud-init.tar.gz'
Writing logs to /tmp/cloud_init_test_logs/210514163937/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_when_mounted
2021-05-14 21:43:52 INFO      integration_testing:conftest.py:192 Writing logs to /tmp/cloud_init_test_logs/210514163937/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_when_mounted
2021-05-14 21:43:52 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'cp /var/tmp/cloud-init.tar.gz /var/tmp/d893f46a-e17e-4ebd-896e-a709f51969ad.tmp'
2021-05-14 21:43:52 INFO      paramiko.transport.sftp:sftp.py:158 [chan 5] Opened sftp connection (server version 3)

tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_no_partprobe Detected image: image_id=groovy os=ubuntu release=groovy

-------------------------------- live log setup --------------------------------
2021-05-14 21:43:53 INFO      integration_testing:clouds.py:88 Detected image: image_id=groovy os=ubuntu release=groovy
Launching instance with launch_kwargs:
image_id=local:wealthy-cowbird-snapshot
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

2021-05-14 21:43:53 INFO      integration_testing:clouds.py:168 Launching instance with launch_kwargs:
image_id=local:wealthy-cowbird-snapshot
user_data=#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [50, 50]
    overwrite: True
fs_setup:
  - label: test
    device: /dev/sdb1
    filesystem: ext4
  - label: test2
    device: /dev/sdb2
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt1"]
- ["/dev/sdb2", "/mnt2"]

['lxc', 'init', 'local:wealthy-cowbird-snapshot', '--profile', 'pycloudlib-vm-groovy-v2', '--config', 'user.meta-data=public-keys: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJMS8gdKw0kA1PDwAVkURrxgjbAgWVeiBq+VSOI1jFLafONDwkc0ZVriZofmCZ1BVjixCA6kqVQsmA88Av7eeI3jGvy4fwX+TKhDQk28rRC9mNz8nBLfB+gp3wfcgFJrVeekhjV+fgxiyq1wJC4WcJZfXKdXvsNTBzhd2RNZAsyKyRKBRahv57/KJjXozS94p83l0qq/gi6pYYBTTkLz65SiyVCUpkddgXDPfxEXqjsx6ha3VCdoKBdRgh3p2toADzcYafyqxDMPtfLJE+BofSA4Gi9YQAMhshdk4tzI+KYcq07cd8AtreXpVyZLC3r7cfe4m2IK7UvVSbTItYoUItN255P1M09eLQNlbbrJwnxuX3IUwxBkYZhVUIaEOQreWTnc+tg20ZK3olUzNWcJBurpeT5i6Hg/QoRrQSanVLFx8hff4l1V9Yxb23txlv9e2Pzh0i/0YVmrVlQxuen/5YyWNm553D1EfH8fEon3xVAqrbC8NS63GaP0QhGo7rlYs= james@newt\n', '--config', 'user.user-data=#cloud-config\ndisk_setup:\n  /dev/sdb:\n    table_type: mbr\n    layout: [50, 50]\n    overwrite: True\nfs_setup:\n  - label: test\n    device: /dev/sdb1\n    filesystem: ext4\n  - label: test2\n    device: /dev/sdb2\n    filesystem: ext4\nmounts:\n- ["/dev/sdb1", "/mnt1"]\n- ["/dev/sdb2", "/mnt2"]\n', '--vm']
Running callback specified by 'lxd_setup' mark
2021-05-14 21:43:53 INFO      integration_testing:clouds.py:314 Running callback specified by 'lxd_setup' mark
2021-05-14 21:43:53 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:44:13 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.241
Retrying SSH connection to ubuntu@10.37.179.241:22 (580s left)
2021-05-14 21:44:15 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.241
Retrying SSH connection to ubuntu@10.37.179.241:22 (578s left)
2021-05-14 21:44:16 INFO      pycloudlib.instance:instance.py:343 [Errno None] Unable to connect to port 22 on 10.37.179.241
Retrying SSH connection to ubuntu@10.37.179.241:22 (577s left)
2021-05-14 21:44:18 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.3p1)
2021-05-14 21:44:18 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:44:19 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
Launched instance: LXDInstance(name=secure-mackerel)
2021-05-14 21:44:23 INFO      integration_testing:clouds.py:173 Launched instance: LXDInstance(name=secure-mackerel)
2021-05-14 21:44:23 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init --version'
cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~20.10.1
2021-05-14 21:44:23 INFO      integration_testing:clouds.py:179 cloud-init version: /usr/bin/cloud-init 21.2-3-g899bfaa9-0ubuntu2~20.10.1
2021-05-14 21:44:23 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'grep serial /etc/cloud/build.info'
image serial: 20210511.1
2021-05-14 21:44:23 INFO      integration_testing:clouds.py:183 image serial: 20210511.1
-------------------------------- live log call ---------------------------------
2021-05-14 21:44:23 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'rm $(which partprobe)'
2021-05-14 21:44:23 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init clean --logs'
Restarting instance and waiting for boot
2021-05-14 21:44:23 INFO      integration_testing:instances.py:65 Restarting instance and waiting for boot
2021-05-14 21:44:25 INFO      pycloudlib.instance:instance.py:165 executing: sh -c whoami
2021-05-14 21:44:40 INFO      paramiko.transport:transport.py:1819 Connected (version 2.0, client OpenSSH_8.3p1)
2021-05-14 21:44:40 INFO      paramiko.transport:transport.py:1819 Authentication (publickey) successful!
2021-05-14 21:44:41 INFO      pycloudlib.instance:instance.py:165 executing: cloud-init status --wait --long
2021-05-14 21:44:44 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cat /var/log/cloud-init.log'
2021-05-14 21:44:44 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'lsblk --json'
PASSED
------------------------------ live log teardown -------------------------------
2021-05-14 21:44:44 INFO      pycloudlib.instance:instance.py:165 executing: sudo -- sh -c 'cloud-init collect-logs -u -t /var/tmp/cloud-init.tar.gz'
Writing logs to /tmp/cloud_init_test_logs/210514163937/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_no_partprobe
2021-05-14 21:44:45 INFO      integration_testing:conftest.py:192 Writing logs to /tmp/cloud_init_test_logs/210514163937/tests/integration_tests/bugs/test_lp1920939/test_disk_setup_no_partprobe
2021-05-14 21:44:45 INFO      pycloudlib.instance:instance.py:165 executing: sh -c 'cp /var/tmp/cloud-init.tar.gz /var/tmp/d1883657-5fa2-4f3b-a135-4be271217ff5.tmp'
2021-05-14 21:44:45 INFO      paramiko.transport.sftp:sftp.py:158 [chan 6] Opened sftp connection (server version 3)
Deleting snapshot image created for this testrun: local:wealthy-cowbird-snapshot
2021-05-14 21:44:45 INFO      integration_testing:clouds.py:204 Deleting snapshot image created for this testrun: local:wealthy-cowbird-snapshot


=============================== warnings summary ===============================
../envs/cloud-init/lib/python3.5/site-packages/jwt/utils.py:8
  /home/james/envs/cloud-init/lib/python3.5/site-packages/jwt/utils.py:8: CryptographyDeprecationWarning: Python 3.5 support will be dropped in the next release of cryptography. Please upgrade your Python.
    from cryptography.hazmat.primitives.asymmetric.utils import (

tests/integration_tests/bugs/test_lp1920939.py::test_disk_setup_when_mounted
  /home/james/envs/cloud-init/lib/python3.5/site-packages/simplestreams/mirrors/__init__.py:207: DeprecationWarning: The 'warn' method is deprecated, use 'warning' instead
    self.prefix, path)

-- Docs: https://docs.pytest.org/en/stable/warnings.html
================== 2 passed, 2 warnings in 308.92s (0:05:08) ===================


=== Hirsute ===
# Part 1, Ensure partprobe can partition mounted disk
$ lxc init images:ubuntu/hirsute/cloud --vm  -c user.user-data="$(cat /home/james/my-cloud-init-yaml.yaml)" --profile pycloudlib-vm-groovy-v2 hirsute
$ dd if=/dev/zero of=/tmp/tmp_disk bs=1k count=640
$ lxc config device add hirsute test-disk-setup-disk disk source=/tmp/tmp_disk
$ lxc start hirsute
$ lxc shell hirsute

root@hirsute:~# echo deb http://archive.ubuntu.com/ubuntu hirsute-proposed main | tee /etc/apt/sources.list.d/proposed.list
deb http://archive.ubuntu.com/ubuntu hirsute-proposed main
root@hirsute:~# apt update; apt install -y cloud-init parted
Get:1 http://security.ubuntu.com/ubuntu hirsute-security InRelease [101 kB]
Hit:2 http://archive.ubuntu.com/ubuntu hirsute InRelease
Get:3 http://security.ubuntu.com/ubuntu hirsute-security/main amd64 Packages [84.5 kB]
Get:4 http://archive.ubuntu.com/ubuntu hirsute-updates InRelease [109 kB]
Get:5 http://security.ubuntu.com/ubuntu hirsute-security/main Translation-en [23.8 kB]
Get:6 http://security.ubuntu.com/ubuntu hirsute-security/universe amd64 Packages [174 kB]
Get:7 http://security.ubuntu.com/ubuntu hirsute-security/universe Translation-en [24.2 kB]
Get:8 http://archive.ubuntu.com/ubuntu hirsute-backports InRelease [90.7 kB]
Get:9 http://archive.ubuntu.com/ubuntu hirsute-proposed InRelease [269 kB]
Get:10 http://archive.ubuntu.com/ubuntu hirsute-updates/main amd64 Packages [101 kB]
Get:11 http://archive.ubuntu.com/ubuntu hirsute-updates/main Translation-en [28.9 kB]
Get:12 http://archive.ubuntu.com/ubuntu hirsute-updates/universe amd64 Packages [184 kB]
Get:13 http://archive.ubuntu.com/ubuntu hirsute-updates/universe Translation-en [27.9 kB]
Get:14 http://archive.ubuntu.com/ubuntu hirsute-proposed/main amd64 Packages [96.3 kB]
Get:15 http://archive.ubuntu.com/ubuntu hirsute-proposed/main Translation-en [25.3 kB]
Fetched 1,339 kB in 1s (988 kB/s)
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
16 packages can be upgraded. Run 'apt list --upgradable' to see them.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  dmidecode libparted2
Suggested packages:
  libparted-dev libparted-i18n parted-doc
The following NEW packages will be installed:
  dmidecode libparted2 parted
The following packages will be upgraded:
  cloud-init
1 upgraded, 3 newly installed, 0 to remove and 15 not upgraded.
Need to get 703 kB of archives.
After this operation, 884 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu hirsute/main amd64 dmidecode amd64 3.3-1build1 [60.7 kB]
Get:2 http://archive.ubuntu.com/ubuntu hirsute/main amd64 libparted2 amd64 3.4-1 [160 kB]
Get:3 http://archive.ubuntu.com/ubuntu hirsute/main amd64 parted amd64 3.4-1 [43.6 kB]
Get:4 http://archive.ubuntu.com/ubuntu hirsute-proposed/main amd64 cloud-init all 21.2-3-g899bfaa9-0ubuntu2~21.04.1 [439 kB]
Fetched 703 kB in 1s (817 kB/s)
Preconfiguring packages ...
Selecting previously unselected package dmidecode.
(Reading database ... 52216 files and directories currently installed.)
Preparing to unpack .../dmidecode_3.3-1build1_amd64.deb ...
Unpacking dmidecode (3.3-1build1) ...
Selecting previously unselected package libparted2:amd64.
Preparing to unpack .../libparted2_3.4-1_amd64.deb ...
Unpacking libparted2:amd64 (3.4-1) ...
Selecting previously unselected package parted.
Preparing to unpack .../parted_3.4-1_amd64.deb ...
Unpacking parted (3.4-1) ...
Preparing to unpack .../cloud-init_21.2-3-g899bfaa9-0ubuntu2~21.04.1_all.deb ...
Unpacking cloud-init (21.2-3-g899bfaa9-0ubuntu2~21.04.1) over (21.1-19-gbad84ad4-0ubuntu3) ...
Setting up cloud-init (21.2-3-g899bfaa9-0ubuntu2~21.04.1) ...
Installing new version of config file /etc/cloud/templates/chef_client.rb.tmpl ...
Setting up dmidecode (3.3-1build1) ...
Setting up libparted2:amd64 (3.4-1) ...
Setting up parted (3.4-1) ...
Processing triggers for rsyslog (8.2102.0-2ubuntu1) ...
Processing triggers for libc-bin (2.33-0ubuntu5) ...



root@hirsute:~# grep "Traceback" /var/log/cloud-init.log
root@hirsute:~# grep 'WARN' /var/log/cloud-init.log
root@hirsute:~# lsblk
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda      8:0    0   9.3G  0 disk
├─sda1   8:1    0   100M  0 part /boot/efi
└─sda2   8:2    0   9.2G  0 part /
sdb      8:16   0     2M  0 disk
├─sdb1   8:17   0  1000K  0 part /mnt1
└─sdb2   8:18   0 999.5K  0 part /mnt2

root@hirsute:~# vi /var/lib/cloud/seed/nocloud-net/user-data
root@hirsute:~# cat /var/lib/cloud/seed/nocloud-net/user-data
#cloud-config
disk_setup:
  /dev/sdb:
    table_type: mbr
    layout: [100]
    overwrite: True
fs_setup:
  - label: test3
    device: /dev/sdb1
    filesystem: ext4
mounts:
- ["/dev/sdb1", "/mnt3"]

root@hirsute:~# sed -i 's/write-files/write-files\n - mounts/' /etc/cloud/cloud.cfg
root@hirsute:~# head -n 45 /etc/cloud/cloud.cfg
# The top level settings are used as module
# and system configuration.

# A set of users which may be applied and/or used by various modules
# when a 'default' entry is found it will reference the 'default_user'
# from the distro configuration specified below
users:
   - default

# If this is set, 'root' will not be able to ssh in and they
# will get a message to login instead as the default $user
disable_root: true

# This will cause the set+update hostname module to not operate (if true)
preserve_hostname: false

# Example datasource config
# datasource:
#    Ec2:
#      metadata_urls: [ 'blah.com' ]
#      timeout: 5 # (defaults to 50 seconds)
#      max_wait: 10 # (defaults to 120 seconds)



# The modules that run in the 'init' stage
cloud_init_modules:
 - migrator
 - seed_random
 - bootcmd
 - write-files
 - mounts
 - growpart
 - resizefs
 - disk_setup
 - mounts
 - set_hostname
 - update_hostname
 - update_etc_hosts
 - ca-certs
 - rsyslog
 - users-groups
 - ssh

# The modules that run in the 'config' stage
root@hirsute:~# cloud-init clean --logs --reboot

Session terminated, killing shell... ...killed.

$ lxc shell hirsute
root@hirsute:~# grep 'Traceback' /var/log/cloud-init.log
root@hirsute:~# grep 'WARN' /var/log/cloud-init.log
root@hirsute:~# lsblk
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda      8:0    0   9.3G  0 disk
├─sda1   8:1    0   100M  0 part /boot/efi
└─sda2   8:2    0   9.2G  0 part /
sdb      8:16   0   640K  0 disk
└─sdb1   8:17   0 639.5K  0 part /mnt3



# Part 2, Ensure disk setup works without partprobe
# Part 1, Ensure partprobe can partition mounted disk
$ lxc init images:ubuntu/hirsute/cloud --vm  -c user.user-data="$(cat /home/james/my-cloud-init-yaml.yaml)" --profile pycloudlib-vm-groovy-v2 hirsute
$ dd if=/dev/zero of=/tmp/tmp_disk bs=1k count=640
$ lxc config device add hirsute test-disk-setup-disk disk source=/tmp/tmp_disk
$ lxc start hirsute
$ lxc shell hirsute

root@hirsute:~# echo deb http://archive.ubuntu.com/ubuntu hirsute-proposed main | tee /etc/apt/sources.list.d/proposed.list
deb http://archive.ubuntu.com/ubuntu hirsute-proposed main
root@hirsute:~# apt update; apt install -y cloud-init
root@hirsute:~# apt update; apt install -y cloud-init
Get:1 http://security.ubuntu.com/ubuntu hirsute-security InRelease [101 kB]
Hit:2 http://archive.ubuntu.com/ubuntu hirsute InRelease
Get:3 http://security.ubuntu.com/ubuntu hirsute-security/main amd64 Packages [84.5 kB]
Get:4 http://archive.ubuntu.com/ubuntu hirsute-updates InRelease [109 kB]
Get:5 http://security.ubuntu.com/ubuntu hirsute-security/main Translation-en [23.8 kB]
Get:6 http://security.ubuntu.com/ubuntu hirsute-security/universe amd64 Packages [174 kB]
Get:7 http://security.ubuntu.com/ubuntu hirsute-security/universe Translation-en [24.2 kB]
Get:8 http://archive.ubuntu.com/ubuntu hirsute-backports InRelease [90.7 kB]
Get:9 http://archive.ubuntu.com/ubuntu hirsute-proposed InRelease [269 kB]
Get:10 http://archive.ubuntu.com/ubuntu hirsute-updates/main amd64 Packages [101 kB]
Get:11 http://archive.ubuntu.com/ubuntu hirsute-updates/main Translation-en [28.9 kB]
Get:12 http://archive.ubuntu.com/ubuntu hirsute-updates/universe amd64 Packages [184 kB]
Get:13 http://archive.ubuntu.com/ubuntu hirsute-updates/universe Translation-en [27.9 kB]
Get:14 http://archive.ubuntu.com/ubuntu hirsute-proposed/main amd64 Packages [96.3 kB]
Get:15 http://archive.ubuntu.com/ubuntu hirsute-proposed/main Translation-en [25.3 kB]
Fetched 1,339 kB in 1s (986 kB/s)
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
16 packages can be upgraded. Run 'apt list --upgradable' to see them.
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following packages will be upgraded:
  cloud-init
1 upgraded, 0 newly installed, 0 to remove and 15 not upgraded.
Need to get 439 kB of archives.
After this operation, 19.5 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu hirsute-proposed/main amd64 cloud-init all 21.2-3-g899bfaa9-0ubuntu2~21.04.1 [439 kB]
Fetched 439 kB in 1s (606 kB/s)
Preconfiguring packages ...
(Reading database ... 52216 files and directories currently installed.)
Preparing to unpack .../cloud-init_21.2-3-g899bfaa9-0ubuntu2~21.04.1_all.deb ...
Unpacking cloud-init (21.2-3-g899bfaa9-0ubuntu2~21.04.1) over (21.1-19-gbad84ad4-0ubuntu3) ...
Setting up cloud-init (21.2-3-g899bfaa9-0ubuntu2~21.04.1) ...
Installing new version of config file /etc/cloud/templates/chef_client.rb.tmpl ...
Processing triggers for rsyslog (8.2102.0-2ubuntu1) ...
root@hirsute:~# cloud-init clean --logs --reboot
root@hirsute:~# Error: websocket: close 1006 (abnormal closure): unexpected EOF
$ lxc shell hirsute
root@hirsute:~# which partprobe
root@hirsute:~# grep 'Traceback' /var/log/cloud-init.log
root@hirsute:~# grep 'WARN' /var/log/cloud-init.log
root@hirsute:~# lsblk
NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda      8:0    0   9.3G  0 disk
├─sda1   8:1    0   100M  0 part /boot/efi
└─sda2   8:2    0   9.2G  0 part /
sdb      8:16   0   640K  0 disk
├─sdb1   8:17   0   320K  0 part /mnt1
└─sdb2   8:18   0 319.5K  0 part /mnt2


[Regression Potential]
We fallback to blkdev if partprobe is unavailable, but a bug in implementation
could lead to partition tables being read incorrectly.
